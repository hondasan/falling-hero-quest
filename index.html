<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>å‹‡è€…ãŒå‹æ‰‹ã«è»¢ã¶å†’é™º</title>
  <style>
    :root{
      --bg0:#050714;
      --bg1:#0c1533;
      --text: rgba(255,255,255,.94);
      --muted: rgba(255,255,255,.72);
      --r:20px;
      --shadow: 0 20px 48px rgba(0,0,0,.38);
      --accent:#7cf7c2;
      --accent-2:#7cc9ff;
      --accent-3:#ffcf7c;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html,body{height:100%; margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Meiryo", sans-serif; background: radial-gradient(1100px 760px at 16% -6%, #1a2e76 0%, var(--bg1) 52%, var(--bg0) 100%); color:var(--text);}

    .wrap{min-height:100%; display:flex; flex-direction:column; padding: max(14px, env(safe-area-inset-top)) 14px max(14px, env(safe-area-inset-bottom)); gap:14px; align-items:center;}
    .topbar{width:min(920px, 100%); display:flex; gap:10px; align-items:stretch;}

    .card{background: linear-gradient(180deg, rgba(17,34,98,.82), rgba(6,16,54,.86)); border: 1px solid rgba(255,255,255,.14); border-radius: var(--r); box-shadow: var(--shadow), inset 0 0 0 2px rgba(255,255,255,.05); position:relative; overflow:hidden;}
    .card::after{content:""; position:absolute; inset:0; background: radial-gradient(120% 120% at 14% 10%, rgba(255,255,255,.08), transparent 45%); pointer-events:none;}
    .brand{flex:1; padding: 14px 16px; display:flex; flex-direction:column; justify-content:center; gap:8px;}
    .brand .title{font-weight:800; letter-spacing:.6px; font-size:15px; color: rgba(255,255,255,.96)}
    .brand .sub{font-size:12.5px; color: var(--muted); line-height:1.55;}

    .stats{padding: 12px 16px; min-width: 380px; display:flex; gap:14px; align-items:center; justify-content:space-between;}
    .stat{display:flex; flex-direction:column; gap:4px; padding:6px 10px; border-radius:12px; background: linear-gradient(90deg, rgba(255,255,255,.04), rgba(255,255,255,.06)); box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);}
    .stat .k{font-size:12px; letter-spacing:.3px; color: var(--muted)}
    .stat .v{font-size:15px; font-variant-numeric: tabular-nums; letter-spacing:.4px; color:#fff;}

    .stage{width:min(960px, 100%); display:grid; grid-template-columns: 1fr; gap:12px;}
    .canvasWrap{position:relative; padding:12px;}

    /* ãƒ—ãƒ¬ã‚¤ç”»é¢ã‚’æ‹¡å¤§ï¼†ã‚·ãƒ£ãƒ¼ãƒ—ã« */
    canvas{width:100%; aspect-ratio: 16 / 9; height:auto; max-height:78vh; display:block; border-radius: calc(var(--r) - 6px); background: radial-gradient(120% 160% at 50% 0%, #0f1e57 0%, #081231 60%, #050815 100%); border:1px solid rgba(255,255,255,.12); box-shadow: inset 0 0 0 1px rgba(255,255,255,.05), 0 22px 46px rgba(0,0,0,.38); image-rendering: crisp-edges;}

    .controls{width:min(960px, 100%); display:flex; gap:10px; align-items:stretch; justify-content:space-between;}
    .btn{flex: 1; border: 1px solid rgba(255,255,255,.18); background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.07)); color: rgba(255,255,255,.94); border-radius: 16px; padding: 15px 16px; font-size: 15px; font-weight: 800; letter-spacing: .4px; box-shadow: 0 18px 40px rgba(0,0,0,.30); cursor:pointer; user-select:none; touch-action: manipulation; display:flex; align-items:center; justify-content:center; gap:10px; text-shadow: 0 2px 8px rgba(0,0,0,.35); transition: transform .08s ease, box-shadow .12s ease;}
    .btn:active{transform: translateY(1px); box-shadow: 0 12px 24px rgba(0,0,0,.26);}
    .btn.primary{border-color: rgba(124,247,194,.55); background: linear-gradient(180deg, rgba(124,247,194,.38), rgba(30,64,92,.65));}
    .btn.primary .spark{width:12px; height:12px; border-radius:999px; background: rgba(124,247,194,0.98); box-shadow: 0 0 18px rgba(124,247,194,.75)}

    .toggle{flex: 0.9; display:flex; gap:10px; padding: 12px 14px; align-items:center; justify-content:space-between;}
    .toggle .label{display:flex; flex-direction:column; gap:4px;}
    .toggle .label .t{font-size:13px; font-weight:800; letter-spacing:.3px;}
    .toggle .label .d{font-size:11.5px; color: var(--muted); line-height:1.45;}
    .switch{width:52px; height:30px; border-radius:999px; background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.08)); border: 1px solid rgba(255,255,255,.18); position:relative; cursor:pointer; user-select:none; touch-action: manipulation; box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);}
    .knob{width:24px; height:24px; border-radius:999px; position:absolute; top:50%; transform: translateY(-50%); left:4px; background: rgba(255,255,255,.90); box-shadow: 0 12px 22px rgba(0,0,0,.28); transition: left .18s ease, background .18s ease, box-shadow .18s ease;}
    .switch.on{background: linear-gradient(180deg, rgba(124,247,194,.30), rgba(124,247,194,.12)); border-color: rgba(124,247,194,.40)}
    .switch.on .knob{left: 24px; background: rgba(124,247,194,.98); box-shadow: 0 14px 24px rgba(124,247,194,.35);}

    .resultBar{width:min(960px, 100%); display:flex; gap:10px; align-items:stretch;}
    .btn.small{padding: 12px 14px; font-size: 14px; flex: 1;}

    .note{width:min(960px, 100%); padding: 12px 14px; font-size: 12.5px; color: var(--muted); line-height: 1.7; background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));}
    .kbd{font-variant-numeric: tabular-nums; padding: 2px 6px; border:1px solid rgba(255,255,255,.14); border-bottom-color: rgba(255,255,255,.08); border-radius: 8px; background: rgba(255,255,255,.06);}

    @media (max-width: 560px){
      .stats{min-width: 0;}
      .controls{flex-direction:column;}
      .resultBar{flex-direction:column;}
      .btn,.toggle{flex:1;}
      .stat{width:100%;}
      .brand .sub{font-size:12px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="card brand">
        <div class="title">å‹‡è€…ãŒå‹æ‰‹ã«è»¢ã¶å†’é™º</div>
        <div class="sub">RPGã£ã½ãè‰²ã€…èµ·ãã¾ã™ï¼ˆã‚¹ã‚³ã‚¢ã¯è·é›¢ã®ã¿ï¼‰ã€‚ãƒ¬ãƒ™ãƒ«/HP/MP/ç§°å·/ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã€‚</div>
      </div>
      <div class="card stats" aria-label="stats">
        <div class="stat"><div class="k">ä»Šå›</div><div class="v" id="cur">0.0 m</div></div>
        <div class="stat"><div class="k">æœ¬æ—¥ãƒ™ã‚¹ãƒˆ</div><div class="v" id="daily">0.0 m</div></div>
        <div class="stat"><div class="k">é€šç®—ãƒ™ã‚¹ãƒˆ</div><div class="v" id="best">0.0 m</div></div>
        <div class="stat"><div class="k">è¨ä¼</div><div class="v" id="kills">0</div></div>
      </div>
    </div>

    <div class="stage">
      <div class="card canvasWrap">
        <!-- å†…éƒ¨è§£åƒåº¦ã‚’å°‘ã—ä¸Šã’ã¦ã‚·ãƒ£ãƒ¼ãƒ—ã«ï¼ˆCSSã§æ‹¡å¤§ï¼‰ -->
        <canvas id="cv" width="1600" height="900" aria-label="game canvas"></canvas>
      </div>

      <div class="controls">
        <button class="btn primary" id="btnStart"><span class="spark"></span><span id="btnText">å†’é™ºã‚’ã¯ã˜ã‚ã‚‹</span></button>
        <div class="card toggle" role="group" aria-label="settings">
          <div class="label"><div class="t">SE</div><div class="d">ãƒ¬ãƒˆãƒ­åŠ¹æœéŸ³</div></div>
          <div class="switch on" id="swSound" aria-label="toggle sound"><div class="knob"></div></div>
        </div>
        <div class="card toggle" role="group" aria-label="settings">
          <div class="label"><div class="t">æŒ¯å‹•</div><div class="d">å¯¾å¿œç«¯æœ«ã®ã¿</div></div>
          <div class="switch" id="swVibe" aria-label="toggle vibration"><div class="knob"></div></div>
        </div>
      </div>

      <div class="resultBar">
        <button class="btn small" id="btnShare">å…±æœ‰</button>
        <button class="btn small" id="btnCopy">çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>

      <div class="card note">
        ãƒ»ã‚¹ã‚³ã‚¢ï¼šè·é›¢ã®ã¿ï¼ˆé‹ã‚²ãƒ¼ï¼‰ã€‚æˆ¦é—˜/è£…å‚™/ãƒ¬ãƒ™ãƒ«/HP/MP/ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯/å®ç®±ã¯ã‚¹ã‚³ã‚¢ç„¡é–¢ä¿‚ã€‚<br>
        ãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šç«¯æœ«å†…ï¼ˆLocalStorageï¼‰ã« Top10 ã‚’ä¿å­˜ã—ã¾ã™ã€‚<br>
        ãƒ»èª¿æ•´ï¼š<span class="kbd">FALL_RATE</span> / <span class="kbd">BASE_SPEED</span> / <span class="kbd">ENCOUNTER_MIN/MAX</span> / <span class="kbd">LANDMARK_MIN/MAX</span>ã€‚
      </div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  // ==============================
  // èª¿æ•´ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
  // ==============================
  const BASE_SPEED = 8.4;
  const SPEED_RAMP = 0.018;
  const FALL_RATE  = 0.0108;
  const BUMPINESS  = 0.98;
  const CAMERA_LAG = 0.09;
  const GRAVITY    = 34.0;
  const FALL_SHOW_SEC = 0.85;

  const ENCOUNTER_MIN = 520;
  const ENCOUNTER_MAX = 920;
  const ITEM_MIN = 460;
  const ITEM_MAX = 860;
  const LANDMARK_MIN = 820;
  const LANDMARK_MAX = 1500;

  const RARE_ENEMY_RATE = 0.08;  // é­é‡ã®ä¸€éƒ¨ãŒãƒ¬ã‚¢æ•µ
  const RARE_CHEST_RATE = 0.10;  // å®ç®±ã®ä¸€éƒ¨ãŒãƒ¬ã‚¢ç®±

  // ãƒœã‚¹ï¼ˆã‚¹ã‚³ã‚¢ç„¡é–¢ä¿‚ï¼‰
  const BOSS_MIN_DIST = 170;   // m
  const BOSS_MAX_DIST = 260;   // m

  // ==============================
  // ãƒ‡ãƒ¼ã‚¿
  // ==============================
  const CLASSES = [
    { key:'hero',  name:'ã‚†ã†ã—ã‚ƒ',     main:'#7cc9ff', effect:'slash' },
    { key:'mage',  name:'ã¾ã»ã†ã¤ã‹ã„', main:'#c67cff', effect:'spell' },
    { key:'thief', name:'ã¨ã†ãã',     main:'#7cf7c2', effect:'multi' },
    { key:'war',   name:'ã›ã‚“ã—',       main:'#ffb36b', effect:'heavy' },
  ];

  const MONSTERS = [
    { name:'ã‚¹ãƒ©ã‚¤ãƒ ',   icon:'ğŸŸ¦', tone:560 },
    { name:'ã‚´ãƒ¼ã‚¹ãƒˆ',   icon:'ğŸ‘»', tone:520 },
    { name:'ã‚´ãƒ–ãƒªãƒ³',   icon:'ğŸ‘º', tone:480 },
    { name:'ãƒ‰ãƒ©ã‚­ãƒ¼',   icon:'ğŸ¦‡', tone:620 },
    { name:'ã‚­ãƒ¡ãƒ©',     icon:'ğŸª½', tone:660 },
    { name:'ãƒ¡ã‚¿ãƒ«ï¼Ÿ',   icon:'â¬œ', tone:740 },
  ];

  const RARE_MONSTERS = [
    { name:'ã‚­ãƒ³ã‚°ã‚¹ãƒ©ã‚¤ãƒ ', icon:'ğŸŸª', tone:820 },
    { name:'ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚´ãƒ–ãƒªãƒ³', icon:'ğŸŸ¨', tone:900 },
    { name:'ã‚ã‚„ã—ã„å½±', icon:'ğŸŸ¥', tone:860 },
  ];

  const WEAPONS = [
    { name:'ã©ã†ã®ã¤ã‚‹ã', icon:'ğŸ—¡ï¸', power:1, blade:'#d9b27b' },
    { name:'ã¦ã¤ã®ã‚„ã‚Š',   icon:'ğŸ”±', power:2, blade:'#cfd8e3' },
    { name:'ãã‚“ã®ã¤ã‚‹ã', icon:'ğŸ—¡ï¸', power:3, blade:'#e6f0ff' },
    { name:'ã¾ã»ã†ã®ã¤ãˆ', icon:'ğŸª„', power:2, blade:'#c67cff' },
    { name:'ã§ã‚“ã›ã¤ã®ã‘ã‚“', icon:'ğŸ—¡ï¸', power:5, blade:'#7cf7c2' },
  ];

  const LOOT = [
    { type:'loot', name:'ãã‚“ã‹', icon:'ğŸª™' },
    { type:'loot', name:'ã‚„ããã†', icon:'ğŸŒ¿' },
    { type:'loot', name:'ã›ã„ã™ã„', icon:'ğŸ§´' },
    { type:'loot', name:'ã¡ã„ã•ãªãƒ¡ãƒ€ãƒ«', icon:'ğŸŸ¡' },
  ];

  const CHESTS = [
    { type:'chest', name:'ãŸã‹ã‚‰ã°ã“', icon:'ğŸ§°' },
    { type:'chest', name:'ã‚ã‚„ã—ã„ã¯ã“', icon:'ğŸ“¦' },
  ];

  const RARE_CHESTS = [
    { type:'chest', name:'ã‚´ãƒ¼ãƒ«ãƒ‰ãŸã‹ã‚‰ã°ã“', icon:'ğŸ’°' },
    { type:'chest', name:'ãƒŸãƒŸãƒƒã‚¯ï¼Ÿï¼ˆãŸã¶ã‚“ï¼‰', icon:'ğŸ§²' },
  ];

  const LANDMARKS = [
    { name:'æ‘', icon:'ğŸ˜ï¸', xp:8,  kind:'town' },
    { name:'å®¿å±‹', icon:'ğŸ›ï¸', xp:10, kind:'inn' },
    { name:'æ´çªŸ', icon:'ğŸ•³ï¸', xp:12, kind:'cave' },
    { name:'åŸ', icon:'ğŸ°', xp:16, kind:'castle' },
    { name:'ã»ã“ã‚‰', icon:'â›©ï¸', xp:10, kind:'shrine' },
    { name:'æ©‹', icon:'ğŸŒ‰', xp:9,  kind:'bridge' },
    { name:'æ£®', icon:'ğŸŒ²', xp:11, kind:'forest' },
  ];

  const FALL_CAUSES = [
    'ã„ã—ã«ã¤ã¾ãšã„ãŸ',
    'ãã¤ã²ã‚‚ãŒã»ã©ã‘ãŸ',
    'ã‹ãœãŒã¤ã‚ˆã‹ã£ãŸ',
    'ã¿ãˆãªã„ã ã‚“ã•',
    'ã˜ã‚…ã†ã‚Šã‚‡ããŒã¤ã‚ˆã„',
    'ã›ã‹ã„ã®ã„ã—',
    'ã‚ã—ãŒã‚ã‚‰ã£ãŸ',
  ];

  const BOSSES = [
    { name:'ãƒ‰ãƒ©ã‚´ãƒ³', icon:'ğŸ‰', tone:220 },
    { name:'ã¾ãŠã†ï¼Ÿ', icon:'ğŸ˜ˆ', tone:196 },
    { name:'ã‚®ã‚¬ãƒ³ãƒˆ', icon:'ğŸ—¿', tone:174 },
  ];

  // ==============================
  // DOM
  // ==============================
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');

  function resizeCanvas(){
    const ratio = Math.min(1.6, window.devicePixelRatio || 1);
    const clientW = cv.getBoundingClientRect().width || window.innerWidth;
    const targetW = Math.max(980, Math.min(1600, Math.floor(clientW * ratio)));
    cv.width = targetW;
    cv.height = Math.floor(targetW * 9 / 16);
  }

  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  const elCur = document.getElementById('cur');
  const elDaily = document.getElementById('daily');
  const elBest = document.getElementById('best');
  const elKills = document.getElementById('kills');

  const btnStart = document.getElementById('btnStart');
  const btnText = document.getElementById('btnText');
  const swSound = document.getElementById('swSound');
  const swVibe = document.getElementById('swVibe');

  const btnShare = document.getElementById('btnShare');
  const btnCopy = document.getElementById('btnCopy');

  // ==============================
  // LocalStorage
  // ==============================
  const STORE_KEY_BEST = 'dqfall-best-v3';
  const STORE_KEY_DAILY_PREFIX = 'dqfall-daily-v3-';
  const STORE_KEY_RANKING = 'dqfall-ranking-v3';
  const STORE_KEY_SOUND = 'dqfall-sound-v3';
  const STORE_KEY_VIBE  = 'dqfall-vibe-v3';

  function todayKey(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function loadRanking(){
    try{
      const raw = localStorage.getItem(STORE_KEY_RANKING);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    } catch { return []; }
  }

  function saveRanking(arr){
    try{ localStorage.setItem(STORE_KEY_RANKING, JSON.stringify(arr)); } catch {}
  }

  let best = Number(localStorage.getItem(STORE_KEY_BEST) || '0');
  let dailyBest = Number(localStorage.getItem(STORE_KEY_DAILY_PREFIX + todayKey()) || '0');
  let ranking = loadRanking();

  // ==============================
  // Audio
  // ==============================
  let audioCtx = null;

  // è¨­å®šï¼ˆé‡è¤‡å®£è¨€ã—ãªã„ï¼‰
  let soundOn = (localStorage.getItem(STORE_KEY_SOUND) ?? '1') === '1';
  let vibeOn  = (localStorage.getItem(STORE_KEY_VIBE) ?? '0') === '1';

  // æ­©è¡ŒBGMã£ã½ã„SEï¼ˆè‘—ä½œç‰©ã®æ—‹å¾‹ã‚³ãƒ”ãƒ¼ã¯é¿ã‘ã¤ã¤ã€Œè¡Œé€²æ„Ÿã€ã‚’å‡ºã™ï¼‰
  let walkTimer = null;
  let walkStep = 0;
  function startWalkBGM(){
    stopWalkBGM();
    if (!soundOn) return;
    ensureAudio();
    // 6/8ã£ã½ã„ãƒãƒªã®çŸ­ã„å‹•æ©Ÿã‚’ãƒ«ãƒ¼ãƒ—ï¼ˆã‚ãã¾ã§åŠ¹æœéŸ³å¯„ã‚Šï¼‰
    const motif = [
      {f:392, d:0.05, v:0.06},
      {f:523, d:0.05, v:0.06},
      {f:659, d:0.06, v:0.06},
      {f:523, d:0.05, v:0.05},
      {f:440, d:0.06, v:0.05},
      {f:523, d:0.06, v:0.05},
    ];
    walkStep = 0;
    walkTimer = setInterval(() => {
      if (mode !== MODE.RUN || !soundOn) return;
      const foot = (walkStep % 2 === 0) ? 196 : 220;
      tone([{f:foot, d:0.03, v:0.035, g:0.0}], 'square');
      if ((walkStep % 6) === 0) tone(motif, 'triangle');
      walkStep++;
    }, 220);
  }
  function stopWalkBGM(){
    if (walkTimer){ clearInterval(walkTimer); walkTimer = null; }
  }

  function ensureAudio(){
    if (!soundOn) return;
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
  }

  function tone(seq, type='square'){
    if (!soundOn) return;
    ensureAudio();
    if (!audioCtx) return;
    let t = audioCtx.currentTime;
    for (const s of seq){
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.value = s.f;
      o.connect(g); g.connect(audioCtx.destination);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(s.v ?? 0.12, t + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t + s.d);
      o.start(t);
      o.stop(t + s.d + 0.02);
      t += s.d + (s.g ?? 0.02);
    }
  }

  const SFX = {
    start: () => tone([{f:330,d:0.07},{f:440,d:0.07},{f:660,d:0.10,g:0.04}]),
    msg:   () => tone([{f:880,d:0.04,v:0.09}]),
    approach: (f) => tone([{f, d:0.05, v:0.08},{f:f*0.8, d:0.05, v:0.08}], 'square'),
    hit:   () => tone([{f:220,d:0.05,v:0.12},{f:140,d:0.07,v:0.10}]),
    item:  () => tone([{f:784,d:0.06,v:0.10},{f:988,d:0.08,v:0.10}]),
    fall:  () => tone([{f:196,d:0.08,v:0.12},{f:110,d:0.14,v:0.10,g:0.04}]),
    best:  () => tone([{f:523,d:0.08,v:0.11},{f:659,d:0.08,v:0.11},{f:784,d:0.10,v:0.12,g:0.05}]),
    spell: () => tone([{f:988,d:0.05,v:0.10},{f:1318,d:0.06,v:0.10},{f:1760,d:0.08,v:0.10,g:0.04}], 'sine'),

    // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼šè‘—ä½œç‰©ã®æ—‹å¾‹ã‚³ãƒ”ãƒ¼ã¯é¿ã‘ã¤ã¤ã€Œãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬æ„Ÿã€ã‚’ç‹™ã£ãŸã‚ªãƒªã‚¸ãƒŠãƒ«
    level: () => tone(
      [
        {f:523,d:0.09,v:0.11},{f:659,d:0.09,v:0.11},{f:784,d:0.10,v:0.12,g:0.03},
        {f:659,d:0.08,v:0.11},{f:784,d:0.08,v:0.12},{f:988,d:0.14,v:0.12,g:0.04},
        {f:1046,d:0.18,v:0.12,g:0.06},
      ],
      'triangle'
    ),

    rare:  () => tone([{f:988,d:0.06,v:0.10},{f:1318,d:0.06,v:0.10},{f:1760,d:0.10,v:0.11,g:0.04}], 'sawtooth'),

    // å®¿å±‹ãƒ»å›å¾©
    inn: () => tone([{f:392,d:0.08,v:0.10},{f:494,d:0.10,v:0.10},{f:659,d:0.14,v:0.11,g:0.04}], 'triangle'),

    // ãƒœã‚¹å‡ºç¾
    boss: () => tone([{f:220,d:0.10,v:0.11},{f:196,d:0.10,v:0.11},{f:174,d:0.14,v:0.11,g:0.05}], 'sawtooth'),
  };

  function vibrate(pattern){
    if (!vibeOn) return;
    if (navigator.vibrate) navigator.vibrate(pattern);
  }

  function syncToggles(){
    swSound.classList.toggle('on', soundOn);
    swVibe.classList.toggle('on', vibeOn);
  }

  // ==============================
  // RNG
  // ==============================
  let rng = mulberry32((Date.now() ^ (Math.random()*1e9)) >>> 0);
  function mulberry32(a){
    return function(){
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }

  // ==============================
  // State
  // ==============================
  const MODE = { READY:0, RUN:1, FALLING:2, RESULT:3 };
  let mode = MODE.READY;

  let dist = 0;
  let speed = 0;
  let camX = 0;

  let heroClass = null;
  let equipped = null;

  // RPG-ish status (æ¼”å‡ºç”¨)
  let level = 1;
  let xp = 0;
  let nextXp = 20;
  let hp = 18, maxHp = 18;
  let mp = 8,  maxMp = 8;

  let kills = 0;
  let inventory = [];
  let landmarksSeen = [];
  let rareCount = 0;

  let logLines = [];
  let lastCause = '';
  let title = '';
  let lastIsBest = false;
  let resultBadges = [];

  let msg = { text:'', t:0, dur:0 };

  let nextEncounterX = 900;
  let nextItemX = 780;
  let nextLandmarkX = 1100;

  // boss
  let bossDist = 220;
  let bossDone = false;

  // active: battle/item/landmark/boss/fall
  let active = null;

  // particles
  let particles = [];

  const hero = {
    x:0, y:0, vy:0,
    tilt:0, rag:0, ragV:0,
    step:0,
    crown:false,
  };

  // ==============================
  // Terrain
  // ==============================
  function groundY(x){
    const a = 22 * BUMPINESS;
    const b = 12 * BUMPINESS;
    const c = 8  * BUMPINESS;
    return 520
      + Math.sin(x * 0.016) * a
      + Math.sin(x * 0.043 + 1.9) * b
      + Math.sin(x * 0.085 + 0.7) * c;
  }

  function groundSlope(x){
    const e = 2.0;
    return (groundY(x+e) - groundY(x-e)) / (2*e);
  }

  // ==============================
  // UI helpers
  // ==============================
  function fmt(m){ return (Math.max(0,m)).toFixed(1) + ' m'; }

  function sync(){
    elCur.textContent = fmt(dist);
    elBest.textContent = fmt(best);
    elDaily.textContent = fmt(dailyBest);
    elKills.textContent = String(kills);
  }

  function pushLog(s){
    logLines.push(s);
    if (logLines.length > 16) logLines.shift();
  }

  function showMsg(text, dur=0.95){
    msg.text = text;
    msg.t = 0;
    msg.dur = dur;
    SFX.msg();
  }

  function addXP(amount, reason){
    xp += amount;
    if (reason) pushLog(`ï¼‹${amount}EXPï¼ˆ${reason}ï¼‰`);
    while (xp >= nextXp){
      xp -= nextXp;
      level += 1;
      nextXp = Math.floor(nextXp * 1.25 + 6);
      // æ¼”å‡ºä¸Šã®ã‚¹ãƒ†ä¸Šæ˜‡
      maxHp += 2;
      maxMp += 1;
      hp = Math.min(maxHp, hp + 3);
      mp = Math.min(maxMp, mp + 2);
      pushLog(`â˜… ãƒ¬ãƒ™ãƒ«ãŒ ${level} ã« ã‚ãŒã£ãŸï¼`);
      showMsg(`ãƒ¬ãƒ™ãƒ«ãŒ ${level} ã« ã‚ãŒã£ãŸï¼`, 1.2);
      SFX.level();
      vibrate([10, 30, 10]);
      spawnBurst(hero.x + 80, hero.y - 40, heroClass ? heroClass.main : 'rgba(255,255,255,0.9)');
    }
  }

  // ==============================
  // Controls
  // ==============================
  cv.addEventListener('pointerdown', () => triggerStart('canvas'), {passive:true});
  btnStart.addEventListener('click', () => triggerStart('button'));

  function triggerStart(source='button'){
    if (mode === MODE.RUN || mode === MODE.FALLING) return;
    if (mode === MODE.RESULT && source !== 'button') return; // èª¤çˆ†é˜²æ­¢ï¼šãƒªã‚¶ãƒ«ãƒˆä¸­ã¯ãƒœã‚¿ãƒ³ã®ã¿
    // éŸ³ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§èµ·å‹•ã§ãã‚‹ã®ã§ã€ã“ã“ã§AudioContextã‚’èµ·ã“ã—ã¦ãŠã
    ensureAudio();
    startRun();
  }

  swSound.addEventListener('click', () => {
    soundOn = !soundOn;
    try{ localStorage.setItem(STORE_KEY_SOUND, soundOn ? '1':'0'); } catch {}
    syncToggles();
    if (soundOn){ ensureAudio(); SFX.msg(); if (mode === MODE.RUN) startWalkBGM(); }
    else { stopWalkBGM(); }
  });

  swVibe.addEventListener('click', () => {
    vibeOn = !vibeOn;
    try{ localStorage.setItem(STORE_KEY_VIBE, vibeOn ? '1':'0'); } catch {}
    syncToggles();
    vibrate(15);
  });

  btnShare.addEventListener('click', async () => {
    const text = shareText();
    try{
      if (navigator.share){
        await navigator.share({ text, title: 'å‹‡è€…ãŒå‹æ‰‹ã«è»¢ã¶å†’é™º' });
        showMsg('å…±æœ‰ã—ã¾ã—ãŸ', 0.8);
      } else {
        await copyText(text);
        showMsg('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 0.8);
      }
    } catch {
      showMsg('å…±æœ‰ã‚’ä¸­æ–­', 0.8);
    }
  });

  btnCopy.addEventListener('click', async () => {
    await copyText(shareText());
    showMsg('çµæœã‚’ã‚³ãƒ”ãƒ¼', 0.8);
  });

  async function copyText(text){
    try{ await navigator.clipboard.writeText(text); }
    catch {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    }
  }

  function shareText(){
    const cls = heroClass ? heroClass.name : 'ï¼Ÿï¼Ÿï¼Ÿ';
    const inv = inventory.slice(0, 8).map(i => `${i.icon}${i.name}`).join(' / ');
    const more = inventory.length > 8 ? ` (+${inventory.length-8})` : '';
    const wpn = equipped ? `${equipped.icon}${equipped.name}` : 'ãªã—';
    const lm = landmarksSeen.slice(0,6).map(l => `${l.icon}${l.name}`).join(' / ');
    const lmMore = landmarksSeen.length > 6 ? ` (+${landmarksSeen.length-6})` : '';
    return `å‹‡è€…ãŒå‹æ‰‹ã«è»¢ã¶å†’é™º\nè·æ¥­ï¼š${cls} Lv${level}\nç§°å·ï¼š${title || 'â€”'}\nè·é›¢ï¼š${fmt(dist)}\nè¨ä¼ï¼š${kills}ï¼ˆãƒ¬ã‚¢${rareCount}ï¼‰\næ­¦å™¨ï¼š${wpn}\nå…¥æ‰‹ï¼š${inventory.length ? (inv + more) : 'ãªã—'}\nåœ°ç‚¹ï¼š${landmarksSeen.length ? (lm + lmMore) : 'ãªã—'}\nè»¢å€’ï¼š${lastCause || 'â€”'}`;
  }

  // ==============================
  // Start / Fall / Result
  // ==============================
  function startRun(){
    mode = MODE.RUN;
    dist = 0;
    speed = BASE_SPEED;
    camX = 0;

    heroClass = CLASSES[Math.floor(rng()*CLASSES.length)];
    equipped = null;

    level = 1;
    xp = 0;
    nextXp = 20;
    maxHp = 18;
    maxMp = 8;
    hp = maxHp;
    mp = maxMp;

    hero.x = 0;
    hero.vy = 0;
    hero.tilt = 0;
    hero.rag = 0;
    hero.ragV = 0;
    hero.step = 0;
    hero.crown = false;

    kills = 0;
    inventory = [];
    landmarksSeen = [];
    rareCount = 0;

    logLines = [];
    lastCause = '';
    title = '';
    resultBadges = [];
    lastIsBest = false;

    nextEncounterX = 680 + Math.floor(rng()*220);
    nextItemX = 520 + Math.floor(rng()*240);
    nextLandmarkX = 900 + Math.floor(rng()*380);

    // ãƒœã‚¹ï¼ˆã‚¹ã‚³ã‚¢ç„¡é–¢ä¿‚ï¼‰
    bossDone = false;
    bossDist = BOSS_MIN_DIST + rng()*(BOSS_MAX_DIST - BOSS_MIN_DIST);

    active = null;
    particles = [];

    rng = mulberry32(((Date.now() + Math.floor(Math.random()*1e9)) ^ 0xC0FFEE) >>> 0);

    btnText.textContent = 'å†’é™ºä¸­â€¦';
    SFX.start();
    vibrate(18);
    if (soundOn) startWalkBGM();

    pushLog(`â–¶ ${heroClass.name} ã¯ ãŸã³ã«ã§ãŸï¼`);
    showMsg(`${heroClass.name} ã« ãã¾ã‚Šã¾ã—ãŸ`, 1.1);

    sync();
  }

  function startFalling(){
    mode = MODE.FALLING;

    hero.vy = -7 - rng()*9;
    hero.rag = hero.tilt;
    hero.ragV = (rng() < 0.5 ? -1 : 1) * (4 + rng()*7);

    lastCause = FALL_CAUSES[Math.floor(rng()*FALL_CAUSES.length)];
    pushLog(`â–¼ ${heroClass.name} ã¯ ${lastCause}`);

    SFX.fall();
    vibrate([18, 30, 12]);

    active = { type:'fall', t:0 };
  }

  function computeTitle(){
    const d = dist;
    const k = kills;
    const inv = inventory.length;
    const lm = landmarksSeen.length;
    const w = equipped ? equipped.power : 0;

    if (rareCount >= 3) return 'ãƒ¬ã‚¢ç‹©ã‚Šãƒã‚¹ã‚¿ãƒ¼';
    if (rareCount >= 1 && d < 70) return 'ãƒ¬ã‚¢ã‚’è¦‹ã¦è»¢ã¶è€…';
    if (level >= 6 && d < 90) return 'è‚²ã£ã¦ã‚‚è»¢ã¶';

    if (equipped && equipped.name === 'ã§ã‚“ã›ã¤ã®ã‘ã‚“' && d < 60) return 'ä¼èª¬ã‚’æŒã£ã¦è»¢ã¶è€…';
    if (k >= 10 && d < 80) return 'æˆ¦é—˜ç‹‚ï¼ˆè»¢å€’ï¼‰';
    if (inv >= 12) return 'æ‹¾ã„ç‰©åäºº';
    if (lm >= 4 && d >= 120) return 'æ—…ã®è¨˜éŒ²è€…';

    if (d >= 280) return 'ä¸–ç•Œã‚’èµ°ç ´ã—ãŸ';
    if (d >= 210) return 'è»¢ã°ã¬å‹‡è€…ï¼ˆä»®ï¼‰';
    if (d >= 150) return 'é‹¼ã®è¶³è…°';
    if (d >= 95)  return 'å†’é™ºè€…è¦‹ç¿’ã„';

    if (w >= 3) return 'è£…å‚™ã ã‘ã¯ä¸€æµ';
    if (k >= 3) return 'åˆç´šè¨ä¼ç‹';
    return 'è»¢å€’ã®ç´ è³ª';
  }

  function updateRanking(){
    const entry = {
      ts: Date.now(),
      dist: Number(dist.toFixed(1)),
      cls: heroClass ? heroClass.name : 'ï¼Ÿï¼Ÿï¼Ÿ',
      lv: level,
      title: title || '',
      kills,
      rare: rareCount,
    };

    ranking.push(entry);
    ranking.sort((a,b) => b.dist - a.dist);
    ranking = ranking.slice(0, 10);
    saveRanking(ranking);
  }

  function finalizeResult(){
    stopWalkBGM();
    mode = MODE.RESULT;
    btnText.textContent = 'ã‚‚ã†ä¸€å›';

    title = computeTitle();

    let isBest = false;
    const beatDaily = dist > dailyBest;
    if (dist > best){
      best = dist;
      localStorage.setItem(STORE_KEY_BEST, String(best));
      isBest = true;
    }
    if (dist > dailyBest){
      dailyBest = dist;
      localStorage.setItem(STORE_KEY_DAILY_PREFIX + todayKey(), String(dailyBest));
    }

    lastIsBest = isBest;
    resultBadges = [];
    if (isBest) resultBadges.push('æ–°è¨˜éŒ²');
    else if (beatDaily) resultBadges.push('æœ¬æ—¥ãƒ™ã‚¹ãƒˆ');
    if (title) resultBadges.push('ç§°å·');
    if (rareCount > 0) resultBadges.push(`ãƒ¬ã‚¢ ${rareCount}`);
    if (kills >= 5) resultBadges.push('è¨ä¼');
    if (level >= 5) resultBadges.push(`Lv ${level}`);
    if (inventory.length >= 6) resultBadges.push('ãƒ¬ã‚¢æ‹¾ã„');

    updateRanking();

    if (isBest){
      SFX.best();
      vibrate([25, 40, 25]);
      pushLog('â˜… ã•ã„ã“ã†ãã‚ãï¼');
      showMsg('ã•ã„ã“ã†ãã‚ãï¼', 1.2);
    } else {
      showMsg('ã¤ãã¯ ã„ã‘ã‚‹', 1.0);
    }

    pushLog(`â—† ã—ã‚‡ã†ã”ã†ï¼š${title}`);

    sync();
  }

  // ==============================
  // Loop
  // ==============================
  let lastT = performance.now();
  requestAnimationFrame(loop);

  function loop(now){
    const dt = Math.min(0.033, (now - lastT) / 1000);
    lastT = now;
    update(dt);
    render();
    requestAnimationFrame(loop);
  }

  function update(dt){
    // message
    if (msg.dur > 0){
      msg.t += dt;
      if (msg.t >= msg.dur){ msg.text = ''; msg.dur = 0; }
    }

    // particles
    for (const p of particles){
      p.life -= dt;
      p.x += p.vx * dt;
      p.y += p.vy * dt;
      p.vy += 140 * dt;
    }
    particles = particles.filter(p => p.life > 0);

    if (mode === MODE.RUN){
      dist += speed * dt;
      speed += (SPEED_RAMP * dt) * (1 + dist * 0.0010);

      hero.x = dist * 40;
      hero.step += dt * (9.4 + speed*0.35);

      const gy = groundY(hero.x);
      hero.y = gy - 62;

      const slope = groundSlope(hero.x);
      const targetTilt = clamp(slope * 0.030, -0.40, 0.40);
      hero.tilt += (targetTilt - hero.tilt) * 0.14;

      const targetCam = hero.x - 320;
      camX += (targetCam - camX) * (1 - Math.pow(1 - CAMERA_LAG, dt * 60));

      if (rng() < 0.10 * dt * 60){
        particles.push({ x: hero.x + 24, y: hero.y - 28, vx: -60 + rng()*120, vy: -20 - rng()*40, life: 0.25, kind:'spark', color:'rgba(255,255,255,0.82)' });
      }

      // ç°¡æ˜“HP/MPå¤‰å‹•ï¼ˆæ¼”å‡ºï¼‰
      if (rng() < 0.01 * dt * 60){
        hp = clamp(hp - (rng()<0.5?1:0), 0, maxHp);
        mp = clamp(mp - (rng()<0.35?1:0), 0, maxMp);
      }

      // ãƒœã‚¹ç™ºç”Ÿï¼ˆã‚¹ã‚³ã‚¢ç„¡é–¢ä¿‚ãƒ»æ¼”å‡ºã®ã¿ï¼‰
      if (!active && !bossDone && dist >= bossDist){
        const b = BOSSES[Math.floor(rng()*BOSSES.length)];
        active = {
          type:'boss',
          t:0,
          phase:0,
          boss:b,
          mx: hero.x + 560,
          my: groundY(hero.x + 560) - 130,
        };
        bossDone = true;
        pushLog(`ï¼ï¼ ${b.name} ãŒ ã‚ã‚‰ã‚ã‚ŒãŸ`);
        showMsg(`${b.name} ãŒ ã‚ã‚‰ã‚ã‚ŒãŸï¼`, 1.1);
        SFX.boss();
        vibrate([18, 24, 18]);
      }

      // Battle schedule
      if (!active && hero.x >= nextEncounterX){
        const isRare = rng() < RARE_ENEMY_RATE;
        const m = isRare ? RARE_MONSTERS[Math.floor(rng()*RARE_MONSTERS.length)] : MONSTERS[Math.floor(rng()*MONSTERS.length)];
        active = {
          type:'battle',
          t:0,
          phase:0,
          monster:m,
          rare:isRare,
          mx: hero.x + 520,
          my: groundY(hero.x + 520) - 110,
        };
        pushLog(`ï¼ ${m.name} ãŒ ã‚ã‚‰ã‚ã‚ŒãŸ` + (isRare ? 'ï¼ˆãƒ¬ã‚¢ï¼‰' : ''));
        showMsg(`${m.name} ãŒ ã‚ã‚‰ã‚ã‚ŒãŸ`, 1.0);
        if (isRare){ SFX.rare(); vibrate([12,18,12]); }
        else { SFX.approach(m.tone); vibrate(10); }

        nextEncounterX += ENCOUNTER_MIN + Math.floor(rng()*(ENCOUNTER_MAX-ENCOUNTER_MIN));
      }

      // Item schedule
      if (!active && hero.x >= nextItemX){
        const roll = rng();
        let it;
        if (roll < 0.30){
          const isRare = rng() < RARE_CHEST_RATE;
          it = isRare ? RARE_CHESTS[Math.floor(rng()*RARE_CHESTS.length)] : CHESTS[Math.floor(rng()*CHESTS.length)];
          it = { ...it, rare: isRare };
        } else if (roll < 0.62){
          it = WEAPONS[Math.floor(rng()*WEAPONS.length)];
        } else {
          it = LOOT[Math.floor(rng()*LOOT.length)];
        }

        active = { type:'item', t:0, data:it };

        if (it.type === 'loot'){
          inventory.push({ icon: it.icon, name: it.name, type: 'loot' });
          pushLog(`â™ª ${it.name} ã‚’ ã¦ã«ã„ã‚ŒãŸ`);
          showMsg(`${it.name} ã‚’ ã¦ã«ã„ã‚ŒãŸ`, 1.0);
          addXP(4 + Math.floor(rng()*3), 'ã²ã‚ã„ã‚‚ã®');
          hp = clamp(hp + (it.name==='ã‚„ããã†'?3:0), 0, maxHp);
          mp = clamp(mp + (it.name==='ã›ã„ã™ã„'?2:0), 0, maxMp);

        } else if (it.type === 'chest'){
          const rare = !!it.rare;
          inventory.push({ icon: it.icon, name: it.name, type: 'chest' });
          pushLog(`â™ª ${it.name} ã‚’ ã¿ã¤ã‘ãŸ` + (rare ? 'ï¼ˆãƒ¬ã‚¢ï¼‰' : ''));
          showMsg(`${it.name} ã‚’ ã¿ã¤ã‘ãŸ`, 1.0);
          if (rare){
            rareCount += 1;
            SFX.rare();
            vibrate([12,18,12]);
            addXP(14 + Math.floor(rng()*8), 'ãƒ¬ã‚¢ãŸã‹ã‚‰');
            spawnBurst(hero.x + 220, hero.y - 60, 'rgba(255,215,90,0.95)');
          } else {
            SFX.item();
            vibrate(12);
            addXP(9 + Math.floor(rng()*5), 'ãŸã‹ã‚‰');
          }

        } else {
          equipped = it;
          inventory.push({ icon: it.icon, name: it.name, type: 'weapon' });
          pushLog(`â™ª ${it.name} ã‚’ ãã†ã³ã—ãŸ`);
          showMsg(`${it.name} ã‚’ ãã†ã³ã—ãŸ`, 1.0);
          SFX.item();
          vibrate(12);
          addXP(7 + it.power, 'ãã†ã³');
        }

        nextItemX += ITEM_MIN + Math.floor(rng()*(ITEM_MAX-ITEM_MIN));
      }

      // Landmark schedule
      if (!active && hero.x >= nextLandmarkX){
        const lm = LANDMARKS[Math.floor(rng()*LANDMARKS.length)];
        active = { type:'landmark', t:0, data: lm, x: hero.x + 520, y: groundY(hero.x + 520) - 120 };
        landmarksSeen.push(lm);
        pushLog(`â—† ${lm.name} ã« ã¨ã†ã¡ã‚ƒã`);
        showMsg(`${lm.name} ã« ã¨ã†ã¡ã‚ƒã`, 1.0);

        if (lm.kind === 'inn'){
          // å®¿å±‹ã¯å°‚ç”¨SEï¼‹å¤§å›å¾©
          SFX.inn();
          vibrate([8, 12, 8]);
          hp = maxHp;
          mp = maxMp;
          addXP(lm.xp + 6, `ã‚„ã©ã‚„ï¼ˆ${lm.name}ï¼‰`);
          pushLog('â— HP/MP ãŒ ã‹ã„ãµãã—ãŸ');
        } else {
          SFX.item();
          vibrate(10);
          addXP(lm.xp, `ã¡ã¦ã‚“ï¼ˆ${lm.name}ï¼‰`);
          hp = clamp(hp + 2, 0, maxHp);
          mp = clamp(mp + 1, 0, maxMp);
        }

        nextLandmarkX += LANDMARK_MIN + Math.floor(rng()*(LANDMARK_MAX-LANDMARK_MIN));
      }

      // process active
      if (active){
        active.t += dt;

        // è¿‘ã¥ã
        if (active.type === 'battle' || active.type === 'boss'){
          const targetX = hero.x + 230;
          const approachSpeed = 520;
          if (active.mx > targetX) active.mx -= approachSpeed * dt;
        }

        // battle
        if (active.type === 'battle'){
          if (active.t >= 0.65 && active.phase === 0){
            active.phase = 1;
            doAttackEffect(active);
          }

          if (active.t >= 1.10 && active.phase === 1){
            active.phase = 2;
            spawnPuff(active.mx, active.my, heroClass.main);
            SFX.hit();
            vibrate([10, 20, 10]);
            pushLog(`â†’ ${active.monster.name} ã‚’ ãŸãŠã—ãŸ` + (active.rare ? 'ï¼ˆãƒ¬ã‚¢ï¼‰' : ''));
            kills += 1;
            addXP(active.rare ? (18 + Math.floor(rng()*10)) : (10 + Math.floor(rng()*6)), active.rare ? 'ãƒ¬ã‚¢è¨ä¼' : 'è¨ä¼');
            mp = clamp(mp - (heroClass.key==='mage' ? 2 : 1), 0, maxMp);
            hp = clamp(hp - (active.rare ? 2 : 1), 0, maxHp);

            if (active.rare){
              rareCount += 1;
              spawnBurst(active.mx, active.my - 10, 'rgba(255,215,90,0.95)');
            }
            showMsg(`${active.monster.name} ã‚’ ãŸãŠã—ãŸ`, 0.95);
          }

          if (active.t >= 1.35){
            active = null;
          }

        // boss
        } else if (active.type === 'boss'){
          // æ¼”å‡ºã‚’å°‘ã—é•·ã‚ã«ã—ã¦ã€Œãƒœã‚¹æˆ¦ã€æ„Ÿ
          if (active.t >= 0.80 && active.phase === 0){
            active.phase = 1;
            doBossAttackEffect(active);
          }

          if (active.t >= 1.35 && active.phase === 1){
            active.phase = 2;
            spawnPuff(active.mx, active.my, 'rgba(255,255,255,0.9)');
            SFX.hit();
            vibrate([14, 22, 14]);
            pushLog(`â†’ ${active.boss.name} ã‚’ ã—ã‚Šãã‘ãŸ`);
            // å ±é…¬ï¼ˆã‚¹ã‚³ã‚¢ç„¡é–¢ä¿‚ã ãŒã€è‚²ã¤ï¼‰
            addXP(22 + Math.floor(rng()*10), 'ãƒœã‚¹');
            hp = clamp(hp - 2, 0, maxHp);
            mp = clamp(mp - 1, 0, maxMp);
            spawnBurst(active.mx, active.my - 12, 'rgba(255,90,90,0.95)');
            showMsg(`${active.boss.name} ã‚’ ã—ã‚Šãã‘ãŸï¼`, 1.0);
          }

          if (active.t >= 1.70){
            active = null;
          }

        } else if (active.type === 'item'){
          if (active.t >= 0.95) active = null;

        } else if (active.type === 'landmark'){
          if (active.t >= 1.05) active = null;
        }
      }

      // Fall check
      const chaos = (rng() - 0.5) * 0.95;
      const slopeRisk = Math.abs(slope) / 30;
      const fatigue = dist * 0.00018;
      const p = FALL_RATE * (0.55 + slopeRisk + fatigue) * (1 + chaos);
      if (rng() < clamp(p, 0, 0.16) * dt * 60){
        startFalling();
      }

      if (best >= 180) hero.crown = true;
      sync();

    } else if (mode === MODE.FALLING){
      if (active) active.t += dt;

      hero.vy += GRAVITY * dt;
      hero.y += hero.vy * 24 * dt;
      hero.rag += hero.ragV * dt;
      hero.ragV *= (1 - 0.9*dt);

      const gy = groundY(hero.x) - 42;
      if (hero.y > gy){
        hero.y = gy;
        hero.vy *= -0.35;
        hero.ragV *= 0.85;
        if (Math.abs(hero.vy) < 2.0) hero.vy = 0;
      }

      hero.x += 110 * dt;
      camX += ((hero.x - 320) - camX) * (1 - Math.pow(1 - CAMERA_LAG, dt * 60));

      if (active && active.t >= FALL_SHOW_SEC){
        finalizeResult();
      }

      sync();

    } else {
      btnText.textContent = (best > 0) ? 'ã‚‚ã†ä¸€å›' : 'å†’é™ºã‚’ã¯ã˜ã‚ã‚‹';
    }
  }

  function doAttackEffect(ev){
    const cls = heroClass.effect;
    const hx = hero.x + 70;
    const hy = hero.y - 12;
    const mx = ev.mx;
    const my = ev.my;

    if (cls === 'spell'){
      for (let i=0;i<10;i++){
        const a = -0.2 + rng()*0.4;
        const sp = 520 + rng()*260;
        particles.push({ x:hx, y:hy, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp - 160, life:0.55 + rng()*0.25, kind:'spark', color:heroClass.main });
      }
      SFX.spell();
      vibrate(10);
      pushLog('ï¼Š ã¾ã»ã†ï¼');

    } else if (cls === 'multi'){
      for (let i=0;i<3;i++){
        particles.push({ x:mx - 30, y:my - 16 + i*14, vx:-80, vy:-40 + i*20, life:0.25, kind:'slash', color:'rgba(255,255,255,0.9)' });
      }
      SFX.hit();
      vibrate(12);
      pushLog('â‰¡ ã‚Œã‚“ã’ã');

    } else if (cls === 'heavy'){
      spawnPuff(mx, my, 'rgba(255,255,255,0.9)');
      for (let i=0;i<8;i++){
        const a = rng()*Math.PI*2;
        const sp = 280 + rng()*260;
        particles.push({ x:mx, y:my, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp - 120, life:0.42 + rng()*0.22, kind:'spark', color:'rgba(255,255,255,0.85)' });
      }
      SFX.hit();
      vibrate([12, 18, 12]);
      pushLog('ï¼ ã¤ã†ã“ã‚“');

    } else {
      particles.push({ x:mx-28, y:my-10, vx:-120, vy:-40, life:0.28, kind:'slash', color:'rgba(255,255,255,0.9)' });
      SFX.hit();
      vibrate(12);
      pushLog('ï¼ ã“ã†ã’ã');
    }

    if (ev.rare){
      spawnBurst(mx, my - 10, 'rgba(255,215,90,0.95)');
    }
  }

  function doBossAttackEffect(ev){
    // ãƒœã‚¹ç”¨ï¼šã¡ã‚‡ã„æ´¾æ‰‹
    const mx = ev.mx;
    const my = ev.my;
    spawnBurst(mx, my - 12, 'rgba(255,90,90,0.95)');
    for (let i=0;i<10;i++){
      const a = rng()*Math.PI*2;
      const sp = 320 + rng()*360;
      particles.push({ x:mx, y:my, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp - 160, life:0.55 + rng()*0.28, kind:'spark', color:'rgba(255,90,90,0.85)' });
    }
    SFX.spell();
    vibrate([10, 18, 10]);
    pushLog('ï¼ ã²ã£ã•ã¤');
  }

  function spawnPuff(x,y,color){
    for (let i=0;i<10;i++){
      const a = rng()*Math.PI*2;
      const sp = 160 + rng()*220;
      particles.push({ x, y, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp - 120, life:0.35 + rng()*0.25, kind:'puff', color });
    }
  }

  function spawnBurst(x,y,color){
    for (let i=0;i<18;i++){
      const a = rng()*Math.PI*2;
      const sp = 220 + rng()*360;
      particles.push({ x, y, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp - 180, life:0.55 + rng()*0.30, kind:'spark', color });
    }
  }

  // ==============================
  // Render
  // ==============================
  function render(){
    const W = cv.width, H = cv.height;
    const glow = clamp(best / 220, 0, 1);

    ctx.clearRect(0,0,W,H);

    // stars
    ctx.globalAlpha = 0.42 + glow*0.20;
    const starN = 30 + Math.floor(glow*34);
    for (let i=0;i<starN;i++){
      const x = (i*137.5 + (camX*0.04)) % W;
      const y = (i*i*17.2) % (H*0.55);
      ctx.fillStyle = 'rgba(255,255,255,0.08)';
      ctx.fillRect(x, y, 2, 2);
    }
    ctx.globalAlpha = 1;

    // aurora
    ctx.save();
    const ag = ctx.createLinearGradient(0, 0, 0, H);
    ag.addColorStop(0, `rgba(124,201,255,${0.08 + glow*0.12})`);
    ag.addColorStop(1, `rgba(124,247,194,${0.00 + glow*0.08})`);
    ctx.fillStyle = ag;
    ctx.fillRect(0,0,W,H);
    ctx.restore();

    // world
    ctx.save();
    ctx.translate(-camX, 0);

    // ground
    ctx.beginPath();
    const startX = camX - 120;
    const endX = camX + W + 120;
    ctx.moveTo(startX, H);
    for (let x = startX; x <= endX; x += 12){
      ctx.lineTo(x, groundY(x));
    }
    ctx.lineTo(endX, H);
    ctx.closePath();

    const g = ctx.createLinearGradient(0, 420, 0, H);
    g.addColorStop(0, `rgba(124,201,255,${0.10 + glow*0.10})`);
    g.addColorStop(1, 'rgba(255,255,255,0.00)');
    ctx.fillStyle = g;
    ctx.fill();

    // line
    ctx.beginPath();
    for (let x = startX; x <= endX; x += 10){
      ctx.lineTo(x, groundY(x));
    }
    ctx.strokeStyle = `rgba(255,255,255,${0.10 + glow*0.06})`;
    ctx.lineWidth = 2;
    ctx.stroke();

    // landmark in world
    if (active && active.type === 'landmark' && mode === MODE.RUN){
      drawLandmark(ctx, active);
    }

    // monster/boss in world
    if (active && mode === MODE.RUN){
      if (active.type === 'battle') drawMonster(ctx, active);
      if (active.type === 'boss') drawBoss(ctx, active);
    }

    // item in world
    if (active && active.type === 'item' && mode === MODE.RUN){
      drawItem(ctx, active, hero.x + 520, groundY(hero.x + 520) - 120);
    }

    // hero
    const running = (mode === MODE.RUN);
    const ang = running ? hero.tilt : (hero.rag + 1.1);
    drawHero(ctx, hero.x, hero.y, ang, running, glow);

    if (glow > 0.05){
      ctx.save();
      ctx.globalAlpha = 0.20 + glow*0.15;
      const hx = hero.x - camX;
      const hy = hero.y - 42;
      ctx.fillStyle = 'rgba(255,255,255,0.55)';
      ctx.beginPath();
      ctx.ellipse(hx, hy, 14, 6, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
    }

    // particles
    drawParticlesWorld(ctx);

    ctx.restore();

    drawHUD(W, H, glow);

    if (mode === MODE.READY){
      drawCenterCard(W, H, glow, 'ã‚¿ãƒƒãƒ—ã§ ã¼ã†ã‘ã‚“', 'ã—ã‚‡ããã‚‡ã†ã¯ ã‹ã£ã¦ã« ãã¾ã‚Šã¾ã™');
    } else if (mode === MODE.RESULT){
      drawResultCard(W, H, glow);
    }
  }

  function drawLandmark(ctx, ev){
    ctx.save();
    ctx.translate(ev.x, ev.y);
    const s = clamp(cv.width / 1200, 0.9, 1.2);
    ctx.globalAlpha = 0.98;
    ctx.font = `${Math.round(30*s)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(ev.data.icon, 0, 0);
    ctx.globalAlpha = 0.75;
    ctx.fillStyle = 'rgba(255,255,255,0.85)';
    ctx.font = `${Math.round(16*s)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText(ev.data.name, 0, 30);
    ctx.restore();
  }

  function drawBoss(ctx, ev){
    ctx.save();
    ctx.translate(ev.mx, ev.my);

    const s = clamp(cv.width / 1200, 0.92, 1.18);

    ctx.globalAlpha = 0.20;
    ctx.beginPath();
    ctx.arc(0, 0, 64*s, 0, Math.PI*2);
    ctx.fillStyle = 'rgba(255,90,90,0.75)';
    ctx.fill();

    ctx.globalAlpha = 0.98;
    ctx.font = `${Math.round(56*s)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(ev.boss.icon, 0, 0);

    ctx.globalAlpha = 0.80;
    ctx.fillStyle = 'rgba(255,255,255,0.90)';
    ctx.font = `${Math.round(18*s)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText(ev.boss.name, 0, 52*s/1.1);

    if (ev.phase >= 1 && ev.t < 1.25){
      ctx.globalAlpha = 0.28;
      ctx.beginPath();
      ctx.arc(0, 0, 86*s, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(255,255,255,0.35)';
      ctx.fill();
    }

    ctx.restore();
  }

  function drawMonster(ctx, ev){
    ctx.save();
    ctx.translate(ev.mx, ev.my);
    const s = clamp(cv.width / 1200, 0.9, 1.2);
    ctx.globalAlpha = 0.98;
    ctx.font = ev.rare ? `${Math.round(42*s)}px ui-sans-serif, system-ui, -apple-system` : `${Math.round(36*s)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(ev.monster.icon, 0, 0);

    ctx.globalAlpha = ev.rare ? 0.26 : 0.18;
    ctx.beginPath();
    ctx.arc(0, 0, (ev.rare ? 34 : 26) * s, 0, Math.PI*2);
    ctx.fillStyle = ev.rare ? 'rgba(255,215,90,0.65)' : (heroClass ? heroClass.main : 'rgba(255,255,255,0.6)');
    ctx.fill();

    if (ev.phase >= 1 && ev.t < 1.18){
      ctx.globalAlpha = 0.40;
      ctx.beginPath();
      ctx.arc(0, 0, (ev.rare ? 48 : 40) * s, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(255,255,255,0.35)';
      ctx.fill();
    }

    ctx.restore();
  }

  function drawItem(ctx, ev, x, y){
    ctx.save();
    ctx.translate(x, y);
    const it = ev.data;
    const s = clamp(cv.width / 1200, 0.9, 1.2);
    ctx.globalAlpha = 0.96;
    ctx.font = (it.rare ? Math.round(36*s) : Math.round(30*s)) + 'px ui-sans-serif, system-ui, -apple-system';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(it.icon, 0, 0);
    if (it.rare){
      ctx.globalAlpha = 0.22;
      ctx.beginPath();
      ctx.arc(0, 0, 34*s, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(255,215,90,0.75)';
      ctx.fill();
    }
    ctx.restore();
  }

  function drawParticlesWorld(ctx){
    for (const p of particles){
      ctx.save();
      ctx.translate(p.x, p.y);
      const a = clamp(p.life / 0.6, 0, 1);
      ctx.globalAlpha = 0.85 * a;

      if (p.kind === 'slash'){
        ctx.strokeStyle = p.color;
        ctx.lineWidth = 5;
        ctx.beginPath();
        ctx.moveTo(-18, -12);
        ctx.lineTo(18, 12);
        ctx.stroke();

      } else if (p.kind === 'spark'){
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(0, 0, 4, 0, Math.PI*2);
        ctx.fill();

      } else {
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(0, 0, 6, 0, Math.PI*2);
        ctx.fill();
      }

      ctx.restore();
    }
  }

  function drawHero(ctx, x, y, tilt, running, glow){
    // ãƒ‰ãƒƒãƒˆçµµã£ã½ã„å‹‡è€…ï¼ˆçŸ©å½¢ã®ã¿ã§ã‚·ãƒ«ã‚¨ãƒƒãƒˆå¼·åŒ–ï¼‰
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(tilt);

    const sizeBoost = clamp(cv.width / 1200, 0.92, 1.22);
    const s = 3.6 * sizeBoost;

    // shadow
    ctx.save();
    ctx.globalAlpha = 0.24;
    ctx.fillStyle = 'rgba(0,0,0,0.70)';
    ctx.beginPath();
    ctx.ellipse(0, 90*s/3.6, 48*s/3.6, 14*s/3.6, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();

    const main = heroClass ? heroClass.main : '#7cc9ff';
    const blade = equipped ? equipped.blade : 'rgba(255,255,255,0.85)';
    const accent = 'rgba(255,255,255,0.92)';
    const cape = 'rgba(255,120,120,0.92)';

    const px = (dx, dy, w, h, c, a=1) => {
      ctx.save();
      ctx.globalAlpha = a;
      ctx.fillStyle = c;
      ctx.fillRect(Math.round(dx*s), Math.round(dy*s), Math.round(w*s), Math.round(h*s));
      ctx.restore();
    };

    ctx.translate(-13*s, -30*s);

    const O = 'rgba(0,0,0,0.55)';
    const swing = running ? Math.sin(hero.step)*2.2 : 0;
    const leg = running ? Math.sin(hero.step+0.4)*2.4 : 0;

    // cape (å¾Œã‚ã«ãƒãƒ©ã¤ã)
    px(3, 18 + swing*0.15, 22, 18, cape, 0.78);
    px(5, 14 + swing*0.12, 18, 12, cape, 0.90);

    // head
    px(5, 0, 16, 11, O, 0.55);
    px(6, 1, 14, 9, 'rgba(255,255,255,0.94)');
    px(6, -2, 14, 4, main, 0.92);
    px(5, 3, 16, 3, main, 0.88);
    // highlight & eyes
    px(8, 3, 2, 2, 'rgba(0,0,0,0.75)');
    px(15, 3, 2, 2, 'rgba(0,0,0,0.75)');
    px(9, 6, 8, 2, 'rgba(0,0,0,0.18)');

    // body
    px(6, 11, 14, 11, main, 0.96);
    px(7, 22, 12, 5, accent, 0.92);
    px(7, 18, 12, 4, 'rgba(0,0,0,0.18)', 0.5);

    // belt & gem
    px(5, 24, 16, 2, 'rgba(0,0,0,0.6)', 0.7);
    px(11, 24, 4, 2, 'rgba(255,215,120,0.92)');

    // arms
    px(3, 12 + swing*0.6, 3, 10, accent);
    px(19, 12 - swing*0.6, 3, 10, accent);
    px(2, 16 + swing*0.6, 5, 3, 'rgba(0,0,0,0.35)', 0.6);
    px(18, 16 - swing*0.6, 5, 3, 'rgba(0,0,0,0.35)', 0.6);

    // legs + boots
    px(7, 27 + leg*0.10, 5, 9, accent);
    px(13, 27 - leg*0.12, 5, 9, accent);
    px(7, 34 + leg*0.1, 5, 3, 'rgba(0,0,0,0.45)');
    px(13, 34 - leg*0.12, 5, 3, 'rgba(0,0,0,0.45)');

    // weapon (å¤§ãã‚ã«)
    ctx.save();
    ctx.globalAlpha = 0.96;
    ctx.strokeStyle = blade;
    ctx.lineWidth = 4.2 * sizeBoost;
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(24*s, 18*s + swing*0.5*s);
    ctx.lineTo(36*s, 6*s + swing*0.2*s);
    ctx.stroke();
    ctx.restore();

    if (equipped && equipped.name === 'ã§ã‚“ã›ã¤ã®ã‘ã‚“'){
      ctx.save();
      ctx.globalAlpha = 0.30;
      ctx.strokeStyle = blade;
      ctx.lineWidth = 8.2 * sizeBoost;
      ctx.beginPath();
      ctx.moveTo(24*s, 18*s + swing*0.5*s);
      ctx.lineTo(36*s, 6*s + swing*0.2*s);
      ctx.stroke();
      ctx.restore();
    }

    if (hero.crown){
      px(8, -5, 8, 4, 'rgba(124,247,194,0.96)');
      px(8, -7, 2, 2, 'rgba(124,247,194,0.96)');
      px(14, -7, 2, 2, 'rgba(124,247,194,0.96)');
    }

    // outline glow
    if (glow > 0.1){
      ctx.save();
      ctx.globalAlpha = 0.16 + glow*0.18;
      ctx.strokeStyle = main;
      ctx.lineWidth = 6 * sizeBoost;
      ctx.strokeRect(3*s, -6*s, 22*s, 42*s);
      ctx.restore();
    }

    ctx.restore();
  }

  // ==============================
  // HUD + Result
  // ==============================
  function drawHUD(W, H, glow){
    const ui = clamp(W / 1180, 0.88, 1.20);
    const pad = 18 * ui;
    const w = Math.min(900, W - pad*2);
    const x = (W - w)/2;

    dqWindow(x, 16*ui, w, 136*ui, 22*ui, ui);

    ctx.fillStyle = 'rgba(255,255,255,0.96)';
    ctx.textAlign = 'left';
    ctx.font = `900 ${Math.round(22*ui)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText('ã¼ã†ã‘ã‚“', x + 20*ui, 46*ui);

    ctx.font = `750 ${Math.round(17*ui)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillStyle = 'rgba(255,255,255,0.92)';

    const cls = heroClass ? heroClass.name : 'ï¼Ÿï¼Ÿï¼Ÿ';
    const wpn = equipped ? `${equipped.icon}${equipped.name}` : 'ã¶ãï¼šãªã—';

    ctx.fillText(`ã—ã‚‡ããã‚‡ã†ï¼š${cls}  Lv${level}`, x + 20*ui, 74*ui);
    ctx.fillText(`${wpn}`, x + 20*ui, 98*ui);

    // HP/MP bars
    drawBar(x + 20*ui, 108*ui, 240*ui, 12*ui, hp / Math.max(1,maxHp), 'HP', ui);
    drawBar(x + 20*ui, 126*ui, 240*ui, 12*ui, mp / Math.max(1,maxMp), 'MP', ui);

    // right metrics
    ctx.textAlign = 'right';
    ctx.fillText(`ãã‚‡ã‚Š ${fmt(dist)}`, x + w - 20*ui, 54*ui);
    ctx.fillText(`ã¨ã†ã°ã¤ ${kills}  ãƒ¬ã‚¢${rareCount}`, x + w - 20*ui, 78*ui);
    ctx.fillText(`EXP ${xp}/${nextXp}`, x + w - 20*ui, 102*ui);

    // message window
    const msgH = 176 * ui;
    dqWindow(x, H - msgH - 18*ui, w, msgH, 20*ui, ui);

    ctx.textAlign = 'left';
    ctx.fillStyle = 'rgba(255,255,255,0.96)';
    ctx.font = `820 ${Math.round(19*ui)}px ui-sans-serif, system-ui, -apple-system`;

    const baseLine = (mode === MODE.RUN) ? 'â€¦' : 'ã‚¿ãƒƒãƒ— / ãƒœã‚¿ãƒ³ ã§ã¯ã˜ã‚ã‚‹';
    const line1 = msg.text || baseLine;

    wrapText(line1, x + 20*ui, H - msgH + 36*ui, w - 40*ui, 24*ui, 2);

    ctx.globalAlpha = 0.8;
    ctx.font = `700 ${Math.round(14*ui)}px ui-sans-serif, system-ui, -apple-system`;
    const recent = logLines.slice(-3);
    for (let i=0;i<recent.length;i++){
      ctx.fillText(recent[i], x + 20*ui, H - msgH + 88*ui + i*20*ui);
    }

    // simple command-like prompt
    const commands = ['â–¶ ã¤ã¥ã‘ã‚‹', 'ã€€ãã†ã³', 'ã€€ãã‚ã'];
    ctx.globalAlpha = 0.9;
    ctx.font = `800 ${Math.round(15*ui)}px ui-sans-serif, system-ui, -apple-system`;
    for (let i=0;i<commands.length;i++){
      ctx.fillText(commands[i], x + 22*ui + i*120*ui, H - msgH + msgH - 26*ui);
    }
    ctx.globalAlpha = 1;
  }

  function drawBar(x, y, w, h, ratio, label, ui=1){
    ratio = clamp(ratio, 0, 1);
    ctx.save();
    ctx.globalAlpha = 0.96;
    ctx.strokeStyle = 'rgba(255,255,255,0.92)';
    ctx.lineWidth = 1.4 * ui;
    ctx.strokeRect(x, y, w, h);

    const grad = ctx.createLinearGradient(x, y, x+w, y);
    grad.addColorStop(0, label === 'HP' ? 'rgba(124,247,194,0.80)' : 'rgba(124,201,255,0.78)');
    grad.addColorStop(1, 'rgba(255,255,255,0.40)');
    ctx.globalAlpha = 0.8;
    ctx.fillStyle = grad;
    ctx.fillRect(x+1, y+1, Math.max(0, (w-2)*ratio), h-2);

    ctx.globalAlpha = 0.95;
    ctx.fillStyle = 'rgba(255,255,255,0.88)';
    ctx.font = `700 ${Math.round(12*ui)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.textAlign = 'left';
    ctx.fillText(label, x + w + 10*ui, y + h);

    ctx.restore();
  }

  function drawCenterCard(W, H, glow, title, sub){
    const ui = clamp(W / 1160, 0.9, 1.2);
    const cw = Math.min(820, W - 120);
    const ch = 260 * ui;
    const cx = (W - cw)/2;
    const cy = (H - ch)/2 - 10*ui;

    dqWindow(cx, cy, cw, ch, 24*ui, ui);

    ctx.fillStyle = 'rgba(255,255,255,0.96)';
    ctx.textAlign = 'left';
    ctx.font = `950 ${Math.round(28*ui)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText(title, cx + 22*ui, cy + 64*ui);

    ctx.font = `750 ${Math.round(18*ui)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillStyle = 'rgba(255,255,255,0.86)';
    wrapText(sub, cx + 22*ui, cy + 106*ui, cw - 44*ui, 24*ui, 3);

    // mini ranking preview
    ctx.fillStyle = 'rgba(255,255,255,0.75)';
    ctx.font = `780 ${Math.round(16*ui)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚° Top3', cx + 22*ui, cy + ch - 74*ui);

    ctx.font = `650 ${Math.round(14*ui)}px ui-sans-serif, system-ui, -apple-system`;
    const top3 = ranking.slice(0,3);
    for (let i=0;i<top3.length;i++){
      const r = top3[i];
      ctx.fillText(`${i+1}. ${r.dist.toFixed(1)}m  ${r.cls} Lv${r.lv}`, cx + 22*ui, cy + ch - 52*ui + i*18*ui);
    }
  }

  function drawResultCard(W, H, glow){
    const ui = clamp(W / 1160, 0.9, 1.20);
    const cw = Math.min(920, W - 110);
    const ch = 440 * ui;
    const cx = (W - cw)/2;
    const cy = (H - ch)/2 - 6*ui;

    dqWindow(cx, cy, cw, ch, 26*ui, ui);

    ctx.fillStyle = 'rgba(255,255,255,0.96)';
    ctx.textAlign = 'left';
    ctx.font = `950 ${Math.round(28*ui)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText('ãƒªã‚¶ãƒ«ãƒˆ', cx + 24*ui, cy + 56*ui);

    // badges
    const badges = resultBadges.slice(0, 6);
    ctx.font = `800 ${Math.round(14*ui)}px ui-sans-serif, system-ui, -apple-system`;
    for (let i=0;i<badges.length;i++){
      const bx = cx + 22*ui + i*120*ui;
      const by = cy + 74*ui;
      ctx.save();
      ctx.fillStyle = i === 0 && lastIsBest ? 'rgba(255,215,120,0.95)' : 'rgba(124,247,194,0.90)';
      ctx.globalAlpha = 0.95;
      roundRect(ctx, bx, by, 108*ui, 30*ui, 12*ui);
      ctx.fill();
      ctx.strokeStyle = 'rgba(0,0,0,0.30)';
      ctx.stroke();
      ctx.fillStyle = 'rgba(0,0,0,0.72)';
      ctx.fillText(badges[i], bx + 10*ui, by + 20*ui);
      ctx.restore();
    }

    ctx.font = `820 ${Math.round(18*ui)}px ui-sans-serif, system-ui, -apple-system`;
    const cls = heroClass ? heroClass.name : 'ï¼Ÿï¼Ÿï¼Ÿ';
    const wpn = equipped ? `${equipped.icon}${equipped.name}` : 'ãªã—';

    ctx.fillStyle = 'rgba(255,255,255,0.92)';
    ctx.fillText(`ã—ã‚‡ããã‚‡ã†ï¼š${cls}  Lv${level}`, cx + 22*ui, cy + 116*ui);
    ctx.fillText(`ã—ã‚‡ã†ã”ã†ï¼š${title || 'â€”'}`, cx + 22*ui, cy + 144*ui);
    ctx.fillText(`ãã‚‡ã‚Šï¼š${fmt(dist)}`, cx + 22*ui, cy + 172*ui);
    ctx.fillText(`ã¨ã†ã°ã¤ï¼š${kills}ï¼ˆãƒ¬ã‚¢${rareCount}ï¼‰`, cx + 22*ui, cy + 200*ui);
    ctx.fillText(`ã¶ãï¼š${wpn}`, cx + 22*ui, cy + 228*ui);

    ctx.fillStyle = 'rgba(255,255,255,0.85)';
    const list = inventory.slice(0, 10).map(i => `${i.icon}${i.name}`).join(' / ');
    const more = inventory.length > 10 ? ` (+${inventory.length-10})` : '';
    wrapText(`ã«ã‚…ã†ã—ã‚…ï¼š${inventory.length ? (list + more) : 'ãªã—'}`, cx + 22*ui, cy + 256*ui, cw - 44*ui, 22*ui, 2);

    const lm = landmarksSeen.slice(0, 6).map(l => `${l.icon}${l.name}`).join(' / ');
    const lmMore = landmarksSeen.length > 6 ? ` (+${landmarksSeen.length-6})` : '';
    wrapText(`ã¡ã¦ã‚“ï¼š${landmarksSeen.length ? (lm + lmMore) : 'ãªã—'}`, cx + 22*ui, cy + 300*ui, cw - 44*ui, 22*ui, 2);

    ctx.fillStyle = 'rgba(255,255,255,0.85)';
    ctx.fillText(`ã¦ã‚“ã¨ã†ï¼š${lastCause || 'â€”'}`, cx + 22*ui, cy + 352*ui);

    // ranking Top5
    ctx.fillStyle = 'rgba(255,255,255,0.72)';
    ctx.font = `820 ${Math.round(16*ui)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚° Top5', cx + 22*ui, cy + 382*ui);

    ctx.font = `650 ${Math.round(14*ui)}px ui-sans-serif, system-ui, -apple-system`;
    const top5 = ranking.slice(0,5);
    for (let i=0;i<top5.length;i++){
      const r = top5[i];
      ctx.fillText(`${i+1}. ${r.dist.toFixed(1)}m  ${r.cls} Lv${r.lv}  ${r.title ? 'ã€Œ'+r.title+'ã€' : ''}`, cx + 22*ui, cy + 404*ui + i*18*ui);
    }

    ctx.fillStyle = 'rgba(255,255,255,0.70)';
    ctx.font = `680 ${Math.round(15*ui)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText('ä¸‹ã®ãƒœã‚¿ãƒ³ã§ å…±æœ‰ / ã‚³ãƒ”ãƒ¼ã§ãã¾ã™', cx + 22*ui, cy + ch - 22*ui);
  }

  // ==============================
  // DQ window primitives
  // ==============================
  function dqWindow(x, y, w, h, r=18, ui=1){
    ctx.save();
    const grad = ctx.createLinearGradient(x, y, x, y+h);
    grad.addColorStop(0, 'rgba(24,54,138,0.95)');
    grad.addColorStop(1, 'rgba(10,22,74,0.94)');

    ctx.shadowColor = 'rgba(0,0,0,0.45)';
    ctx.shadowBlur = 18 * ui;
    roundRect(ctx, x, y, w, h, r);
    ctx.fillStyle = grad;
    ctx.fill();

    ctx.shadowBlur = 0;
    ctx.lineWidth = 3 * ui;
    ctx.strokeStyle = 'rgba(255,255,255,0.94)';
    ctx.stroke();

    ctx.lineWidth = 2 * ui;
    ctx.strokeStyle = 'rgba(12,18,52,0.92)';
    roundRect(ctx, x + 4*ui, y + 4*ui, w - 8*ui, h - 8*ui, Math.max(10, r - 6));
    ctx.stroke();

    // highlight line
    ctx.globalAlpha = 0.55;
    ctx.beginPath();
    ctx.moveTo(x + r, y + 8*ui);
    ctx.lineTo(x + w - r, y + 8*ui);
    ctx.strokeStyle = 'rgba(255,255,255,0.38)';
    ctx.lineWidth = 1.8 * ui;
    ctx.stroke();
    ctx.globalAlpha = 1;

    ctx.restore();
  }

  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  function wrapText(text, x, y, maxWidth, lineHeight, maxLines){
    const chars = String(text).split('');
    let line = '';
    let lines = 0;
    for (let i=0;i<chars.length;i++){
      const test = line + chars[i];
      const w = ctx.measureText(test).width;
      if (w > maxWidth && line){
        ctx.fillText(line, x, y + lines*lineHeight);
        lines += 1;
        line = chars[i];
        if (lines >= maxLines) return;
      } else {
        line = test;
      }
    }
    ctx.fillText(line, x, y + lines*lineHeight);
  }

  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  // ==============================
  // Minimal self-tests (optional)
  // ==============================
  function assert(cond, msg){
    if (!cond) throw new Error('TEST FAIL: ' + msg);
  }

  function runSelfTests(){
    assert(typeof soundOn === 'boolean', 'soundOn is boolean');
    assert(typeof vibeOn === 'boolean', 'vibeOn is boolean');
    assert(typeof SFX.level === 'function', 'SFX.level exists');
    assert(typeof startWalkBGM === 'function', 'walkBGM exists');
    assert(groundY(0) > 0, 'groundY returns positive');
  }

  // init
  syncToggles();
  sync();
  showMsg('ã‚¿ãƒƒãƒ—ã—ã¦ ã¼ã†ã‘ã‚“', 1.0);

  // `#test` ã‚’ä»˜ã‘ã‚‹ã¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆé€šå¸¸ãƒ—ãƒ¬ã‚¤ã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ï¼‰
  if (location.hash === '#test'){
    runSelfTests();
    console.log('Self-tests passed');
  }
})();
</script>
</body>
</html>
