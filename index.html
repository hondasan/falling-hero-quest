<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ÂãáËÄÖ„ÅåÂãùÊâã„Å´Ëª¢„Å∂ÂÜíÈô∫</title>
  <style>
    :root{
      --bg0:#070b16;
      --text: rgba(255,255,255,.92);
      --r:18px;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html,body{
      height:100%; margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Meiryo", sans-serif;
      background: radial-gradient(1000px 700px at 20% 0%, #14245a 0%, var(--bg0) 60%, #050815 100%);
      color:var(--text);
    }
    .wrap{
      min-height:100%;
      display:flex;
      flex-direction:column;
      padding: max(10px, env(safe-area-inset-top)) 10px max(10px, env(safe-area-inset-bottom));
      gap:10px;
      align-items:center;
      justify-content:center;
    }
    .stage{width:min(980px, 100%); display:flex; flex-direction:column; gap:10px;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.07));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .canvasWrap{position:relative; padding:8px;}

    /* „Éú„Çø„É≥ÊéíÈô§Ôºö„Ç≠„É£„É≥„Éê„Çπ„ÇíÊúÄÂ§ßÂåñ */
    canvas{
      width:100%;
      height: min(92vh, 900px);
      display:block;
      border-radius: calc(var(--r) - 6px);
      background: linear-gradient(180deg, #0b1740 0%, #070f2a 60%, #050815 100%);
      border:1px solid rgba(255,255,255,.08);
      touch-action: manipulation;
    }
    @media (max-width: 560px){
      canvas{height: min(94vh, 940px);}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="stage">
      <div class="card canvasWrap">
        <canvas id="cv" aria-label="game canvas"></canvas>
      </div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  // =========================================================
  // DPRÂØæÂøúÔºàCanvasÂÜÖÈÉ®Ëß£ÂÉèÂ∫¶„ÇíÁ´ØÊú´„Å´Âêà„Çè„Åõ„ÄÅ‰ªÆÊÉ≥Ëß£ÂÉèÂ∫¶„ÅßÊèèÁîªÔºâ
  // =========================================================
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d', { alpha: true });

  const VW = 1600; // ‰ªÆÊÉ≥Ëß£ÂÉèÂ∫¶Ôºà„Ç≤„Éº„É†Â∫ßÊ®ôÁ≥ªÔºâ
  const VH = 900;

  let view = { scale: 1, ox: 0, oy: 0, dpr: 1 };

  function resizeCanvas(){
    const rect = cv.getBoundingClientRect();
    const dpr = Math.min(2, window.devicePixelRatio || 1);

    const pxW = Math.max(1, Math.floor(rect.width * dpr));
    const pxH = Math.max(1, Math.floor(rect.height * dpr));

    if (cv.width !== pxW || cv.height !== pxH){
      cv.width = pxW;
      cv.height = pxH;
    }

    const sx = pxW / VW;
    const sy = pxH / VH;
    const s = Math.min(sx, sy);

    const ox = (pxW - VW * s) * 0.5;
    const oy = (pxH - VH * s) * 0.5;

    view = { scale: s, ox, oy, dpr };
  }

  window.addEventListener('resize', resizeCanvas, {passive:true});
  window.addEventListener('orientationchange', () => setTimeout(resizeCanvas, 50), {passive:true});
  resizeCanvas();

  function toVirtualFromClient(clientX, clientY){
    const rect = cv.getBoundingClientRect();
    const dpr = view.dpr;
    const pxX = (clientX - rect.left) * dpr;
    const pxY = (clientY - rect.top)  * dpr;
    const vx = (pxX - view.ox) / view.scale;
    const vy = (pxY - view.oy) / view.scale;
    return { x: vx, y: vy };
  }

  function inRect(px, py, r){
    return px >= r.x && px <= r.x + r.w && py >= r.y && py <= r.y + r.h;
  }

  // =========================================================
  // Ë™øÊï¥„Éë„É©„É°„Éº„Çø
  // =========================================================
  const BASE_SPEED = 8.4;
  const SPEED_RAMP = 0.018;
  const FALL_RATE  = 0.0108;
  const BUMPINESS  = 0.98;
  const CAMERA_LAG = 0.09;
  const GRAVITY    = 34.0;
  const FALL_SHOW_SEC = 0.85;

  const ENCOUNTER_MIN = 520;
  const ENCOUNTER_MAX = 920;
  const ITEM_MIN = 460;
  const ITEM_MAX = 860;
  const LANDMARK_MIN = 820;
  const LANDMARK_MAX = 1500;

  const RARE_ENEMY_RATE = 0.08;
  const RARE_CHEST_RATE = 0.10;

  const BOSS_MIN_DIST = 170;   // m
  const BOSS_MAX_DIST = 260;   // m

  // =========================================================
  // „Éá„Éº„Çø
  // =========================================================
  const CLASSES = [
    { key:'hero',  name:'„ÇÜ„ÅÜ„Åó„ÇÉ',     main:'#7cc9ff', effect:'slash' },
    { key:'mage',  name:'„Åæ„Åª„ÅÜ„Å§„Åã„ÅÑ', main:'#c67cff', effect:'spell' },
    { key:'thief', name:'„Å®„ÅÜ„Åû„Åè',     main:'#7cf7c2', effect:'multi' },
    { key:'war',   name:'„Åõ„Çì„Åó',       main:'#ffb36b', effect:'heavy' },
  ];

  const MONSTERS = [
    { name:'„Çπ„É©„Ç§„É†',   icon:'üü¶', tone:560 },
    { name:'„Ç¥„Éº„Çπ„Éà',   icon:'üëª', tone:520 },
    { name:'„Ç¥„Éñ„É™„É≥',   icon:'üë∫', tone:480 },
    { name:'„Éâ„É©„Ç≠„Éº',   icon:'ü¶á', tone:620 },
    { name:'„Ç≠„É°„É©',     icon:'ü™Ω', tone:660 },
    { name:'„É°„Çø„É´Ôºü',   icon:'‚¨ú', tone:740 },
  ];

  const RARE_MONSTERS = [
    { name:'„Ç≠„É≥„Ç∞„Çπ„É©„Ç§„É†', icon:'üü™', tone:820 },
    { name:'„Ç¥„Éº„É´„Éá„É≥„Ç¥„Éñ„É™„É≥', icon:'üü®', tone:900 },
    { name:'„ÅÇ„ÇÑ„Åó„ÅÑÂΩ±', icon:'üü•', tone:860 },
  ];

  const WEAPONS = [
    { name:'„Å©„ÅÜ„ÅÆ„Å§„Çã„Åé', icon:'üó°Ô∏è', power:1, blade:'#d9b27b' },
    { name:'„Å¶„Å§„ÅÆ„ÇÑ„Çä',   icon:'üî±', power:2, blade:'#cfd8e3' },
    { name:'„Åé„Çì„ÅÆ„Å§„Çã„Åé', icon:'üó°Ô∏è', power:3, blade:'#e6f0ff' },
    { name:'„Åæ„Åª„ÅÜ„ÅÆ„Å§„Åà', icon:'ü™Ñ', power:2, blade:'#c67cff' },
    { name:'„Åß„Çì„Åõ„Å§„ÅÆ„Åë„Çì', icon:'üó°Ô∏è', power:5, blade:'#7cf7c2' },
  ];

  const LOOT = [
    { type:'loot', name:'„Åç„Çì„Åã', icon:'ü™ô' },
    { type:'loot', name:'„ÇÑ„Åè„Åù„ÅÜ', icon:'üåø' },
    { type:'loot', name:'„Åõ„ÅÑ„Åô„ÅÑ', icon:'üß¥' },
    { type:'loot', name:'„Å°„ÅÑ„Åï„Å™„É°„ÉÄ„É´', icon:'üü°' },
  ];

  const CHESTS = [
    { type:'chest', name:'„Åü„Åã„Çâ„Å∞„Åì', icon:'üß∞' },
    { type:'chest', name:'„ÅÇ„ÇÑ„Åó„ÅÑ„ÅØ„Åì', icon:'üì¶' },
  ];

  const RARE_CHESTS = [
    { type:'chest', name:'„Ç¥„Éº„É´„Éâ„Åü„Åã„Çâ„Å∞„Åì', icon:'üí∞' },
    { type:'chest', name:'„Éü„Éü„ÉÉ„ÇØÔºüÔºà„Åü„Å∂„ÇìÔºâ', icon:'üß≤' },
  ];

  const LANDMARKS = [
    { name:'Êùë', icon:'üèòÔ∏è', xp:8,  kind:'town' },
    { name:'ÂÆøÂ±ã', icon:'üõèÔ∏è', xp:10, kind:'inn' },
    { name:'Ê¥ûÁ™ü', icon:'üï≥Ô∏è', xp:12, kind:'cave' },
    { name:'Âüé', icon:'üè∞', xp:16, kind:'castle' },
    { name:'„Åª„Åì„Çâ', icon:'‚õ©Ô∏è', xp:10, kind:'shrine' },
    { name:'Ê©ã', icon:'üåâ', xp:9,  kind:'bridge' },
    { name:'Ê£Æ', icon:'üå≤', xp:11, kind:'forest' },
  ];

  const FALL_CAUSES = [
    '„ÅÑ„Åó„Å´„Å§„Åæ„Åö„ÅÑ„Åü',
    '„Åè„Å§„Å≤„ÇÇ„Åå„Åª„Å©„Åë„Åü',
    '„Åã„Åú„Åå„Å§„Çà„Åã„Å£„Åü',
    '„Åø„Åà„Å™„ÅÑ„Å†„Çì„Åï',
    '„Åò„ÇÖ„ÅÜ„Çä„Çá„Åè„Åå„Å§„Çà„ÅÑ',
    '„Åõ„Åã„ÅÑ„ÅÆ„ÅÑ„Åó',
    '„ÅÇ„Åó„Åå„Çè„Çâ„Å£„Åü',
    '„Åè„Åó„ÇÉ„Åø„Åß „Åæ„Åà„Åå„Åø„Åå „ÇÅ„Å´ „ÅØ„ÅÑ„Å£„Åü',
    '„Åø„Åø„Åã„Åç„Çí„Åó„Å™„Åå„Çâ „ÅØ„Åó„Å£„Åü',
  ];

  const BOSSES = [
    { name:'„Éâ„É©„Ç¥„É≥', icon:'üêâ', tone:220 },
    { name:'„Åæ„Åä„ÅÜÔºü', icon:'üòà', tone:196 },
    { name:'„ÇÆ„Ç¨„É≥„Éà', icon:'üóø', tone:174 },
  ];

  // =========================================================
  // LocalStorage
  // =========================================================
  const STORE_KEY_BEST = 'dqfall-best-v5';
  const STORE_KEY_DAILY_PREFIX = 'dqfall-daily-v5-';
  const STORE_KEY_RANKING = 'dqfall-ranking-v5';
  const STORE_KEY_SOUND = 'dqfall-sound-v5';
  const STORE_KEY_VIBE  = 'dqfall-vibe-v5';

  function todayKey(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function loadRanking(){
    try{
      const raw = localStorage.getItem(STORE_KEY_RANKING);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    } catch { return []; }
  }

  function saveRanking(arr){
    try{ localStorage.setItem(STORE_KEY_RANKING, JSON.stringify(arr)); } catch {}
  }

  let best = Number(localStorage.getItem(STORE_KEY_BEST) || '0');
  let dailyBest = Number(localStorage.getItem(STORE_KEY_DAILY_PREFIX + todayKey()) || '0');
  let ranking = loadRanking();

  // =========================================================
  // Audio / VibeÔºàUI„Éú„Çø„É≥ÁÑ°„Åó„ÄÇÂÜÖÈÉ®Ë®≠ÂÆö„ÅÆ„ÅøÔºâ
  // =========================================================
  let audioCtx = null;
  let soundOn = (localStorage.getItem(STORE_KEY_SOUND) ?? '1') === '1'; // „Éá„Éï„Ç©ON
  let vibeOn  = (localStorage.getItem(STORE_KEY_VIBE) ?? '0') === '1';  // „Éá„Éï„Ç©OFF

  let walkTimer = null;
  let walkStep = 0;

  function ensureAudio(){
    if (!soundOn) return;
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
  }

  function tone(seq, type='square'){
    if (!soundOn) return;
    ensureAudio();
    if (!audioCtx) return;
    let t = audioCtx.currentTime;
    for (const s of seq){
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.value = s.f;
      o.connect(g); g.connect(audioCtx.destination);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(s.v ?? 0.12, t + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t + s.d);
      o.start(t);
      o.stop(t + s.d + 0.02);
      t += s.d + (s.g ?? 0.02);
    }
  }

  const SFX = {
    start: () => tone([{f:330,d:0.07},{f:440,d:0.07},{f:660,d:0.10,g:0.04}]),
    msg:   () => tone([{f:880,d:0.04,v:0.09}]),
    approach: (f) => tone([{f, d:0.05, v:0.08},{f:f*0.8, d:0.05, v:0.08}], 'square'),
    hit:   () => tone([{f:220,d:0.05,v:0.12},{f:140,d:0.07,v:0.10}]),
    item:  () => tone([{f:784,d:0.06,v:0.10},{f:988,d:0.08,v:0.10}]),
    fall:  () => tone([{f:196,d:0.08,v:0.12},{f:110,d:0.14,v:0.10,g:0.04}]),
    best:  () => tone([{f:523,d:0.08,v:0.11},{f:659,d:0.08,v:0.11},{f:784,d:0.10,v:0.12,g:0.05}]),
    spell: () => tone([{f:988,d:0.05,v:0.10},{f:1318,d:0.06,v:0.10},{f:1760,d:0.08,v:0.10,g:0.04}], 'sine'),
    level: () => tone(
      [
        {f:523,d:0.09,v:0.11},{f:659,d:0.09,v:0.11},{f:784,d:0.10,v:0.12,g:0.03},
        {f:659,d:0.08,v:0.11},{f:784,d:0.08,v:0.12},{f:988,d:0.14,v:0.12,g:0.04},
        {f:1046,d:0.18,v:0.12,g:0.06},
      ],
      'triangle'
    ),
    rare:  () => tone([{f:988,d:0.06,v:0.10},{f:1318,d:0.06,v:0.10},{f:1760,d:0.10,v:0.11,g:0.04}], 'sawtooth'),
    inn: () => tone([{f:392,d:0.08,v:0.10},{f:494,d:0.10,v:0.10},{f:659,d:0.14,v:0.11,g:0.04}], 'triangle'),
    boss: () => tone([{f:220,d:0.10,v:0.11},{f:196,d:0.10,v:0.11},{f:174,d:0.14,v:0.11,g:0.05}], 'sawtooth'),
    cursor: () => tone([{f:988,d:0.03,v:0.07,g:0.01}]),
    select: () => tone([{f:659,d:0.04,v:0.09},{f:784,d:0.06,v:0.09,g:0.02}], 'square'),
  };

  function vibrate(pattern){
    if (!vibeOn) return;
    if (navigator.vibrate) navigator.vibrate(pattern);
  }

  function startWalkBGM(){
    stopWalkBGM();
    if (!soundOn) return;
    ensureAudio();
    const motif = [
      {f:392, d:0.05, v:0.06},
      {f:523, d:0.05, v:0.06},
      {f:659, d:0.06, v:0.06},
      {f:523, d:0.05, v:0.05},
      {f:440, d:0.06, v:0.05},
      {f:523, d:0.06, v:0.05},
    ];
    walkStep = 0;
    walkTimer = setInterval(() => {
      if (mode !== MODE.RUN || !soundOn) return;
      const foot = (walkStep % 2 === 0) ? 196 : 220;
      tone([{f:foot, d:0.03, v:0.035, g:0.0}], 'square');
      if ((walkStep % 6) === 0) tone(motif, 'triangle');
      walkStep++;
    }, 220);
  }
  function stopWalkBGM(){
    if (walkTimer){ clearInterval(walkTimer); walkTimer = null; }
  }

  // =========================================================
  // RNG
  // =========================================================
  let rng = mulberry32((Date.now() ^ (Math.random()*1e9)) >>> 0);
  function mulberry32(a){
    return function(){
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }

  // =========================================================
  // State
  // =========================================================
  const MODE = { READY:0, RUN:1, FALLING:2, RESULT:3 };
  let mode = MODE.READY;

  let dist = 0;
  let speed = 0;
  let camX = 0;

  let heroClass = null;
  let equipped = null;

  let level = 1;
  let xp = 0;
  let nextXp = 20;
  let hp = 18, maxHp = 18;
  let mp = 8,  maxMp = 8;

  let kills = 0;
  let inventory = [];
  let landmarksSeen = [];
  let rareCount = 0;

  let logLines = [];
  let lastCause = '';
  let title = '';

  let msg = { text:'', t:0, dur:0 };

  let nextEncounterX = 900;
  let nextItemX = 780;
  let nextLandmarkX = 1100;

  let bossDist = 220;
  let bossDone = false;

  let active = null;
  let particles = [];

  // „É°„Éã„É•„ÉºÔºàREADY/RESULT„ÅØDQÈ¢®„Äå„ÅØ„ÅÑÔºè„ÅÑ„ÅÑ„Åà„ÄçÔºâ
  // READY:  "„Åº„ÅÜ„Åë„Çì„Å´ „Åß„Åæ„Åô„ÅãÔºü" -> „ÅØ„ÅÑ=ÈñãÂßã „ÅÑ„ÅÑ„Åà=„Å™„Å´„ÇÇ„Åó„Å™„ÅÑ
  // RESULT: "„ÇÇ„ÅÜ„ÅÑ„Å°„Å© „Åü„Å≥„Å´„Åß„Åæ„Åô„ÅãÔºü" -> „ÅØ„ÅÑ=ÂÜçÈñã „ÅÑ„ÅÑ„Åà=READY„Å∏
  let menu = {
    open: true,
    cursor: 0, // 0:„ÅØ„ÅÑ 1:„ÅÑ„ÅÑ„Åà
    yesRect: {x:0,y:0,w:0,h:0},
    noRect: {x:0,y:0,w:0,h:0},
    winRect: {x:0,y:0,w:0,h:0},
  };

  const hero = {
    x:0, y:0, vy:0,
    tilt:0, rag:0, ragV:0,
    step:0,
    crown:false,
  };

  // =========================================================
  // Terrain
  // =========================================================
  function groundY(x){
    const a = 22 * BUMPINESS;
    const b = 12 * BUMPINESS;
    const c = 8  * BUMPINESS;
    return 520
      + Math.sin(x * 0.016) * a
      + Math.sin(x * 0.043 + 1.9) * b
      + Math.sin(x * 0.085 + 0.7) * c;
  }

  function groundSlope(x){
    const e = 2.0;
    return (groundY(x+e) - groundY(x-e)) / (2*e);
  }

  // =========================================================
  // UI helpers
  // =========================================================
  function fmt(m){ return (Math.max(0,m)).toFixed(1) + ' m'; }

  function pushLog(s){
    logLines.push(s);
    if (logLines.length > 18) logLines.shift();
  }

  function showMsg(text, dur=0.95){
    msg.text = text;
    msg.t = 0;
    msg.dur = dur;
    SFX.msg();
  }

  function addXP(amount, reason){
    xp += amount;
    if (reason) pushLog(`Ôºã${amount}EXPÔºà${reason}Ôºâ`);
    while (xp >= nextXp){
      xp -= nextXp;
      level += 1;
      nextXp = Math.floor(nextXp * 1.25 + 6);
      maxHp += 2;
      maxMp += 1;
      hp = Math.min(maxHp, hp + 3);
      mp = Math.min(maxMp, mp + 2);
      pushLog(`‚òÖ „É¨„Éô„É´„Åå ${level} „Å´ „ÅÇ„Åå„Å£„ÅüÔºÅ`);
      showMsg(`„É¨„Éô„É´„Åå ${level} „Å´ „ÅÇ„Åå„Å£„ÅüÔºÅ`, 1.2);
      SFX.level();
      vibrate([10, 30, 10]);
      spawnBurst(hero.x + 80, hero.y - 40, heroClass ? heroClass.main : 'rgba(255,255,255,0.9)');
    }
  }

  // =========================================================
  // ControlsÔºà„Éú„Çø„É≥ÁÑ°„ÅóÔºö„Ç≠„É£„É≥„Éê„Çπ„ÅÆ„Çø„ÉÉ„Éó„Å†„ÅëÔºâ
  // - RUN‰∏≠ÔºöÊìç‰Ωú‰∏çË¶Å
  // - READY/RESULTÔºöDQ„É°„Éã„É•„Éº„ÅÆ„Äå„ÅØ„ÅÑÔºè„ÅÑ„ÅÑ„Åà„Äç„Çí„Çø„ÉÉ„Éó
  // =========================================================
  cv.addEventListener('pointerdown', (e) => {
    ensureAudio(); // iOSÂØæÁ≠ñÔºö„É¶„Éº„Ç∂„ÉºÊìç‰ΩúÂÜÖ„ÅßAudioËß£Êîæ
    const v = toVirtualFromClient(e.clientX, e.clientY);

    if (mode === MODE.READY || mode === MODE.RESULT){
      if (menu.open){
        // „ÅØ„ÅÑÔºè„ÅÑ„ÅÑ„Åà„ÅÆÊû†„Å´„Çø„ÉÉ„Éó
        if (inRect(v.x, v.y, menu.yesRect)){
          menu.cursor = 0; SFX.cursor(); vibrate(8);
          selectMenu();
          return;
        }
        if (inRect(v.x, v.y, menu.noRect)){
          menu.cursor = 1; SFX.cursor(); vibrate(8);
          selectMenu();
          return;
        }

        // „É°„Éã„É•„ÉºÊû†ÂÜÖ„Å™„ÇâÂ∑¶Âè≥„Åß„Ç´„Éº„ÇΩ„É´ÁßªÂãïÔºàÈõë„Å´ÂàÜÂâ≤Ôºâ
        if (inRect(v.x, v.y, menu.winRect)){
          const mid = menu.winRect.x + menu.winRect.w/2;
          menu.cursor = (v.x < mid) ? 0 : 1;
          SFX.cursor();
          vibrate(6);
          return;
        }

        // Êû†Â§ñ„Çø„ÉÉ„Éó„ÅØREADY„Å™„Çâ„Äå„ÅØ„ÅÑ„Äç„Å∏ÂØÑ„Åõ„ÇãÔºàÈñãÂßãÂ∞éÁ∑ö„ÇíÂ§™„ÅèÔºâ
        if (mode === MODE.READY){
          menu.cursor = 0;
          selectMenu();
        }
        return;
      }
    }

    // READY‰ª•Â§ñ„ÅØÁâπ„Å´Êìç‰Ωú„Å™„Åó
  }, {passive:true});

  function selectMenu(){
    SFX.select();
    vibrate([10, 18, 10]);

    if (mode === MODE.READY){
      if (menu.cursor === 0){
        startRun();
      } else {
        showMsg('„Åæ„Åü „Åì„Çì„Å© „Åü„Å≥„Å´„Åß„Çà„ÅÜ', 1.1);
      }
    } else if (mode === MODE.RESULT){
      if (menu.cursor === 0){
        startRun(); // „ÇÇ„ÅÜ‰∏ÄÂõûÔºà„ÅØ„ÅÑÔºâ
      } else {
        stopWalkBGM();
        mode = MODE.READY;
        active = null;
        msg.text = '';
        msg.dur = 0;
        menu.open = true;
        menu.cursor = 0;
        showMsg('„Åæ„Åü „Åì„Çì„Å© „Åü„Å≥„Å´„Åß„Çà„ÅÜ', 1.1);
      }
    }
  }

  // =========================================================
  // Start / Fall / Result
  // =========================================================
  function startRun(){
    menu.open = false;

    mode = MODE.RUN;
    dist = 0;
    speed = BASE_SPEED;
    camX = 0;

    heroClass = CLASSES[Math.floor(rng()*CLASSES.length)];
    equipped = null;

    level = 1;
    xp = 0;
    nextXp = 20;
    maxHp = 18;
    maxMp = 8;
    hp = maxHp;
    mp = maxMp;

    hero.x = 0;
    hero.vy = 0;
    hero.tilt = 0;
    hero.rag = 0;
    hero.ragV = 0;
    hero.step = 0;
    hero.crown = false;

    kills = 0;
    inventory = [];
    landmarksSeen = [];
    rareCount = 0;

    logLines = [];
    lastCause = '';
    title = '';

    nextEncounterX = 680 + Math.floor(rng()*220);
    nextItemX = 520 + Math.floor(rng()*240);
    nextLandmarkX = 900 + Math.floor(rng()*380);

    bossDone = false;
    bossDist = BOSS_MIN_DIST + rng()*(BOSS_MAX_DIST - BOSS_MIN_DIST);

    active = null;
    particles = [];

    rng = mulberry32(((Date.now() + Math.floor(Math.random()*1e9)) ^ 0xC0FFEE) >>> 0);

    SFX.start();
    vibrate(18);
    if (soundOn) startWalkBGM();

    pushLog(`‚ñ∂ ${heroClass.name} „ÅØ „Åü„Å≥„Å´„Åß„ÅüÔºÅ`);
    showMsg(`${heroClass.name} „Å´ „Åç„Åæ„Çä„Åæ„Åó„Åü`, 1.1);
  }

  function startFalling(){
    mode = MODE.FALLING;

    hero.vy = -7 - rng()*9;
    hero.rag = hero.tilt;
    hero.ragV = (rng() < 0.5 ? -1 : 1) * (4 + rng()*7);

    lastCause = FALL_CAUSES[Math.floor(rng()*FALL_CAUSES.length)];
    pushLog(`‚ñº ${heroClass.name} „ÅØ ${lastCause}`);

    SFX.fall();
    vibrate([18, 30, 12]);

    active = { type:'fall', t:0 };
  }

  function computeTitle(){
    const d = dist;
    const k = kills;
    const inv = inventory.length;
    const lm = landmarksSeen.length;
    const w = equipped ? equipped.power : 0;

    if (rareCount >= 3) return '„É¨„Ç¢Áã©„Çä„Éû„Çπ„Çø„Éº';
    if (rareCount >= 1 && d < 70) return '„É¨„Ç¢„ÇíË¶ã„Å¶Ëª¢„Å∂ËÄÖ';
    if (level >= 6 && d < 90) return 'ËÇ≤„Å£„Å¶„ÇÇËª¢„Å∂';

    if (equipped && equipped.name === '„Åß„Çì„Åõ„Å§„ÅÆ„Åë„Çì' && d < 60) return '‰ºùË™¨„ÇíÊåÅ„Å£„Å¶Ëª¢„Å∂ËÄÖ';
    if (k >= 10 && d < 80) return 'Êà¶ÈóòÁãÇÔºàËª¢ÂÄíÔºâ';
    if (inv >= 12) return 'Êãæ„ÅÑÁâ©Âêç‰∫∫';
    if (lm >= 4 && d >= 120) return 'ÊóÖ„ÅÆË®òÈå≤ËÄÖ';

    if (d >= 280) return '‰∏ñÁïå„ÇíËµ∞Á†¥„Åó„Åü';
    if (d >= 210) return 'Ëª¢„Å∞„Å¨ÂãáËÄÖÔºà‰ªÆÔºâ';
    if (d >= 150) return 'Èãº„ÅÆË∂≥ËÖ∞';
    if (d >= 95)  return 'ÂÜíÈô∫ËÄÖË¶ãÁøí„ÅÑ';

    if (w >= 3) return 'Ë£ÖÂÇô„Å†„Åë„ÅØ‰∏ÄÊµÅ';
    if (k >= 3) return 'ÂàùÁ¥öË®é‰ºêÁéã';
    return 'Ëª¢ÂÄí„ÅÆÁ¥†Ë≥™';
  }

  function updateRanking(){
    const entry = {
      ts: Date.now(),
      dist: Number(dist.toFixed(1)),
      cls: heroClass ? heroClass.name : 'ÔºüÔºüÔºü',
      lv: level,
      title: title || '',
      kills,
      rare: rareCount,
    };

    ranking.push(entry);
    ranking.sort((a,b) => b.dist - a.dist);
    ranking = ranking.slice(0, 10);
    saveRanking(ranking);
  }

  function finalizeResult(){
    stopWalkBGM();
    mode = MODE.RESULT;

    title = computeTitle();

    let isBest = false;
    if (dist > best){
      best = dist;
      localStorage.setItem(STORE_KEY_BEST, String(best));
      isBest = true;
    }
    if (dist > dailyBest){
      dailyBest = dist;
      localStorage.setItem(STORE_KEY_DAILY_PREFIX + todayKey(), String(dailyBest));
    }

    updateRanking();

    if (isBest){
      SFX.best();
      vibrate([25, 40, 25]);
      pushLog('‚òÖ „Åï„ÅÑ„Åì„ÅÜ„Åç„Çç„ÅèÔºÅ');
      showMsg('„Åï„ÅÑ„Åì„ÅÜ„Åç„Çç„ÅèÔºÅ', 1.2);
    } else {
      showMsg('„Å§„Åé„ÅØ „ÅÑ„Åë„Çã', 1.0);
    }

    pushLog(`‚óÜ „Åó„Çá„ÅÜ„Åî„ÅÜÔºö${title}`);
    pushLog('‚ñ∂ „ÇÇ„ÅÜ„ÅÑ„Å°„Å© „Åü„Å≥„Å´„Åß„Åæ„Åô„ÅãÔºü');

    menu.open = true;
    menu.cursor = 0;
  }

  // =========================================================
  // Loop
  // =========================================================
  let lastT = performance.now();
  requestAnimationFrame(loop);

  function loop(now){
    const dt = Math.min(0.033, (now - lastT) / 1000);
    lastT = now;
    update(dt);
    render();
    requestAnimationFrame(loop);
  }

  function update(dt){
    if (msg.dur > 0){
      msg.t += dt;
      if (msg.t >= msg.dur){ msg.text = ''; msg.dur = 0; }
    }

    for (const p of particles){
      p.life -= dt;
      p.x += p.vx * dt;
      p.y += p.vy * dt;
      p.vy += 140 * dt;
    }
    particles = particles.filter(p => p.life > 0);

    if (mode === MODE.RUN){
      dist += speed * dt;
      speed += (SPEED_RAMP * dt) * (1 + dist * 0.0010);

      hero.x = dist * 40;
      hero.step += dt * (9.4 + speed*0.35);

      const gy = groundY(hero.x);
      hero.y = gy - 62;

      const slope = groundSlope(hero.x);
      const targetTilt = clamp(slope * 0.030, -0.40, 0.40);
      hero.tilt += (targetTilt - hero.tilt) * 0.14;

      const targetCam = hero.x - 320;
      camX += (targetCam - camX) * (1 - Math.pow(1 - CAMERA_LAG, dt * 60));

      if (rng() < 0.01 * dt * 60){
        hp = clamp(hp - (rng()<0.5?1:0), 0, maxHp);
        mp = clamp(mp - (rng()<0.35?1:0), 0, maxMp);
      }

      if (!active && !bossDone && dist >= bossDist){
        const b = BOSSES[Math.floor(rng()*BOSSES.length)];
        active = {
          type:'boss',
          t:0,
          phase:0,
          boss:b,
          mx: hero.x + 560,
          my: groundY(hero.x + 560) - 130,
        };
        bossDone = true;
        pushLog(`ÔºÅÔºÅ ${b.name} „Åå „ÅÇ„Çâ„Çè„Çå„Åü`);
        showMsg(`${b.name} „Åå „ÅÇ„Çâ„Çè„Çå„ÅüÔºÅ`, 1.1);
        SFX.boss();
        vibrate([18, 24, 18]);
      }

      if (!active && hero.x >= nextEncounterX){
        const isRare = rng() < RARE_ENEMY_RATE;
        const m = isRare ? RARE_MONSTERS[Math.floor(rng()*RARE_MONSTERS.length)] : MONSTERS[Math.floor(rng()*MONSTERS.length)];
        active = {
          type:'battle',
          t:0,
          phase:0,
          monster:m,
          rare:isRare,
          mx: hero.x + 520,
          my: groundY(hero.x + 520) - 110,
        };
        pushLog(`ÔºÅ ${m.name} „Åå „ÅÇ„Çâ„Çè„Çå„Åü` + (isRare ? 'Ôºà„É¨„Ç¢Ôºâ' : ''));
        showMsg(`${m.name} „Åå „ÅÇ„Çâ„Çè„Çå„Åü`, 1.0);
        if (isRare){ SFX.rare(); vibrate([12,18,12]); }
        else { SFX.approach(m.tone); vibrate(10); }

        nextEncounterX += ENCOUNTER_MIN + Math.floor(rng()*(ENCOUNTER_MAX-ENCOUNTER_MIN));
      }

      if (!active && hero.x >= nextItemX){
        const roll = rng();
        let it;
        if (roll < 0.30){
          const isRare = rng() < RARE_CHEST_RATE;
          it = isRare ? RARE_CHESTS[Math.floor(rng()*RARE_CHESTS.length)] : CHESTS[Math.floor(rng()*CHESTS.length)];
          it = { ...it, rare: isRare };
        } else if (roll < 0.62){
          it = WEAPONS[Math.floor(rng()*WEAPONS.length)];
        } else {
          it = LOOT[Math.floor(rng()*LOOT.length)];
        }

        active = { type:'item', t:0, data:it };

        if (it.type === 'loot'){
          inventory.push({ icon: it.icon, name: it.name, type: 'loot' });
          pushLog(`‚ô™ ${it.name} „Çí „Å¶„Å´„ÅÑ„Çå„Åü`);
          showMsg(`${it.name} „Çí „Å¶„Å´„ÅÑ„Çå„Åü`, 1.0);
          addXP(4 + Math.floor(rng()*3), '„Å≤„Çç„ÅÑ„ÇÇ„ÅÆ');
          hp = clamp(hp + (it.name==='„ÇÑ„Åè„Åù„ÅÜ'?3:0), 0, maxHp);
          mp = clamp(mp + (it.name==='„Åõ„ÅÑ„Åô„ÅÑ'?2:0), 0, maxMp);

        } else if (it.type === 'chest'){
          const rare = !!it.rare;
          inventory.push({ icon: it.icon, name: it.name, type: 'chest' });
          pushLog(`‚ô™ ${it.name} „Çí „Åø„Å§„Åë„Åü` + (rare ? 'Ôºà„É¨„Ç¢Ôºâ' : ''));
          showMsg(`${it.name} „Çí „Åø„Å§„Åë„Åü`, 1.0);
          if (rare){
            rareCount += 1;
            SFX.rare();
            vibrate([12,18,12]);
            addXP(14 + Math.floor(rng()*8), '„É¨„Ç¢„Åü„Åã„Çâ');
            spawnBurst(hero.x + 220, hero.y - 60, 'rgba(255,215,90,0.95)');
          } else {
            SFX.item();
            vibrate(12);
            addXP(9 + Math.floor(rng()*5), '„Åü„Åã„Çâ');
          }

        } else {
          equipped = it;
          inventory.push({ icon: it.icon, name: it.name, type: 'weapon' });
          pushLog(`‚ô™ ${it.name} „Çí „Åù„ÅÜ„Å≥„Åó„Åü`);
          showMsg(`${it.name} „Çí „Åù„ÅÜ„Å≥„Åó„Åü`, 1.0);
          SFX.item();
          vibrate(12);
          addXP(7 + it.power, '„Åù„ÅÜ„Å≥');
        }

        nextItemX += ITEM_MIN + Math.floor(rng()*(ITEM_MAX-LANDMARK_MIN)); // ÂæÆÂ¶ô„Å™ÂÅè„ÇäÈò≤Ê≠¢„ÅØÂæå„ÅßOK
        nextItemX = hero.x + ITEM_MIN + Math.floor(rng()*(ITEM_MAX-ITEM_MIN));
      }

      if (!active && hero.x >= nextLandmarkX){
        const lm = LANDMARKS[Math.floor(rng()*LANDMARKS.length)];
        active = { type:'landmark', t:0, data: lm, x: hero.x + 520, y: groundY(hero.x + 520) - 120 };
        landmarksSeen.push(lm);
        pushLog(`‚óÜ ${lm.name} „Å´ „Å®„ÅÜ„Å°„ÇÉ„Åè`);
        showMsg(`${lm.name} „Å´ „Å®„ÅÜ„Å°„ÇÉ„Åè`, 1.0);

        if (lm.kind === 'inn'){
          SFX.inn();
          vibrate([8, 12, 8]);
          hp = maxHp;
          mp = maxMp;
          addXP(lm.xp + 6, `„ÇÑ„Å©„ÇÑÔºà${lm.name}Ôºâ`);
          pushLog('‚óé HP/MP „Åå „Åã„ÅÑ„Åµ„Åè„Åó„Åü');
        } else {
          SFX.item();
          vibrate(10);
          addXP(lm.xp, `„Å°„Å¶„ÇìÔºà${lm.name}Ôºâ`);
          hp = clamp(hp + 2, 0, maxHp);
          mp = clamp(mp + 1, 0, maxMp);
        }

        nextLandmarkX = hero.x + LANDMARK_MIN + Math.floor(rng()*(LANDMARK_MAX-LANDMARK_MIN));
      }

      if (active){
        active.t += dt;

        if (active.type === 'battle' || active.type === 'boss'){
          const targetX = hero.x + 230;
          const approachSpeed = 520;
          if (active.mx > targetX) active.mx -= approachSpeed * dt;
        }

        if (active.type === 'battle'){
          if (active.t >= 0.65 && active.phase === 0){
            active.phase = 1;
            doAttackEffect(active);
          }

          if (active.t >= 1.10 && active.phase === 1){
            active.phase = 2;
            spawnPuff(active.mx, active.my, heroClass.main);
            SFX.hit();
            vibrate([10, 20, 10]);
            pushLog(`‚Üí ${active.monster.name} „Çí „Åü„Åä„Åó„Åü` + (active.rare ? 'Ôºà„É¨„Ç¢Ôºâ' : ''));
            kills += 1;
            addXP(active.rare ? (18 + Math.floor(rng()*10)) : (10 + Math.floor(rng()*6)), active.rare ? '„É¨„Ç¢Ë®é‰ºê' : 'Ë®é‰ºê');
            mp = clamp(mp - (heroClass.key==='mage' ? 2 : 1), 0, maxMp);
            hp = clamp(hp - (active.rare ? 2 : 1), 0, maxHp);

            if (active.rare){
              rareCount += 1;
              spawnBurst(active.mx, active.my - 10, 'rgba(255,215,90,0.95)');
            }
            showMsg(`${active.monster.name} „Çí „Åü„Åä„Åó„Åü`, 0.95);
          }

          if (active.t >= 1.35){
            active = null;
          }

        } else if (active.type === 'boss'){
          if (active.t >= 0.80 && active.phase === 0){
            active.phase = 1;
            doBossAttackEffect(active);
          }

          if (active.t >= 1.35 && active.phase === 1){
            active.phase = 2;
            spawnPuff(active.mx, active.my, 'rgba(255,255,255,0.9)');
            SFX.hit();
            vibrate([14, 22, 14]);
            pushLog(`‚Üí ${active.boss.name} „Çí „Åó„Çä„Åû„Åë„Åü`);
            addXP(22 + Math.floor(rng()*10), '„Éú„Çπ');
            hp = clamp(hp - 2, 0, maxHp);
            mp = clamp(mp - 1, 0, maxMp);
            spawnBurst(active.mx, active.my - 12, 'rgba(255,90,90,0.95)');
            showMsg(`${active.boss.name} „Çí „Åó„Çä„Åû„Åë„ÅüÔºÅ`, 1.0);
          }

          if (active.t >= 1.70){
            active = null;
          }

        } else if (active.type === 'item'){
          if (active.t >= 0.95) active = null;

        } else if (active.type === 'landmark'){
          if (active.t >= 1.05) active = null;
        }
      }

      const chaos = (rng() - 0.5) * 0.95;
      const slopeRisk = Math.abs(slope) / 30;
      const fatigue = dist * 0.00018;
      const p = FALL_RATE * (0.55 + slopeRisk + fatigue) * (1 + chaos);
      if (rng() < clamp(p, 0, 0.16) * dt * 60){
        startFalling();
      }

      if (best >= 180) hero.crown = true;

    } else if (mode === MODE.FALLING){
      if (active) active.t += dt;

      hero.vy += GRAVITY * dt;
      hero.y += hero.vy * 24 * dt;
      hero.rag += hero.ragV * dt;
      hero.ragV *= (1 - 0.9*dt);

      const gy = groundY(hero.x) - 42;
      if (hero.y > gy){
        hero.y = gy;
        hero.vy *= -0.35;
        hero.ragV *= 0.85;
        if (Math.abs(hero.vy) < 2.0) hero.vy = 0;
      }

      hero.x += 110 * dt;
      camX += ((hero.x - 320) - camX) * (1 - Math.pow(1 - CAMERA_LAG, dt * 60));

      if (active && active.t >= FALL_SHOW_SEC){
        finalizeResult();
      }

    } else {
      // READY/RESULTÔºömenuÈñã„Åè„Å†„Åë
      menu.open = true;
    }
  }

  // =========================================================
  // Attack Effects
  // =========================================================
  function doAttackEffect(ev){
    const cls = heroClass.effect;
    const mx = ev.mx;
    const my = ev.my;

    if (cls === 'spell'){
      for (let i=0;i<10;i++){
        const a = -0.2 + rng()*0.4;
        const sp = 520 + rng()*260;
        particles.push({ x:hero.x+70, y:hero.y-12, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp - 160, life:0.55 + rng()*0.25, kind:'spark', color:heroClass.main });
      }
      SFX.spell();
      vibrate(10);
      pushLog('Ôºä „Åæ„Åª„ÅÜÔºÅ');

    } else if (cls === 'multi'){
      for (let i=0;i<3;i++){
        particles.push({ x:mx - 30, y:my - 16 + i*14, vx:-80, vy:-40 + i*20, life:0.25, kind:'slash', color:'rgba(255,255,255,0.9)' });
      }
      SFX.hit();
      vibrate(12);
      pushLog('‚â° „Çå„Çì„Åí„Åç');

    } else if (cls === 'heavy'){
      spawnPuff(mx, my, 'rgba(255,255,255,0.9)');
      for (let i=0;i<8;i++){
        const a = rng()*Math.PI*2;
        const sp = 280 + rng()*260;
        particles.push({ x:mx, y:my, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp - 120, life:0.42 + rng()*0.22, kind:'spark', color:'rgba(255,255,255,0.85)' });
      }
      SFX.hit();
      vibrate([12, 18, 12]);
      pushLog('ÔºÅ „Å§„ÅÜ„Åì„Çì');

    } else {
      particles.push({ x:mx-28, y:my-10, vx:-120, vy:-40, life:0.28, kind:'slash', color:'rgba(255,255,255,0.9)' });
      SFX.hit();
      vibrate(12);
      pushLog('Ôºè „Åì„ÅÜ„Åí„Åç');
    }

    if (ev.rare){
      spawnBurst(mx, my - 10, 'rgba(255,215,90,0.95)');
    }
  }

  function doBossAttackEffect(ev){
    const mx = ev.mx;
    const my = ev.my;
    spawnBurst(mx, my - 12, 'rgba(255,90,90,0.95)');
    for (let i=0;i<10;i++){
      const a = rng()*Math.PI*2;
      const sp = 320 + rng()*360;
      particles.push({ x:mx, y:my, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp - 160, life:0.55 + rng()*0.28, kind:'spark', color:'rgba(255,90,90,0.85)' });
    }
    SFX.spell();
    vibrate([10, 18, 10]);
    pushLog('ÔºÅ „Å≤„Å£„Åï„Å§');
  }

  function spawnPuff(x,y,color){
    for (let i=0;i<10;i++){
      const a = rng()*Math.PI*2;
      const sp = 160 + rng()*220;
      particles.push({ x, y, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp - 120, life:0.35 + rng()*0.25, kind:'puff', color });
    }
  }

  function spawnBurst(x,y,color){
    for (let i=0;i<18;i++){
      const a = rng()*Math.PI*2;
      const sp = 220 + rng()*360;
      particles.push({ x, y, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp - 180, life:0.55 + rng()*0.30, kind:'spark', color });
    }
  }

  // =========================================================
  // RenderÔºà‰ªÆÊÉ≥Ëß£ÂÉèÂ∫¶VW√óVH„ÅßÊèèÁîªÔºâ
  // =========================================================
  function render(){
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,cv.width,cv.height);

    ctx.fillStyle = '#000000';
    ctx.fillRect(0,0,cv.width,cv.height);

    ctx.setTransform(view.scale, 0, 0, view.scale, view.ox, view.oy);

    const W = VW, H = VH;
    const glow = clamp(best / 220, 0, 1);

    // ËÉåÊôØ
    ctx.save();
    const bg = ctx.createLinearGradient(0,0,0,H);
    bg.addColorStop(0, '#06112a');
    bg.addColorStop(1, '#02040a');
    ctx.fillStyle = bg;
    ctx.fillRect(0,0,W,H);
    ctx.restore();

    // world
    ctx.save();
    ctx.translate(-camX, 0);

    // ground
    ctx.beginPath();
    const startX = camX - 120;
    const endX = camX + W + 120;
    ctx.moveTo(startX, H);
    for (let x = startX; x <= endX; x += 12){
      ctx.lineTo(x, groundY(x));
    }
    ctx.lineTo(endX, H);
    ctx.closePath();

    ctx.fillStyle = 'rgba(255,255,255,0.04)';
    ctx.fill();

    ctx.beginPath();
    for (let x = startX; x <= endX; x += 10){
      ctx.lineTo(x, groundY(x));
    }
    ctx.strokeStyle = 'rgba(255,255,255,0.10)';
    ctx.lineWidth = 2;
    ctx.stroke();

    if (active && active.type === 'landmark' && mode === MODE.RUN){
      drawLandmark(ctx, active);
    }

    if (active && mode === MODE.RUN){
      if (active.type === 'battle') drawMonster(ctx, active);
      if (active.type === 'boss') drawBoss(ctx, active);
    }

    if (active && active.type === 'item' && mode === MODE.RUN){
      drawItem(ctx, active, hero.x + 520, groundY(hero.x + 520) - 120);
    }

    const running = (mode === MODE.RUN);
    const ang = running ? hero.tilt : (hero.rag + 1.1);
    drawHeroDQ(ctx, hero.x, hero.y, ang, running, glow);

    drawParticlesWorld(ctx);
    ctx.restore();

    drawHUD(W, H, glow);

    if (mode === MODE.READY){
      drawMenuWindow(W, H, '„Åº„ÅÜ„Åë„Çì„Å´ „Åß„Åæ„Åô„ÅãÔºü');
    } else if (mode === MODE.RESULT){
      drawResultCard(W, H, glow);
      drawMenuWindow(W, H, '„ÇÇ„ÅÜ„ÅÑ„Å°„Å© „Åü„Å≥„Å´„Åß„Åæ„Åô„ÅãÔºü');
    }
  }

  // =========================================================
  // DQ Window (ÁôΩÊû†√óÈªíËÉåÊôØ√óÁôΩÊñáÂ≠ó)
  // =========================================================
  function dqWindow(x, y, w, h, r=6){
    ctx.save();
    roundRect(ctx, x, y, w, h, r);
    ctx.fillStyle = '#ffffff';
    ctx.fill();

    roundRect(ctx, x+4, y+4, w-8, h-8, Math.max(2, r-2));
    ctx.fillStyle = '#000000';
    ctx.fill();

    roundRect(ctx, x+6, y+6, w-12, h-12, Math.max(2, r-2));
    ctx.strokeStyle = 'rgba(255,255,255,0.22)';
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.restore();
  }

  // =========================================================
  // Draw helpers (world)
  // =========================================================
  function drawLandmark(ctx, ev){
    ctx.save();
    ctx.translate(ev.x, ev.y);
    ctx.globalAlpha = 0.98;
    ctx.font = '28px ui-sans-serif, system-ui, -apple-system';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(ev.data.icon, 0, 0);
    ctx.globalAlpha = 0.85;
    ctx.fillStyle = '#ffffff';
    ctx.font = '16px ui-sans-serif, system-ui, -apple-system';
    ctx.fillText(ev.data.name, 0, 32);
    ctx.restore();
  }

  function drawBoss(ctx, ev){
    ctx.save();
    ctx.translate(ev.mx, ev.my);

    ctx.globalAlpha = 0.22;
    ctx.beginPath();
    ctx.arc(0, 0, 72, 0, Math.PI*2);
    ctx.fillStyle = 'rgba(255,90,90,0.55)';
    ctx.fill();

    ctx.globalAlpha = 1;
    ctx.font = '54px ui-sans-serif, system-ui, -apple-system';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillStyle = '#ffffff';
    ctx.fillText(ev.boss.icon, 0, 0);

    ctx.globalAlpha = 0.92;
    ctx.font = '18px ui-sans-serif, system-ui, -apple-system';
    ctx.fillText(ev.boss.name, 0, 52);

    if (ev.phase >= 1 && ev.t < 1.25){
      ctx.globalAlpha = 0.28;
      ctx.beginPath();
      ctx.arc(0, 0, 92, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(255,255,255,0.25)';
      ctx.fill();
    }

    ctx.restore();
  }

  function drawMonster(ctx, ev){
    ctx.save();
    ctx.translate(ev.mx, ev.my);
    ctx.globalAlpha = 1;
    ctx.font = ev.rare ? '42px ui-sans-serif, system-ui, -apple-system' : '36px ui-sans-serif, system-ui, -apple-system';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillStyle = '#ffffff';
    ctx.fillText(ev.monster.icon, 0, 0);

    ctx.globalAlpha = ev.rare ? 0.28 : 0.18;
    ctx.beginPath();
    ctx.arc(0, 0, ev.rare ? 36 : 28, 0, Math.PI*2);
    ctx.fillStyle = ev.rare ? 'rgba(255,215,90,0.65)' : (heroClass ? heroClass.main : 'rgba(255,255,255,0.6)');
    ctx.fill();

    ctx.restore();
  }

  function drawItem(ctx, ev, x, y){
    ctx.save();
    ctx.translate(x, y);
    const it = ev.data;
    ctx.globalAlpha = 1;
    ctx.font = (it.rare ? 34 : 28) + 'px ui-sans-serif, system-ui, -apple-system';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillStyle = '#ffffff';
    ctx.fillText(it.icon, 0, 0);
    if (it.rare){
      ctx.globalAlpha = 0.22;
      ctx.beginPath();
      ctx.arc(0, 0, 34, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(255,215,90,0.75)';
      ctx.fill();
    }
    ctx.restore();
  }

  function drawParticlesWorld(ctx){
    for (const p of particles){
      ctx.save();
      ctx.translate(p.x, p.y);
      const a = clamp(p.life / 0.6, 0, 1);
      ctx.globalAlpha = 0.85 * a;

      if (p.kind === 'slash'){
        ctx.strokeStyle = p.color;
        ctx.lineWidth = 5;
        ctx.beginPath();
        ctx.moveTo(-18, -12);
        ctx.lineTo(18, 12);
        ctx.stroke();

      } else if (p.kind === 'spark'){
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(0, 0, 4, 0, Math.PI*2);
        ctx.fill();

      } else {
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(0, 0, 6, 0, Math.PI*2);
        ctx.fill();
      }
      ctx.restore();
    }
  }

  // =========================================================
  // HeroÔºà‰∏ÄËà¨ÁöÑRPGÂãáËÄÖÂØÑ„ÅõÔºöÂÖú/Áõæ/„Éû„É≥„Éà/Ââ£„ÄÅ‰∫åÈ†≠Ë∫´„Éî„ÇØ„Çª„É´È¢®Ôºâ
  // =========================================================
  function drawHeroDQ(ctx, x, y, tilt, running, glow){
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(tilt);

    // shadow
    ctx.save();
    ctx.globalAlpha = 0.25;
    ctx.fillStyle = 'rgba(0,0,0,0.75)';
    ctx.beginPath();
    ctx.ellipse(0, 84, 50, 14, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();

    const main = heroClass ? heroClass.main : '#7cc9ff';
    const blade = equipped ? equipped.blade : 'rgba(255,255,255,0.85)';

    const s = 3.8;
    const px = (dx, dy, w, h, c, a=1) => {
      ctx.save();
      ctx.globalAlpha = a;
      ctx.fillStyle = c;
      ctx.fillRect(Math.round(dx*s), Math.round(dy*s), Math.round(w*s), Math.round(h*s));
      ctx.restore();
    };

    ctx.translate(-14*s, -28*s);

    const O = 'rgba(0,0,0,0.65)';
    const swing = running ? Math.sin(hero.step)*1.9 : 0;
    const leg = running ? Math.sin(hero.step)*2.1 : 0;

    // „Éû„É≥„Éà
    px(5, 10 + swing*0.2, 14, 20, O, 0.28);
    px(4, 11 + swing*0.2, 16, 22, 'rgba(10,35,120,0.92)', 1);
    px(4, 18 + swing*0.2, 16, 4, 'rgba(140,20,40,0.35)', 1);

    // „Åã„Å∂„Å®
    px(6, 0, 14, 12, O, 0.50);
    px(7, 1, 12, 10, 'rgba(230,240,255,0.95)');
    px(7, 1, 12, 3, 'rgba(190,210,235,0.95)');
    px(12, 0, 2, 2, 'rgba(255,215,90,0.95)', 1);

    // È°î
    px(8, 4, 10, 7, 'rgba(255,235,220,0.92)');
    px(11, 7, 2, 2, 'rgba(0,0,0,0.85)');
    px(15, 7, 2, 2, 'rgba(0,0,0,0.85)');

    // „Çà„Çç„ÅÑ
    px(7, 12, 12, 12, O, 0.18);
    px(8, 12, 10, 12, main, 1);
    px(8, 16, 10, 1, 'rgba(255,255,255,0.22)', 1);
    px(8, 20, 10, 2, 'rgba(255,255,255,0.85)', 1);
    px(11, 20, 4, 2, 'rgba(255,215,90,0.90)', 1);

    // „ÅÜ„Åß
    px(4, 13 + swing*0.5, 3, 10, 'rgba(240,248,255,0.92)');
    px(19, 13 - swing*0.5, 3, 10, 'rgba(240,248,255,0.92)');
    px(4, 22 + swing*0.5, 3, 2, 'rgba(0,0,0,0.32)');
    px(19, 22 - swing*0.5, 3, 2, 'rgba(0,0,0,0.32)');

    // „Åü„Å¶
    ctx.save();
    ctx.globalAlpha = 0.95;
    const shX = 2*s, shY = (16 + swing*0.35)*s;
    ctx.translate(shX, shY);
    ctx.rotate(-0.08);
    ctx.fillStyle = 'rgba(0,0,0,0.35)';
    ctx.fillRect(0, 0, 10*s, 12*s);
    ctx.fillStyle = 'rgba(40,120,210,0.92)';
    ctx.fillRect(0.8*s, 0.8*s, 8.4*s, 10.4*s);
    ctx.fillStyle = 'rgba(255,255,255,0.18)';
    ctx.fillRect(1.2*s, 1.2*s, 2.0*s, 9.6*s);
    ctx.fillStyle = 'rgba(255,215,90,0.80)';
    ctx.fillRect(4.3*s, 5.2*s, 1.4*s, 1.4*s);
    ctx.restore();

    // „ÅÇ„Åó
    px(9, 24, 5, 10, 'rgba(245,250,255,0.92)');
    px(14, 24 + leg*0.2, 5, 10, 'rgba(245,250,255,0.92)');
    px(9, 32, 5, 3, 'rgba(0,0,0,0.32)');
    px(14, 32 + leg*0.2, 5, 3, 'rgba(0,0,0,0.32)');

    // „Åë„Çì
    ctx.save();
    ctx.globalAlpha = 0.95;
    ctx.strokeStyle = blade;
    ctx.lineWidth = 4.4;
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(24*s, (18 + swing*0.2)*s);
    ctx.lineTo(40*s, (6 - swing*0.2)*s);
    ctx.stroke();
    ctx.globalAlpha = (equipped && equipped.name === '„Åß„Çì„Åõ„Å§„ÅÆ„Åë„Çì') ? 0.28 : 0.10;
    ctx.lineWidth = 10.0;
    ctx.beginPath();
    ctx.moveTo(24*s, (18 + swing*0.2)*s);
    ctx.lineTo(40*s, (6 - swing*0.2)*s);
    ctx.stroke();
    ctx.restore();

    // „Åã„Çì„ÇÄ„Çä
    if (hero.crown){
      px(10, -5, 7, 3, 'rgba(255,215,90,0.95)');
      px(10, -7, 2, 2, 'rgba(255,215,90,0.95)');
      px(15, -7, 2, 2, 'rgba(255,215,90,0.95)');
    }

    ctx.restore();
  }

  // =========================================================
  // HUD / Result / Menu
  // =========================================================
  function eventLine(){
    if (mode === MODE.RUN && active){
      if (active.type === 'battle') return `${active.monster.name} „Åå „ÅÇ„Çâ„Çè„Çå„Åü`;
      if (active.type === 'boss') return `${active.boss.name} „Åå „ÅÇ„Çâ„Çè„Çå„ÅüÔºÅ`;
      if (active.type === 'item'){
        const it = active.data;
        if (it.type === 'chest') return `${it.name} „Çí „Åø„Å§„Åë„Åü`;
        if (it.type === 'loot') return `${it.name} „Çí „Å¶„Å´„ÅÑ„Çå„Åü`;
        return `${it.name} „Çí „Åù„ÅÜ„Å≥„Åó„Åü`;
      }
      if (active.type === 'landmark') return `${active.data.name} „Å´ „Å®„ÅÜ„Å°„ÇÉ„Åè`;
      if (active.type === 'fall') return `„Åì„Çç„Çì„Å†ÔºÅ`;
    }
    if (mode === MODE.FALLING) return `„Åì„Çç„Çì„Å†ÔºÅ`;
    if (mode === MODE.RESULT) return `„ÇÇ„ÅÜ„ÅÑ„Å°„Å© „Åü„Å≥„Å´„Åß„Åæ„Åô„ÅãÔºü`;
    return `„Åº„ÅÜ„Åë„Çì„Å´ „Åß„Åæ„Åô„ÅãÔºü`;
  }

  function drawHUD(W, H, glow){
    const pad = 18;
    const w = Math.min(920, W - pad*2);
    const x = (W - w)/2;

    // top window
    dqWindow(x, 14, w, 134);

    ctx.fillStyle = '#ffffff';
    ctx.textAlign = 'left';

    ctx.font = `900 22px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText('„Åº„ÅÜ„Åë„Çì', x + 18, 48);

    ctx.font = `800 18px ui-sans-serif, system-ui, -apple-system`;
    const cls = heroClass ? heroClass.name : 'ÔºüÔºüÔºü';
    const wpn = equipped ? `${equipped.icon}${equipped.name}` : '„Å∂„ÅçÔºö„Å™„Åó';
    ctx.fillText(`„Åó„Çá„Åè„Åé„Çá„ÅÜÔºö${cls}  Lv${level}`, x + 18, 78);
    ctx.fillText(`${wpn}`, x + 18, 104);

    // right metrics
    ctx.textAlign = 'right';
    ctx.font = `900 22px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText(`„Åç„Çá„Çä ${fmt(dist)}`, x + w - 18, 54);

    ctx.font = `800 18px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText(`„Å®„ÅÜ„Å∞„Å§ ${kills}  „É¨„Ç¢${rareCount}`, x + w - 18, 86);
    ctx.fillText(`EXP ${xp}/${nextXp}`, x + w - 18, 112);

    // HP/MP
    const barX = x + 18;
    const barY = 118;
    drawBar(barX, barY, 230, 12, hp / Math.max(1,maxHp), 'HP');
    drawBar(barX, barY + 18, 230, 12, mp / Math.max(1,maxMp), 'MP');

    // message window
    const msgH = 190;
    dqWindow(x, H - msgH - 18, w, msgH);

    ctx.textAlign = 'left';
    ctx.fillStyle = '#ffffff';

    const line1 = msg.text || eventLine();
    ctx.font = `900 26px ui-sans-serif, system-ui, -apple-system`;
    wrapText(line1, x + 18, H - msgH + 30, w - 36, 30, 2);

    ctx.font = `700 16px ui-sans-serif, system-ui, -apple-system`;
    const recent = logLines.slice(-4);
    for (let i=0;i<recent.length;i++){
      ctx.fillText(recent[i], x + 18, H - 70 + i*20);
    }
  }

  function drawBar(x, y, w, h, ratio, label){
    ratio = clamp(ratio, 0, 1);
    ctx.save();

    ctx.fillStyle = '#ffffff';
    ctx.fillRect(x, y, w, h);

    ctx.fillStyle = '#000000';
    ctx.fillRect(x+2, y+2, w-4, h-4);

    ctx.fillStyle = (label === 'HP') ? 'rgba(124,247,194,0.85)' : 'rgba(124,201,255,0.85)';
    ctx.fillRect(x+3, y+3, Math.max(0, (w-6)*ratio), h-6);

    ctx.fillStyle = '#ffffff';
    ctx.font = `800 14px ui-sans-serif, system-ui, -apple-system`;
    ctx.textAlign = 'left';
    ctx.fillText(label, x + w + 10, y + h - 1);

    ctx.restore();
  }

  function drawResultCard(W, H, glow){
    const cw = Math.min(940, W - 100);
    const ch = 520;
    const cx = (W - cw)/2;
    const cy = (H - ch)/2 - 6;

    dqWindow(cx, cy, cw, ch);

    ctx.fillStyle = '#ffffff';
    ctx.textAlign = 'left';

    ctx.font = `950 30px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText('„É™„Ç∂„É´„Éà', cx + 22, cy + 58);

    ctx.textAlign = 'right';
    ctx.font = `950 34px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText(`${fmt(dist)}`, cx + cw - 22, cy + 58);

    ctx.textAlign = 'left';
    ctx.font = `850 18px ui-sans-serif, system-ui, -apple-system`;
    const cls = heroClass ? heroClass.name : 'ÔºüÔºüÔºü';
    const wpn = equipped ? `${equipped.icon}${equipped.name}` : '„Å™„Åó';

    ctx.fillText(`„Åó„Çá„Åè„Åé„Çá„ÅÜÔºö${cls}  Lv${level}`, cx + 22, cy + 102);
    ctx.fillText(`„Åó„Çá„ÅÜ„Åî„ÅÜÔºö${title || '‚Äî'}`, cx + 22, cy + 130);
    ctx.fillText(`„Å®„ÅÜ„Å∞„Å§Ôºö${kills}Ôºà„É¨„Ç¢${rareCount}Ôºâ`, cx + 22, cy + 158);
    ctx.fillText(`„Å∂„ÅçÔºö${wpn}`, cx + 22, cy + 186);

    ctx.font = `950 26px ui-sans-serif, system-ui, -apple-system`;
    wrapText(`„Åó„Å´„Åã„ÅüÔºö${lastCause || '‚Äî'}`, cx + 22, cy + 238, cw - 44, 30, 2);

    ctx.font = `800 16px ui-sans-serif, system-ui, -apple-system`;
    const list = inventory.slice(0, 10).map(i => `${i.icon}${i.name}`).join(' / ');
    const more = inventory.length > 10 ? ` (+${inventory.length-10})` : '';
    wrapText(`„Å´„ÇÖ„ÅÜ„Åó„ÇÖÔºö${inventory.length ? (list + more) : '„Å™„Åó'}`, cx + 22, cy + 304, cw - 44, 22, 2);

    const lm = landmarksSeen.slice(0, 6).map(l => `${l.icon}${l.name}`).join(' / ');
    const lmMore = landmarksSeen.length > 6 ? ` (+${landmarksSeen.length-6})` : '';
    wrapText(`„Å°„Å¶„ÇìÔºö${landmarksSeen.length ? (lm + lmMore) : '„Å™„Åó'}`, cx + 22, cy + 356, cw - 44, 22, 2);
  }

  function drawMenuWindow(W, H, promptText){
    // Âè≥‰∏ã„Å´DQÈ¢®Â∞èÁ™ì„Åß„Äå„ÅØ„ÅÑÔºè„ÅÑ„ÅÑ„Åà„Äç
    const w = 340;
    const h = 180;
    const x = W - w - 26;
    const y = H - h - 220;

    menu.winRect = { x, y, w, h };

    dqWindow(x, y, w, h);

    ctx.fillStyle = '#ffffff';
    ctx.textAlign = 'left';
    ctx.font = `900 18px ui-sans-serif, system-ui, -apple-system`;
    wrapText(promptText, x + 18, y + 34, w - 36, 22, 2);

    // „Éú„Çø„É≥È†òÂüüÔºàÊèèÁîªÔºãÂΩì„Åü„ÇäÂà§ÂÆöÔºâ
    const bx = x + 18;
    const by = y + 92;
    const bw = (w - 18*2 - 12) / 2;
    const bh = 58;

    const yesR = { x: bx, y: by, w: bw, h: bh };
    const noR  = { x: bx + bw + 12, y: by, w: bw, h: bh };
    menu.yesRect = yesR;
    menu.noRect = noR;

    // „Éú„Çø„É≥Êû†
    drawDQButton(yesR, '„ÅØ„ÅÑ', menu.cursor === 0);
    drawDQButton(noR,  '„ÅÑ„ÅÑ„Åà', menu.cursor === 1);

    // „Ç´„Éº„ÇΩ„É´ÔºàDQ„Å£„ÅΩ„ÅÑ‰∏âËßíÔºâ
    ctx.save();
    ctx.fillStyle = '#ffffff';
    const cx = (menu.cursor === 0 ? yesR.x : noR.x) - 12;
    const cy = (menu.cursor === 0 ? yesR.y : noR.y) + yesR.h/2;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(cx + 10, cy - 7);
    ctx.lineTo(cx + 10, cy + 7);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  function drawDQButton(r, label, selected){
    ctx.save();
    // ÁôΩÊû†ÔºàÂ∞ë„ÅóÂº∑Ë™øÔºâ
    ctx.fillStyle = '#ffffff';
    roundRect(ctx, r.x, r.y, r.w, r.h, 10);
    ctx.fill();

    // ÈªíËÉåÊôØ
    ctx.fillStyle = '#000000';
    roundRect(ctx, r.x+4, r.y+4, r.w-8, r.h-8, 8);
    ctx.fill();

    // ÈÅ∏Êäû‰∏≠„Éè„Ç§„É©„Ç§„Éà
    if (selected){
      ctx.globalAlpha = 0.18;
      ctx.fillStyle = '#ffffff';
      roundRect(ctx, r.x+6, r.y+6, r.w-12, r.h-12, 8);
      ctx.fill();
      ctx.globalAlpha = 1;
    }

    // „É©„Éô„É´
    ctx.fillStyle = '#ffffff';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.font = `950 22px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText(label, r.x + r.w/2, r.y + r.h/2 + 1);

    ctx.restore();
  }

  // =========================================================
  // Primitives
  // =========================================================
  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  function wrapText(text, x, y, maxWidth, lineHeight, maxLines){
    const chars = String(text).split('');
    let line = '';
    let lines = 0;
    for (let i=0;i<chars.length;i++){
      const test = line + chars[i];
      const w = ctx.measureText(test).width;
      if (w > maxWidth && line){
        ctx.fillText(line, x, y + lines*lineHeight);
        lines += 1;
        line = chars[i];
        if (lines >= maxLines) return;
      } else {
        line = test;
      }
    }
    ctx.fillText(line, x, y + lines*lineHeight);
  }

  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  // =========================================================
  // init
  // =========================================================
  menu.open = true;
  menu.cursor = 0;
  showMsg('„Åº„ÅÜ„Åë„Çì„Å´ „Åß„Åæ„Åô„ÅãÔºü', 1.0);

})();
</script>
</body>
</html>
