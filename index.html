<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>å‹‡è€…ãŒå‹æ‰‹ã«è»¢ã¶å†’é™º</title>
  <style>
    :root{
      --bg0:#050815;
      --text: rgba(255,255,255,.92);
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html,body{
      height:100%;
      margin:0;
      overflow:hidden;           /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ */
      background: radial-gradient(1000px 700px at 20% 0%, #14245a 0%, var(--bg0) 60%, #02040a 100%);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Meiryo", sans-serif;
    }

    /* ç”»é¢å…¨é¢ã‚­ãƒ£ãƒ³ãƒã‚¹ */
    #cv{
      position:fixed;
      inset:0;
      width:100vw;
      height:100svh; /* iOSã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å¯¾ç­– */
      display:block;
      background: linear-gradient(180deg, #0b1740 0%, #070f2a 60%, #050815 100%);
      touch-action: manipulation;
    }
  </style>
</head>
<body>
<canvas id="cv" aria-label="game canvas"></canvas>

<script>
(() => {
  "use strict";

  // ==============================
  // èª¿æ•´ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
  // ==============================
  const BASE_SPEED = 8.8;
  const SPEED_RAMP = 0.020;
  const FALL_RATE  = 0.0115;
  const BUMPINESS  = 1.00;
  const CAMERA_LAG = 0.10;

  const GRAVITY    = 34.0;
  const FALL_SHOW_SEC = 0.95;

  const ENCOUNTER_MIN = 460;
  const ENCOUNTER_MAX = 860;
  const ITEM_MIN = 420;
  const ITEM_MAX = 780;
  const LANDMARK_MIN = 740;
  const LANDMARK_MAX = 1400;

  // æ–°ï¼šã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç‰©èªãƒ»äº‹æ•…ãƒ»å°ãƒã‚¿ï¼‰é–“éš”
  const EVENT_MIN = 360;
  const EVENT_MAX = 720;

  const RARE_ENEMY_RATE = 0.10;
  const RARE_CHEST_RATE = 0.12;

  // ãƒœã‚¹ï¼ˆã‚¹ã‚³ã‚¢ç„¡é–¢ä¿‚ï¼‰
  const BOSS_MIN_DIST = 160;   // m
  const BOSS_MAX_DIST = 260;   // m

  // ==============================
  // ãƒ‡ãƒ¼ã‚¿
  // ==============================
  const CLASSES = [
    { key:'hero',  name:'ã‚†ã†ã—ã‚ƒ',     main:'#57a6ff', effect:'slash' },
    { key:'mage',  name:'ã¾ã»ã†ã¤ã‹ã„', main:'#c67cff', effect:'spell' },
    { key:'thief', name:'ã¨ã†ãã',     main:'#7cf7c2', effect:'multi' },
    { key:'war',   name:'ã›ã‚“ã—',       main:'#ffb36b', effect:'heavy' },
  ];

  // æ•µã‚’å¢—ã‚„ã™ï¼ˆè¦‹ãŸç›®ã¯çµµæ–‡å­—ã ãŒã€ã‚¤ãƒ™ãƒ³ãƒˆæ€§ã§å·®ã‚’ä»˜ã‘ã‚‹ï¼‰
  const MONSTERS = [
    { name:'ã‚¹ãƒ©ã‚¤ãƒ ', icon:'ğŸŸ¦', tone:560 },
    { name:'ã‚´ãƒ¼ã‚¹ãƒˆ', icon:'ğŸ‘»', tone:520 },
    { name:'ã‚´ãƒ–ãƒªãƒ³', icon:'ğŸ‘º', tone:480 },
    { name:'ãƒ‰ãƒ©ã‚­ãƒ¼', icon:'ğŸ¦‡', tone:620 },
    { name:'ã‚­ãƒ¡ãƒ©',   icon:'ğŸª½', tone:660 },
    { name:'ã„ã£ã‹ãã†ã•ã', icon:'ğŸ°', tone:600 },
    { name:'ãã•ã£ãŸã—ãŸã„', icon:'ğŸ§Ÿ', tone:420 },
    { name:'ã¾ã˜ã‚…ã¤ã—', icon:'ğŸ§™', tone:700 },
    { name:'ãŠãŠãŒã‚‰ã™', icon:'ğŸ¦â€â¬›', tone:640 },
    { name:'ãŠãŠã­ãšã¿', icon:'ğŸ€', tone:500 },
    { name:'ã©ãã‚ã‚ãã¾', icon:'ğŸ’€', tone:380 },
    { name:'ã¾ã‚‚ã®', icon:'ğŸ‘¾', tone:560 },
  ];

  const RARE_MONSTERS = [
    { name:'ã‚­ãƒ³ã‚°ã‚¹ãƒ©ã‚¤ãƒ ', icon:'ğŸŸª', tone:820 },
    { name:'ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚´ãƒ–ãƒªãƒ³', icon:'ğŸŸ¨', tone:900 },
    { name:'ã‚ã‚„ã—ã„å½±', icon:'ğŸŸ¥', tone:860 },
    { name:'ãƒŸãƒ©ã‚¯ãƒ«ã†ã•ã', icon:'ğŸ‡', tone:960 },
    { name:'ãƒ¡ã‚¿ãƒ«ï¼Ÿ', icon:'â¬œ', tone:740 },
  ];

  const WEAPONS = [
    { name:'ã©ã†ã®ã¤ã‚‹ã', icon:'ğŸ—¡ï¸', power:1, blade:'#d9b27b' },
    { name:'ã¦ã¤ã®ã‚„ã‚Š',   icon:'ğŸ”±', power:2, blade:'#cfd8e3' },
    { name:'ãã‚“ã®ã¤ã‚‹ã', icon:'ğŸ—¡ï¸', power:3, blade:'#e6f0ff' },
    { name:'ã¾ã»ã†ã®ã¤ãˆ', icon:'ğŸª„', power:2, blade:'#c67cff' },
    { name:'ã§ã‚“ã›ã¤ã®ã‘ã‚“', icon:'ğŸ—¡ï¸', power:5, blade:'#7cf7c2' },
  ];

  const LOOT = [
    { type:'loot', name:'ãã‚“ã‹', icon:'ğŸª™' },
    { type:'loot', name:'ã‚„ããã†', icon:'ğŸŒ¿' },
    { type:'loot', name:'ã›ã„ã™ã„', icon:'ğŸ§´' },
    { type:'loot', name:'ã¡ã„ã•ãªãƒ¡ãƒ€ãƒ«', icon:'ğŸŸ¡' },
    { type:'loot', name:'ãŠã¾ã‚‚ã‚Š', icon:'ğŸ§¿' },
    { type:'loot', name:'ãµã—ããªã“ãª', icon:'âœ¨' },
  ];

  const CHESTS = [
    { type:'chest', name:'ãŸã‹ã‚‰ã°ã“', icon:'ğŸ§°' },
    { type:'chest', name:'ã‚ã‚„ã—ã„ã¯ã“', icon:'ğŸ“¦' },
    { type:'chest', name:'ãµã‚‹ã„ã¯ã“', icon:'ğŸ—ƒï¸' },
  ];

  const RARE_CHESTS = [
    { type:'chest', name:'ã‚´ãƒ¼ãƒ«ãƒ‰ãŸã‹ã‚‰ã°ã“', icon:'ğŸ’°' },
    { type:'chest', name:'ãƒŸãƒŸãƒƒã‚¯ï¼Ÿï¼ˆãŸã¶ã‚“ï¼‰', icon:'ğŸ§²' },
    { type:'chest', name:'ãã‚‰ãã‚‰ã®ã¯ã“', icon:'ğŸ' },
  ];

  const LANDMARKS = [
    { name:'æ‘', icon:'ğŸ˜ï¸', xp:8,  kind:'town' },
    { name:'å®¿å±‹', icon:'ğŸ›ï¸', xp:10, kind:'inn' },
    { name:'æ´çªŸ', icon:'ğŸ•³ï¸', xp:12, kind:'cave' },
    { name:'åŸ', icon:'ğŸ°', xp:16, kind:'castle' },
    { name:'ã»ã“ã‚‰', icon:'â›©ï¸', xp:10, kind:'shrine' },
    { name:'æ©‹', icon:'ğŸŒ‰', xp:9,  kind:'bridge' },
    { name:'æ£®', icon:'ğŸŒ²', xp:11, kind:'forest' },
    { name:'å¡”', icon:'ğŸ—¼', xp:12, kind:'tower' },
    { name:'æ¸¯ç”º', icon:'âš“', xp:11, kind:'port' },
  ];

  // ==============================
  // ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆ50å€‹ï¼‰
  //  - kind: 'story'|'luck'|'trap'|'rest'|'odd'
  //  - text: è¡¨ç¤º
  //  - eff:  åŠ¹æœï¼ˆhp/mp/xp/rareãªã©ã‚’å°‘ã—å‹•ã‹ã™ï¼‰
  // ==============================
  const EVENTS = [
    { kind:'story', text:'ã¿ã¡ã°ãŸã« ãµã—ããª ã„ã—ãŒã‚ã‚‹', eff:(st)=>{ st.xp+=3; st.log('ï¼Š ãµã—ããª ã„ã—ã‚’ ãªã§ãŸ'); } },
    { kind:'odd',   text:'ãã—ã‚ƒã¿ãŒ ã§ãŸï¼', eff:(st)=>{ st.hp-=1; st.log('â–¼ ãã—ã‚ƒã¿ã§ ã‚ˆã‚ã‘ãŸ'); } },
    { kind:'luck',  text:'ã‚ˆã„ ã‹ãœãŒ ãµã„ãŸ', eff:(st)=>{ st.mp+=1; st.xp+=2; st.log('â™ª ãªã‚“ã‹ ã„ã„ã‹ã‚“ã˜'); } },
    { kind:'trap',  text:'ã¬ã‹ã‚‹ã‚“ã  ã¿ã¡ã ', eff:(st)=>{ st.hp-=1; st.log('â–¼ ãã¤ãŒ ã¬ã‘ã‹ã‘ãŸ'); } },
    { kind:'story', text:'ã¿ã¡ã—ã‚‹ã¹ãŒ ãŸãŠã‚Œã¦ã„ã‚‹', eff:(st)=>{ st.xp+=4; st.log('ï¼Š ãªãŠã—ã¦ ãŠã„ãŸ'); } },
    { kind:'rest',  text:'ã“ã‹ã’ã§ ã²ã¨ã‚„ã™ã¿', eff:(st)=>{ st.hp+=2; st.mp+=1; st.log('â— ã™ã“ã— ã‹ã„ãµã'); } },
    { kind:'odd',   text:'ãªãœã‹ ã†ã—ã‚ã‹ã‚‰ ã‹ã„ã›ã‚“ãŒãã‚‹', eff:(st)=>{ st.mp-=1; st.log('â–¼ ã¸ã‚“ãª ãã¶ã‚“'); } },
    { kind:'story', text:'ã¤ã‚Šã°ã—ãŒ ãã—ã‚“ã§ã„ã‚‹', eff:(st)=>{ st.xp+=3; st.log('ï¼Š ã‚†ã£ãã‚Š ã‚ãŸã£ãŸ'); } },
    { kind:'luck',  text:'ã¡ã„ã•ãª ãˆãŒãŠã® ã“ã©ã‚‚ã« ã‚ã£ãŸ', eff:(st)=>{ st.xp+=5; st.log('â™ª ã’ã‚“ããŒ ã§ãŸ'); } },
    { kind:'trap',  text:'ã¿ãˆãªã„ ã ã‚“ã•ãŒ ã‚ã‚‹', eff:(st)=>{ st.hp-=2; st.log('â–¼ ã²ã–ã« ããŸ'); } },

    { kind:'odd',   text:'ã¿ã¡ã® ã¯ã—ã§ ã­ã“ãŒ ã¿ã¦ã„ã‚‹', eff:(st)=>{ st.xp+=3; st.log('ï¼Š ã­ã“ã¯ ã¤ã‚ˆã„'); } },
    { kind:'story', text:'ãµã‚‹ã„ ãŸã¦ãµã ã« ã¡ãšãŒ ã‹ã„ã¦ã‚ã‚‹', eff:(st)=>{ st.xp+=6; st.log('ï¼Š ã¡ãšã‚’ ãŠã¼ãˆãŸ'); } },
    { kind:'trap',  text:'ãã•ã‚€ã‚‰ãŒ ã†ã”ã„ãŸ', eff:(st)=>{ st.hp-=1; st.log('â–¼ ãªã‚“ã‹ã« ã‹ã¾ã‚ŒãŸ'); } },
    { kind:'luck',  text:'ã¿ãšãŸã¾ã‚ŠãŒ ãã‚‰ãã‚‰ã—ã¦ã„ã‚‹', eff:(st)=>{ st.mp+=2; st.log('â™ª ãã¶ã‚“ãŒ ã„ã„'); } },
    { kind:'rest',  text:'ã‚ãŸãŸã‹ã„ ã²ã ã¾ã‚Šã ', eff:(st)=>{ st.hp+=1; st.log('â— ã­ã‚€ã‘ãŒ ããˆãŸ'); } },
    { kind:'odd',   text:'ãªãœã‹ ãšã£ã¨ ã‹ã‚†ã„', eff:(st)=>{ st.mp-=1; st.log('â–¼ ãã«ãªã‚‹'); } },
    { kind:'story', text:'ã²ã¨ã‚Šã® ãŸã³ã³ã¨ãŒ ã¦ã‚’ ãµã£ãŸ', eff:(st)=>{ st.xp+=4; st.log('ï¼Š ãŸã³ã¯ ã„ã„'); } },
    { kind:'trap',  text:'ã“ã„ã—ãŒ ãšã£ã¨ ã„ã‚„ãŒã‚‰ã›ã‚’ ã—ã¦ãã‚‹', eff:(st)=>{ st.hp-=1; st.log('â–¼ ã“ã„ã— ã¤ã‚ˆã„'); } },
    { kind:'luck',  text:'ã€ŒãŒã‚“ã°ã‚Œã€ã¨ ã©ã“ã‹ã§ ãã“ãˆãŸ', eff:(st)=>{ st.xp+=5; st.log('â™ª ã¡ã‹ã‚‰ãŒ ã‚ã„ãŸ'); } },
    { kind:'story', text:'ã‚†ã†ã—ã‚ƒã¯ ã¡ã‚‡ã£ã¨ ã‹ã£ã“ã¤ã‘ãŸ', eff:(st)=>{ st.mp+=1; st.log('ï¼Š ãã‚ãƒãƒ¼ã‚º'); } },

    { kind:'odd',   text:'ã‹ãœãŒ ã¾ãˆãŒã¿ã‚’ ã¤ã‹ã‚“ã ', eff:(st)=>{ st.hp-=1; st.log('â–¼ ã‚ã« ã¯ã„ã£ãŸ'); } },
    { kind:'rest',  text:'ã¡ã„ã•ãª ã„ãšã¿ã« ã‹ãŠã‚’ ã‚ã‚‰ã£ãŸ', eff:(st)=>{ st.hp+=2; st.log('â— ã•ã£ã±ã‚Š'); } },
    { kind:'trap',  text:'ã™ã¹ã‚Šã‚„ã™ã„ ã„ã—ã ãŸã¿', eff:(st)=>{ st.hp-=1; st.log('â–¼ ã‚ã—ãŒ ã™ã¹ã£ãŸ'); } },
    { kind:'luck',  text:'ãŠã¾ã‚‚ã‚ŠãŒ ãã‚‰ã£ã¨ ã²ã‹ã£ãŸ', eff:(st)=>{ st.mp+=1; st.xp+=3; st.log('â™ª ãªã‚“ã‹ ã¾ã‚‚ã‚‰ã‚ŒãŸ'); } },
    { kind:'story', text:'ã€Œã“ã“ã§ ã¾ã£ã¦ã‚‹ã€ã¨ ã„ã—ã« ã‹ã„ã¦ã‚ã‚‹', eff:(st)=>{ st.xp+=4; st.log('ï¼Š ã ã‚Œã '); } },
    { kind:'odd',   text:'ã„ããªã‚Š ã†ãŸãŒ ãã“ãˆã‚‹', eff:(st)=>{ st.mp-=1; st.log('â–¼ ã‚ãŸã¾ã« ã®ã“ã‚‹'); } },
    { kind:'rest',  text:'ãƒ‘ãƒ³ã‚’ ã‹ã˜ã£ãŸ', eff:(st)=>{ st.hp+=1; st.log('â— ã†ã¾ã„'); } },
    { kind:'trap',  text:'ãã¤ã²ã‚‚ãŒ ã»ã©ã‘ãŸ', eff:(st)=>{ st.hp-=1; st.log('â–¼ ã»ã©ã‘ãŸï¼ˆã»ã‚“ã¨ã«ï¼‰'); } },
    { kind:'luck',  text:'ã€Œãƒ¬ã‚¢ãŒ ã§ãã†ãª ããŒã™ã‚‹ã€', eff:(st)=>{ st.rareAura= Math.min(1, st.rareAura + 0.25); st.log('â™ª ããŒã™ã‚‹ã ã‘'); } },
    { kind:'story', text:'ãµã‚‹ã„ ã»ã“ã‚‰ã« ãŠã˜ãã—ãŸ', eff:(st)=>{ st.xp+=6; st.log('ï¼Š ãªã‚“ã‹ ãˆã‚‰ã„'); } },

    { kind:'trap',  text:'ãµã¿ã¬ããã†ãª ã¯ã—ã ', eff:(st)=>{ st.hp-=2; st.log('â–¼ ã‚ã¶ãªã‹ã£ãŸ'); } },
    { kind:'odd',   text:'ã¿ã¡ãŒ ã„ã¤ã‚‚ã‚ˆã‚Š ã¿ã¡ã£ã½ã„', eff:(st)=>{ st.xp+=2; st.log('ï¼Š ã¿ã¡ã '); } },
    { kind:'rest',  text:'ãã¡ã¶ãˆã‚’ ãµã„ãŸ', eff:(st)=>{ st.mp+=1; st.log('â— ãã¶ã‚“ã¦ã‚“ã‹ã‚“'); } },
    { kind:'luck',  text:'ãã‚Œã„ãª ã¯ã­ã‚’ ã²ã‚ã£ãŸ', eff:(st)=>{ st.xp+=5; st.log('â™ª ãªã‚“ã‹ ã¤ã‚ˆãã†'); } },
    { kind:'story', text:'ã¯ã‚‹ã‹ ã¨ãŠãã« ã—ã‚ãŒ ã¿ãˆã‚‹', eff:(st)=>{ st.xp+=4; st.log('ï¼Š ã„ã¤ã‹ ã„ã'); } },
    { kind:'trap',  text:'ã„ã—ãŒ ã›ã‹ã„ã® ã„ã—ã ã£ãŸ', eff:(st)=>{ st.hp-=2; st.mp-=1; st.log('â–¼ ã›ã‹ã„ãŒ ã„ã˜ã‚ã‚‹'); } },
    { kind:'odd',   text:'ãã‚…ã†ã« ã˜ã‚…ã†ã‚Šã‚‡ããŒ ã¤ã‚ˆã„', eff:(st)=>{ st.hp-=1; st.log('â–¼ ãã®ã›ã„'); } },
    { kind:'story', text:'ã¿ã¡ã®ã¯ã—ã« ã¡ã„ã•ãª ã»ã‚“ãŒ ãŠã¡ã¦ã„ã‚‹', eff:(st)=>{ st.xp+=6; st.log('ï¼Š ã¤ã‚ˆãã†ãª ã“ã¨ã°'); } },
    { kind:'luck',  text:'ã€Œã„ã¾ã® ãã¿ã¯ ã„ã‘ã‚‹ã€', eff:(st)=>{ st.hp+=1; st.mp+=1; st.log('â™ª ã„ã‘ã‚‹'); } },
    { kind:'rest',  text:'ã¾ã°ãŸãã‚’ ã—ãŸã‚‰ ã’ã‚“ã', eff:(st)=>{ st.hp+=1; st.log('â— ã’ã‚“ã'); } },

    { kind:'odd',   text:'ã¨ã¤ãœã‚“ ã‹ã’ãŒ ã‹ã£ã“ã„ã„', eff:(st)=>{ st.xp+=3; st.log('ï¼Š ã¡ã‚…ã†ã«ã³ã‚‡ã†'); } },
    { kind:'trap',  text:'ã¿ã¿ã‹ãã‚’ ã—ãªãŒã‚‰ ã¯ã—ã£ãŸ', eff:(st)=>{ st.hp-=2; st.log('â–¼ ã ã‚'); } },
    { kind:'story', text:'ã€Œã“ã“ã¯ ãã‘ã‚“ã€ã¨ ã‹ããŠã', eff:(st)=>{ st.xp+=4; st.log('ï¼Š ã‘ã„ã“ã ã‚ã‚ŠãŒã¨ã†'); } },
    { kind:'luck',  text:'ã‚³ã‚¤ãƒ³ãŒ ã²ã¨ã‚Šã§ ã“ã‚ãŒã£ã¦ããŸ', eff:(st)=>{ st.xp+=4; st.log('â™ª ã†ãã ã‚'); } },
    { kind:'rest',  text:'ã¿ãšã‚’ ã®ã‚“ã ', eff:(st)=>{ st.mp+=1; st.log('â— ã†ã‚‹ãŠã„'); } },
    { kind:'trap',  text:'ã‹ãŸã»ã†ã® ãã¤ãŒ ã‹ã‚‹ã„', eff:(st)=>{ st.hp-=1; st.log('â–¼ ã„ã‚„ãª ã‚ˆã‹ã‚“'); } },
    { kind:'odd',   text:'ã²ã¨ã‚Šã§ã« BGMãŒ ãªã‚‰ãªã„ï¼ˆããŒã™ã‚‹ï¼‰', eff:(st)=>{ st.mp-=1; st.log('â–¼ ããŒã™ã‚‹'); } },
    { kind:'story', text:'ã€Œã‚†ã†ã—ã‚ƒã‚ˆã€ã¨ ã©ã“ã‹ã§ ã‚ˆã°ã‚ŒãŸ', eff:(st)=>{ st.xp+=5; st.log('ï¼Š ã‚ˆã°ã‚ŒãŸ'); } },
    { kind:'luck',  text:'ãã‚‰ã£ã¨ ã¾ã¶ã—ã„ ã²ã‹ã‚Š', eff:(st)=>{ st.xp+=5; st.mp+=1; st.log('â™ª ãªã‚“ã‹ ã™ã”ã„'); } },
    { kind:'trap',  text:'ã¿ãˆãªã„ ã²ã‚‚ã« ã²ã£ã‹ã‹ã£ãŸ', eff:(st)=>{ st.hp-=2; st.log('â–¼ ãã‚„ã—ã„'); } },
  ];

  // ==============================
  // æ­»ã«æ–¹ï¼ˆ50å€‹ï¼‰
  //  - çŠ¶æ³ä¾å­˜ã§é¸ã¶ã®ã§ã€åŒã˜è·é›¢ã§ã‚‚å¤‰åŒ–ã—ã‚„ã™ã„
  // ==============================
  const FALL_CAUSES_50 = [
    'ã„ã—ã«ã¤ã¾ãšã„ãŸ',
    'ãã¤ã²ã‚‚ãŒ ã»ã©ã‘ãŸ',
    'ã‹ãœãŒ ã¤ã‚ˆã‹ã£ãŸ',
    'ã¿ãˆãªã„ã ã‚“ã•',
    'ã˜ã‚…ã†ã‚Šã‚‡ããŒã¤ã‚ˆã„',
    'ã›ã‹ã„ã®ã„ã—',
    'ã‚ã—ãŒã‚ã‚‰ã£ãŸ',
    'ãã—ã‚ƒã¿ã§ ã¾ãˆãŒã¿ãŒ ã‚ã« ã¯ã„ã£ãŸ',
    'ã¿ã¿ã‹ãã‚’ã—ãªãŒã‚‰ ã¯ã—ã£ãŸ',
    'ã‚ˆãã¿ã—ã¦ ã‹ã£ã“ã¤ã‘ãŸ',
    'ãŸã¦ã‚’ ã¿ãŒãã™ãã¦ ã™ã¹ã£ãŸ',
    'ã¤ã‚‹ã¤ã‚‹ã® ã“ã„ã—ã« ã¾ã‘ãŸ',
    'ãŸã³ã³ã¨ã« ã¦ã‚’ãµã‚Šã™ããŸ',
    'ã‚€ã ã« ã ã£ã—ã‚…ã—ãŸ',
    'ã ã„ãŸã‚“ã« ã„ã£ãŸã‚‰ ã ã‚ã ã£ãŸ',
    'ã‚†ã ã‚“ã—ãŸ ãã®ã—ã‚…ã‚“ã‹ã‚“',
    'ã€Œã„ã‘ã‚‹ã€ã¨ ãŠã‚‚ã£ãŸ',
    'ã€Œã“ã‚ŒãŒ ã‚†ã†ã—ã‚ƒã® ã‚ã‚‹ãã€ã¨ ãŠã‚‚ã£ãŸ',
    'ã—ã£ã½ï¼ˆãªã„ï¼‰ã‚’ ãµã‚“ã ',
    'ã©ã“ã‹ã® ã‚€ã—ã« ã³ã³ã£ãŸ',
    'ã‹ã’ãµã¿ã—ã¦ ã‹ã£ã¦ã« ã¾ã‘ãŸ',
    'ã¾ã¶ã—ãã¦ ã¤ã„',
    'ãã‚‰ãã¦ ã¤ã„',
    'ã‚ã—ã‚‚ã¨ãŒ ãµã‚ãµã‚ã—ãŸ',
    'ã¯ã¯ãƒ¼ã‚“ ã¨ ãªã£ãŸ',
    'ãã†ã³ãŒ ã‹ã£ã“ã‚ˆã™ããŸ',
    'ãƒãƒ³ãƒˆãŒ ã²ã£ã‹ã‹ã£ãŸ',
    'ãƒãƒ³ãƒˆãŒ ã‹ã£ã“ã‚ˆã ãªã³ãã™ããŸ',
    'ãŸã¦ãŒ ãŠã‚‚ã‹ã£ãŸï¼ˆããŒã—ãŸï¼‰',
    'ã‘ã‚“ãŒ ãªãŒã‹ã£ãŸï¼ˆããŒã—ãŸï¼‰',
    'ã¿ãšãŸã¾ã‚Šã« ã‹ãŠãŒ ã†ã¤ã£ã¦ ã³ã³ã£ãŸ',
    'ã¿ã¡ãŒ ã¿ã¡ã£ã½ã™ãã¦ ã‚ã¶ãªã‹ã£ãŸ',
    'ã“ã‹ã’ãŒ ã“ã“ã¡ã‚ˆã™ããŸ',
    'ãƒ‘ãƒ³ãŒ ã†ã¾ãã¦ ã¼ã‚“ã‚„ã‚Šã—ãŸ',
    'ã›ãªã‹ãŒ ã‹ã‚†ãã¦ ã ã‚ã ã£ãŸ',
    'ã—ã‚“ã¡ã‚‡ã†ã« ã„ã£ãŸã‚‰ ã ã‚ã ã£ãŸ',
    'ã‚‰ã‚“ã¼ã†ã« ã„ã£ãŸã‚‰ ã ã‚ã ã£ãŸ',
    'ã‹ã¿ã®ã‘ãŒ ã™ã¹ã¦ã‚’ ã‚‚ã£ã¦ã„ã£ãŸ',
    'ã¿ãˆãªã„ ã²ã‚‚ã« ã²ã£ã‹ã‹ã£ãŸ',
    'ã“ã„ã—ãŒ ã„ã‚„ãŒã‚‰ã›ã‚’ ã—ã¦ããŸ',
    'ãµã¿ã ã„ãŒ ãµã¿ã ã„ã˜ã‚ƒãªã‹ã£ãŸ',
    'ã‚ã—ãŒ ã‚‚ã¤ã‚ŒãŸ',
    'ã‚ã—ãŒ ã—ã‚“ã§ã„ãŸ',
    'ã‚†ã†ã—ã‚ƒã® ã·ã‚‰ã„ã©ãŒ ã“ã‚ã‚“ã ',
    'ã¿ã¡ã—ã‚‹ã¹ã‚’ ãªãŠã—ã¦ ã¾ã‚“ããã—ãŸ',
    'ã—ã‚ãŒ ã¿ãˆãŸã®ã§ ã‚ã›ã£ãŸ',
    'ã»ã“ã‚‰ã« ãŠã˜ãã—ã¦ ãµã‚‰ã¤ã„ãŸ',
    'ã€Œãã‚‡ã†ã¯ ã„ã‘ã‚‹ã€ã‹ã‚‰ã® ã ã‚',
    'ã•ã„ã”ã« ãˆãŒãŠã§ ã“ã‚ã‚“ã ',
  ];

  const BOSSES = [
    { name:'ãƒ‰ãƒ©ã‚´ãƒ³', icon:'ğŸ‰', tone:220 },
    { name:'ã¾ãŠã†ï¼Ÿ', icon:'ğŸ˜ˆ', tone:196 },
    { name:'ã‚®ã‚¬ãƒ³ãƒˆ', icon:'ğŸ—¿', tone:174 },
  ];

  // ==============================
  // DOM / Canvas (DPRå¯¾å¿œ)
  // ==============================
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d', { alpha: true });

  let DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
  let VW = 0, VH = 0;

  function resize(){
    DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    const w = Math.floor(window.innerWidth);
    const h = Math.floor(window.innerHeight);
    VW = w; VH = h;

    cv.width  = Math.floor(w * DPR);
    cv.height = Math.floor(h * DPR);
    // ä»¥å¾Œã®æç”»ã¯CSSãƒ”ã‚¯ã‚»ãƒ«åŸºæº–ã§
    ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
  }
  window.addEventListener('resize', resize, {passive:true});
  resize();

  // ==============================
  // LocalStorage
  // ==============================
  const STORE_KEY_BEST = 'dqfall-best-v4';
  const STORE_KEY_DAILY_PREFIX = 'dqfall-daily-v4-';
  const STORE_KEY_RANKING = 'dqfall-ranking-v4';

  function todayKey(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function loadRanking(){
    try{
      const raw = localStorage.getItem(STORE_KEY_RANKING);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    } catch { return []; }
  }
  function saveRanking(arr){
    try{ localStorage.setItem(STORE_KEY_RANKING, JSON.stringify(arr)); } catch {}
  }

  let best = Number(localStorage.getItem(STORE_KEY_BEST) || '0');
  let dailyBest = Number(localStorage.getItem(STORE_KEY_DAILY_PREFIX + todayKey()) || '0');
  let ranking = loadRanking();

  // ==============================
  // Audioï¼ˆæœ€å°ï¼šç„¡ã—ã§ã‚‚å‹•ãï¼‰
  // ==============================
  let audioCtx = null;
  let soundOn = true; // å¤–éƒ¨UIæ’é™¤ã®ãŸã‚ã€å›ºå®šONï¼ˆå¿…è¦ãªã‚‰å¾Œã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼åŒ–ã§ãã¾ã™ï¼‰

  function ensureAudio(){
    if (!soundOn) return;
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
  }
  function tone(seq, type='square'){
    if (!soundOn) return;
    ensureAudio();
    if (!audioCtx) return;
    let t = audioCtx.currentTime;
    for (const s of seq){
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.value = s.f;
      o.connect(g); g.connect(audioCtx.destination);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(s.v ?? 0.08, t + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t + s.d);
      o.start(t);
      o.stop(t + s.d + 0.02);
      t += s.d + (s.g ?? 0.02);
    }
  }
  const SFX = {
    start: () => tone([{f:330,d:0.06},{f:440,d:0.06},{f:660,d:0.10,g:0.03}]),
    msg:   () => tone([{f:880,d:0.04,v:0.09}]),
    hit:   () => tone([{f:220,d:0.05,v:0.10},{f:140,d:0.07,v:0.08}]),
    item:  () => tone([{f:784,d:0.06,v:0.08},{f:988,d:0.08,v:0.08}]),
    fall:  () => tone([{f:196,d:0.08,v:0.10},{f:110,d:0.14,v:0.08,g:0.03}]),
    best:  () => tone([{f:523,d:0.08,v:0.09},{f:659,d:0.08,v:0.09},{f:784,d:0.10,v:0.10,g:0.04}]),
    rare:  () => tone([{f:988,d:0.06,v:0.09},{f:1318,d:0.06,v:0.09},{f:1760,d:0.10,v:0.10,g:0.04}], 'sawtooth'),
    boss:  () => tone([{f:220,d:0.10,v:0.10},{f:196,d:0.10,v:0.10},{f:174,d:0.14,v:0.10,g:0.05}], 'sawtooth'),
  };

  // ==============================
  // RNG
  // ==============================
  let rng = mulberry32((Date.now() ^ (Math.random()*1e9)) >>> 0);
  function mulberry32(a){
    return function(){
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }

  // ==============================
  // State
  // ==============================
  const MODE = { READY:0, RUN:1, FALLING:2, RESULT:3 };
  let mode = MODE.READY;

  let dist = 0;
  let speed = 0;
  let camX = 0;

  let heroClass = null;
  let equipped = null;

  // RPG-ish status
  let level = 1;
  let xp = 0;
  let nextXp = 20;
  let hp = 18, maxHp = 18;
  let mp = 8,  maxMp = 8;

  let kills = 0;
  let inventory = [];
  let landmarksSeen = [];
  let rareCount = 0;

  let logLines = [];
  let lastCause = '';
  let title = '';

  // ã€Œä»Šèµ·ãã¦ã‚‹ã“ã¨ã€å°‚ç”¨ã®å¤§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  let msg = { text:'', t:0, dur:0, kind:'' };

  let nextEncounterX = 900;
  let nextItemX = 780;
  let nextLandmarkX = 1100;
  let nextEventX = 640;

  // boss
  let bossDist = 220;
  let bossDone = false;

  // active
  let active = null;

  // particles
  let particles = [];

  // rare auraï¼ˆã‚¤ãƒ™ãƒ³ãƒˆã§å°‘ã—ä¸Šã’ã‚‹ï¼šãƒ¬ã‚¢é­é‡ç‡ã«å½±éŸ¿ï¼‰
  let rareAura = 0;

  const hero = {
    x:0, y:0, vy:0,
    tilt:0, rag:0, ragV:0,
    step:0,
    crown:false,
  };

  // ==============================
  // Terrain
  // ==============================
  function groundY(x){
    const a = 22 * BUMPINESS;
    const b = 12 * BUMPINESS;
    const c = 8  * BUMPINESS;
    return (VH*0.62)
      + Math.sin(x * 0.016) * a
      + Math.sin(x * 0.043 + 1.9) * b
      + Math.sin(x * 0.085 + 0.7) * c;
  }
  function groundSlope(x){
    const e = 2.0;
    return (groundY(x+e) - groundY(x-e)) / (2*e);
  }

  // ==============================
  // UI helpers
  // ==============================
  function fmt(m){ return (Math.max(0,m)).toFixed(1) + ' m'; }

  function pushLog(s){
    logLines.push(s);
    if (logLines.length > 16) logLines.shift();
  }

  function showMsg(text, dur=1.15, kind=''){
    msg.text = text;
    msg.t = 0;
    msg.dur = dur;
    msg.kind = kind;
    SFX.msg();
  }

  function addXP(amount, reason){
    xp += amount;
    if (reason) pushLog(`ï¼‹${amount}EXPï¼ˆ${reason}ï¼‰`);
    while (xp >= nextXp){
      xp -= nextXp;
      level += 1;
      nextXp = Math.floor(nextXp * 1.25 + 6);
      maxHp += 2;
      maxMp += 1;
      hp = Math.min(maxHp, hp + 3);
      mp = Math.min(maxMp, mp + 2);
      pushLog(`â˜… ãƒ¬ãƒ™ãƒ«ãŒ ${level} ã« ã‚ãŒã£ãŸï¼`);
      showMsg(`ãƒ¬ãƒ™ãƒ«ãŒ ${level} ã« ã‚ãŒã£ãŸï¼`, 1.2, 'lv');
      spawnBurst(hero.x + 80, hero.y - 40, heroClass ? heroClass.main : 'rgba(255,255,255,0.9)');
    }
  }

  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  // ==============================
  // Start / Fall / Result
  // ==============================
  function startRun(){
    mode = MODE.RUN;
    dist = 0;
    speed = BASE_SPEED;
    camX = 0;

    heroClass = CLASSES[Math.floor(rng()*CLASSES.length)];
    equipped = null;

    level = 1;
    xp = 0;
    nextXp = 20;
    maxHp = 18;
    maxMp = 8;
    hp = maxHp;
    mp = maxMp;

    hero.x = 0;
    hero.vy = 0;
    hero.tilt = 0;
    hero.rag = 0;
    hero.ragV = 0;
    hero.step = 0;
    hero.crown = false;

    kills = 0;
    inventory = [];
    landmarksSeen = [];
    rareCount = 0;
    rareAura = 0;

    logLines = [];
    lastCause = '';
    title = '';

    nextEncounterX = 680 + Math.floor(rng()*220);
    nextItemX = 520 + Math.floor(rng()*240);
    nextLandmarkX = 900 + Math.floor(rng()*380);
    nextEventX = 520 + Math.floor(rng()*240);

    bossDone = false;
    bossDist = BOSS_MIN_DIST + rng()*(BOSS_MAX_DIST - BOSS_MIN_DIST);

    active = null;
    particles = [];

    rng = mulberry32(((Date.now() + Math.floor(Math.random()*1e9)) ^ 0xC0FFEE) >>> 0);

    SFX.start();
    pushLog(`â–¶ ${heroClass.name} ã¯ ãŸã³ã«ã§ãŸï¼`);
    showMsg(`${heroClass.name} ã« ãã¾ã‚Šã¾ã—ãŸ`, 1.2, 'start');
  }

  function startFalling(){
    mode = MODE.FALLING;

    hero.vy = -7 - rng()*9;
    hero.rag = hero.tilt;
    hero.ragV = (rng() < 0.5 ? -1 : 1) * (4 + rng()*7);

    lastCause = pickFallCause();
    pushLog(`â–¼ ${heroClass.name} ã¯ ${lastCause}`);

    SFX.fall();
    active = { type:'fall', t:0 };
  }

  function pickFallCause(){
    // ç›´å‰ã‚¤ãƒ™ãƒ³ãƒˆã‚„çŠ¶æ³ã§ã€Œãã‚Œã£ã½ã„ã€æ­»å› ã«å¯„ã›ã‚‹
    // 1) ã‚¤ãƒ™ãƒ³ãƒˆç›´å¾Œã¯ã‚¤ãƒ™ãƒ³ãƒˆã«å¯„ã›ã‚‹
    // 2) HP/MPä½ã„ã¨å¼±ã£ã¦ã‚‹ç³»
    // 3) ãã‚Œä»¥å¤–ã¯ãƒ©ãƒ³ãƒ€ãƒ 
    const e = lastEventText || '';
    if (e.includes('ãã¤ã²ã‚‚')) return 'ãã¤ã²ã‚‚ãŒ ã»ã©ã‘ãŸ';
    if (e.includes('ã¬ã‹ã‚‹')) return 'ã¬ã‹ã‚‹ã¿ã« ã²ã–ã‚’ ã‚‚ã£ã¦ã„ã‹ã‚ŒãŸ';
    if (e.includes('ã ã‚“ã•')) return 'ã¿ãˆãªã„ã ã‚“ã•';
    if (e.includes('ã‹ãœ')) return 'ã‹ãœãŒ ã¾ãˆãŒã¿ã‚’ ã¤ã‹ã‚“ã ';
    if (e.includes('ã¿ã¿ã‹ã')) return 'ã¿ã¿ã‹ãã‚’ã—ãªãŒã‚‰ ã¯ã—ã£ãŸ';
    if (e.includes('ã“ã„ã—')) return 'ã“ã„ã—ãŒ ã„ã‚„ãŒã‚‰ã›ã‚’ ã—ã¦ããŸ';
    if (hp <= 3) return 'ã‚ã—ãŒ ã—ã‚“ã§ã„ãŸ';
    if (mp <= 1) return 'ã€Œã„ã‘ã‚‹ã€ã¨ ãŠã‚‚ã£ãŸ';
    return FALL_CAUSES_50[Math.floor(rng()*FALL_CAUSES_50.length)];
  }

  function computeTitle(){
    const d = dist;
    const k = kills;
    const inv = inventory.length;
    const lm = landmarksSeen.length;

    if (rareCount >= 3) return 'ãƒ¬ã‚¢ç‹©ã‚Šãƒã‚¹ã‚¿ãƒ¼';
    if (rareCount >= 1 && d < 70) return 'ãƒ¬ã‚¢ã‚’è¦‹ã¦è»¢ã¶è€…';
    if (level >= 6 && d < 90) return 'è‚²ã£ã¦ã‚‚è»¢ã¶';

    if (equipped && equipped.name === 'ã§ã‚“ã›ã¤ã®ã‘ã‚“' && d < 60) return 'ä¼èª¬ã‚’æŒã£ã¦è»¢ã¶è€…';
    if (k >= 10 && d < 80) return 'æˆ¦é—˜ç‹‚ï¼ˆè»¢å€’ï¼‰';
    if (inv >= 12) return 'æ‹¾ã„ç‰©åäºº';
    if (lm >= 4 && d >= 120) return 'æ—…ã®è¨˜éŒ²è€…';

    if (d >= 280) return 'ä¸–ç•Œã‚’èµ°ç ´ã—ãŸ';
    if (d >= 210) return 'è»¢ã°ã¬å‹‡è€…ï¼ˆä»®ï¼‰';
    if (d >= 150) return 'é‹¼ã®è¶³è…°';
    if (d >= 95)  return 'å†’é™ºè€…è¦‹ç¿’ã„';

    return 'è»¢å€’ã®ç´ è³ª';
  }

  function updateRanking(){
    const entry = {
      ts: Date.now(),
      dist: Number(dist.toFixed(1)),
      cls: heroClass ? heroClass.name : 'ï¼Ÿï¼Ÿï¼Ÿ',
      lv: level,
      title: title || '',
      kills,
      rare: rareCount,
    };
    ranking.push(entry);
    ranking.sort((a,b) => b.dist - a.dist);
    ranking = ranking.slice(0, 10);
    saveRanking(ranking);
  }

  function finalizeResult(){
    mode = MODE.RESULT;
    title = computeTitle();

    let isBest = false;
    if (dist > best){
      best = dist;
      localStorage.setItem(STORE_KEY_BEST, String(best));
      isBest = true;
    }
    if (dist > dailyBest){
      dailyBest = dist;
      localStorage.setItem(STORE_KEY_DAILY_PREFIX + todayKey(), String(dailyBest));
    }

    updateRanking();

    if (isBest){
      SFX.best();
      pushLog('â˜… ã•ã„ã“ã†ãã‚ãï¼');
      showMsg('ã•ã„ã“ã†ãã‚ãï¼', 1.3, 'best');
    } else {
      showMsg('ã¤ãã¯ ã„ã‘ã‚‹', 1.1, 'end');
    }
    pushLog(`â—† ã—ã‚‡ã†ã”ã†ï¼š${title}`);
  }

  // ==============================
  // Events / Items / Battles
  // ==============================
  let lastEventText = '';

  function runEvent(){
    const ev = EVENTS[Math.floor(rng()*EVENTS.length)];
    lastEventText = ev.text;

    const st = {
      hp, mp, xp,
      rareAura,
      log: (s)=>pushLog(s),
    };

    // åŠ¹æœé©ç”¨
    try { ev.eff(st); } catch {}

    // clamp
    hp = clamp(st.hp, 0, maxHp);
    mp = clamp(st.mp, 0, maxMp);
    rareAura = clamp(st.rareAura ?? rareAura, 0, 1);

    // xpã¯ addXP ã‚’é€šã—ãŸã„ã®ã§å·®åˆ†ã§å…¥ã‚Œã‚‹
    const gained = Math.max(0, Math.floor((st.xp ?? xp) - xp));
    if (gained > 0) addXP(gained, 'ã‚¤ãƒ™ãƒ³ãƒˆ');

    showMsg(ev.text, 1.35, 'event');
  }

  // ==============================
  // Controlsï¼ˆå¤–éƒ¨ãƒœã‚¿ãƒ³å»ƒæ­¢ï¼‰
  //  - READY: ã‚¿ãƒƒãƒ—ã§é–‹å§‹
  //  - RESULT: ã€Œã¯ã„ã€ã€Œã„ã„ãˆã€ã‚’æŠ¼ã™
  // ==============================
  const tap = {x:0,y:0,down:false};

  cv.addEventListener('pointerdown', (e) => {
    ensureAudio();
    const rect = cv.getBoundingClientRect();
    tap.x = (e.clientX - rect.left);
    tap.y = (e.clientY - rect.top);
    tap.down = true;

    if (mode === MODE.READY){
      startRun();
      return;
    }
    if (mode === MODE.RESULT){
      // ã¯ã„ï¼ã„ã„ãˆåˆ¤å®š
      const hit = hitTestYesNo(tap.x, tap.y);
      if (hit === 'yes'){
        startRun();
      } else if (hit === 'no'){
        // ã„ã„ãˆï¼šREADYã¸æˆ»ã™ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã«æˆ»ã‚‹ï¼‰
        mode = MODE.READY;
        showMsg('ã‚¿ãƒƒãƒ—ã—ã¦ ã¼ã†ã‘ã‚“', 1.0, 'ready');
      }
      return;
    }
  }, {passive:true});

  // ==============================
  // Loop
  // ==============================
  let lastT = performance.now();
  requestAnimationFrame(loop);

  function loop(now){
    const dt = Math.min(0.033, (now - lastT) / 1000);
    lastT = now;
    update(dt);
    render();
    requestAnimationFrame(loop);
  }

  function update(dt){
    if (msg.dur > 0){
      msg.t += dt;
      if (msg.t >= msg.dur){ msg.text = ''; msg.dur = 0; msg.kind=''; }
    }

    for (const p of particles){
      p.life -= dt;
      p.x += p.vx * dt;
      p.y += p.vy * dt;
      p.vy += 140 * dt;
    }
    particles = particles.filter(p => p.life > 0);

    if (mode === MODE.RUN){
      dist += speed * dt;
      speed += (SPEED_RAMP * dt) * (1 + dist * 0.0010);

      hero.x = dist * 40;
      hero.step += dt * (9.4 + speed*0.35);

      const gy = groundY(hero.x);
      hero.y = gy - 62;

      const slope = groundSlope(hero.x);
      const targetTilt = clamp(slope * 0.030, -0.40, 0.40);
      hero.tilt += (targetTilt - hero.tilt) * 0.14;

      const targetCam = hero.x - (VW * 0.35);
      camX += (targetCam - camX) * (1 - Math.pow(1 - CAMERA_LAG, dt * 60));

      // ç–²åŠ´ï¼ˆè»½ãï¼‰
      if (rng() < 0.01 * dt * 60){
        hp = clamp(hp - (rng()<0.5?1:0), 0, maxHp);
        mp = clamp(mp - (rng()<0.35?1:0), 0, maxMp);
      }

      // ãƒœã‚¹
      if (!active && !bossDone && dist >= bossDist){
        const b = BOSSES[Math.floor(rng()*BOSSES.length)];
        active = {
          type:'boss',
          t:0,
          phase:0,
          boss:b,
          mx: hero.x + 560,
          my: groundY(hero.x + 560) - 130,
        };
        bossDone = true;
        pushLog(`ï¼ï¼ ${b.name} ãŒ ã‚ã‚‰ã‚ã‚ŒãŸ`);
        showMsg(`${b.name} ãŒ ã‚ã‚‰ã‚ã‚ŒãŸï¼`, 1.2, 'boss');
        SFX.boss();
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ–°ï¼‰
      if (!active && hero.x >= nextEventX){
        active = { type:'event', t:0 };
        runEvent();
        nextEventX += EVENT_MIN + Math.floor(rng()*(EVENT_MAX - EVENT_MIN));
      }

      // æˆ¦é—˜
      if (!active && hero.x >= nextEncounterX){
        const auraBonus = rareAura * 0.18;
        const isRare = rng() < (RARE_ENEMY_RATE + auraBonus);
        const m = isRare ? RARE_MONSTERS[Math.floor(rng()*RARE_MONSTERS.length)] : MONSTERS[Math.floor(rng()*MONSTERS.length)];
        active = {
          type:'battle',
          t:0,
          phase:0,
          monster:m,
          rare:isRare,
          mx: hero.x + 520,
          my: groundY(hero.x + 520) - 110,
        };
        pushLog(`ï¼ ${m.name} ãŒ ã‚ã‚‰ã‚ã‚ŒãŸ` + (isRare ? 'ï¼ˆãƒ¬ã‚¢ï¼‰' : ''));
        showMsg(`${m.name} ãŒ ã‚ã‚‰ã‚ã‚ŒãŸ`, 1.05, 'battle');
        if (isRare){ SFX.rare(); } else { SFX.msg(); }

        nextEncounterX += ENCOUNTER_MIN + Math.floor(rng()*(ENCOUNTER_MAX-ENCOUNTER_MIN));
      }

      // ã‚¢ã‚¤ãƒ†ãƒ 
      if (!active && hero.x >= nextItemX){
        const roll = rng();
        let it;
        if (roll < 0.30){
          const isRare = rng() < RARE_CHEST_RATE;
          it = isRare ? RARE_CHESTS[Math.floor(rng()*RARE_CHESTS.length)] : CHESTS[Math.floor(rng()*CHESTS.length)];
          it = { ...it, rare: isRare };
        } else if (roll < 0.62){
          it = WEAPONS[Math.floor(rng()*WEAPONS.length)];
        } else {
          it = LOOT[Math.floor(rng()*LOOT.length)];
        }

        active = { type:'item', t:0, data:it };

        if (it.type === 'loot'){
          inventory.push({ icon: it.icon, name: it.name, type: 'loot' });
          pushLog(`â™ª ${it.name} ã‚’ ã¦ã«ã„ã‚ŒãŸ`);
          showMsg(`${it.name} ã‚’ ã¦ã«ã„ã‚ŒãŸ`, 1.05, 'loot');
          addXP(4 + Math.floor(rng()*3), 'ã²ã‚ã„ã‚‚ã®');
          hp = clamp(hp + (it.name==='ã‚„ããã†'?3:0), 0, maxHp);
          mp = clamp(mp + (it.name==='ã›ã„ã™ã„'?2:0), 0, maxMp);
          SFX.item();

        } else if (it.type === 'chest'){
          const rare = !!it.rare;
          inventory.push({ icon: it.icon, name: it.name, type: 'chest' });
          pushLog(`â™ª ${it.name} ã‚’ ã¿ã¤ã‘ãŸ` + (rare ? 'ï¼ˆãƒ¬ã‚¢ï¼‰' : ''));
          showMsg(`${it.name} ã‚’ ã¿ã¤ã‘ãŸ`, 1.05, 'chest');
          if (rare){
            rareCount += 1;
            SFX.rare();
            addXP(14 + Math.floor(rng()*8), 'ãƒ¬ã‚¢ãŸã‹ã‚‰');
            spawnBurst(hero.x + 220, hero.y - 60, 'rgba(255,215,90,0.95)');
            rareAura = clamp(rareAura + 0.12, 0, 1);
          } else {
            SFX.item();
            addXP(9 + Math.floor(rng()*5), 'ãŸã‹ã‚‰');
          }

        } else {
          equipped = it;
          inventory.push({ icon: it.icon, name: it.name, type: 'weapon' });
          pushLog(`â™ª ${it.name} ã‚’ ãã†ã³ã—ãŸ`);
          showMsg(`${it.name} ã‚’ ãã†ã³ã—ãŸ`, 1.05, 'weapon');
          SFX.item();
          addXP(7 + it.power, 'ãã†ã³');
        }

        nextItemX += ITEM_MIN + Math.floor(rng()*(ITEM_MAX-ITEM_MIN));
      }

      // ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯
      if (!active && hero.x >= nextLandmarkX){
        const lm = LANDMARKS[Math.floor(rng()*LANDMARKS.length)];
        active = { type:'landmark', t:0, data: lm, x: hero.x + 520, y: groundY(hero.x + 520) - 120 };
        landmarksSeen.push(lm);
        pushLog(`â—† ${lm.name} ã« ã¨ã†ã¡ã‚ƒã`);
        showMsg(`${lm.name} ã« ã¨ã†ã¡ã‚ƒã`, 1.05, 'landmark');

        if (lm.kind === 'inn'){
          hp = maxHp;
          mp = maxMp;
          addXP(lm.xp + 6, `ã‚„ã©ã‚„ï¼ˆ${lm.name}ï¼‰`);
          pushLog('â— HP/MP ãŒ ã‹ã„ãµãã—ãŸ');
        } else {
          addXP(lm.xp, `ã¡ã¦ã‚“ï¼ˆ${lm.name}ï¼‰`);
          hp = clamp(hp + 2, 0, maxHp);
          mp = clamp(mp + 1, 0, maxMp);
        }

        nextLandmarkX += LANDMARK_MIN + Math.floor(rng()*(LANDMARK_MAX-LANDMARK_MIN));
      }

      // activeé€²è¡Œ
      if (active){
        active.t += dt;

        if (active.type === 'battle' || active.type === 'boss'){
          const targetX = hero.x + 230;
          const approachSpeed = 520;
          if (active.mx > targetX) active.mx -= approachSpeed * dt;
        }

        if (active.type === 'event'){
          if (active.t >= 1.05) active = null;

        } else if (active.type === 'battle'){
          if (active.t >= 0.70 && active.phase === 0){
            active.phase = 1;
            doAttackEffect(active);
          }
          if (active.t >= 1.15 && active.phase === 1){
            active.phase = 2;
            spawnPuff(active.mx, active.my, heroClass.main);
            SFX.hit();
            pushLog(`â†’ ${active.monster.name} ã‚’ ãŸãŠã—ãŸ` + (active.rare ? 'ï¼ˆãƒ¬ã‚¢ï¼‰' : ''));
            kills += 1;
            addXP(active.rare ? (18 + Math.floor(rng()*10)) : (10 + Math.floor(rng()*6)), active.rare ? 'ãƒ¬ã‚¢è¨ä¼' : 'è¨ä¼');
            mp = clamp(mp - (heroClass.key==='mage' ? 2 : 1), 0, maxMp);
            hp = clamp(hp - (active.rare ? 2 : 1), 0, maxHp);

            if (active.rare){
              rareCount += 1;
              spawnBurst(active.mx, active.my - 10, 'rgba(255,215,90,0.95)');
              rareAura = clamp(rareAura + 0.10, 0, 1);
            } else {
              rareAura = clamp(rareAura - 0.04, 0, 1);
            }
            showMsg(`${active.monster.name} ã‚’ ãŸãŠã—ãŸ`, 1.0, 'win');
          }
          if (active.t >= 1.40){
            active = null;
          }

        } else if (active.type === 'boss'){
          if (active.t >= 0.85 && active.phase === 0){
            active.phase = 1;
            doBossAttackEffect(active);
          }
          if (active.t >= 1.40 && active.phase === 1){
            active.phase = 2;
            spawnPuff(active.mx, active.my, 'rgba(255,255,255,0.9)');
            SFX.hit();
            pushLog(`â†’ ${active.boss.name} ã‚’ ã—ã‚Šãã‘ãŸ`);
            addXP(22 + Math.floor(rng()*10), 'ãƒœã‚¹');
            hp = clamp(hp - 2, 0, maxHp);
            mp = clamp(mp - 1, 0, maxMp);
            spawnBurst(active.mx, active.my - 12, 'rgba(255,90,90,0.95)');
            showMsg(`${active.boss.name} ã‚’ ã—ã‚Šãã‘ãŸï¼`, 1.0, 'bosswin');
          }
          if (active.t >= 1.75){
            active = null;
          }

        } else if (active.type === 'item'){
          if (active.t >= 1.00) active = null;

        } else if (active.type === 'landmark'){
          if (active.t >= 1.10) active = null;
        }
      }

      // è»¢å€’åˆ¤å®š
      const chaos = (rng() - 0.5) * 0.95;
      const slopeRisk = Math.abs(slope) / 30;
      const fatigue = dist * 0.00018;
      const p = FALL_RATE * (0.55 + slopeRisk + fatigue) * (1 + chaos);
      if (rng() < clamp(p, 0, 0.16) * dt * 60){
        startFalling();
      }

      if (best >= 180) hero.crown = true;

    } else if (mode === MODE.FALLING){
      if (active) active.t += dt;

      hero.vy += GRAVITY * dt;
      hero.y += hero.vy * 24 * dt;
      hero.rag += hero.ragV * dt;
      hero.ragV *= (1 - 0.9*dt);

      const gy = groundY(hero.x) - 42;
      if (hero.y > gy){
        hero.y = gy;
        hero.vy *= -0.35;
        hero.ragV *= 0.85;
        if (Math.abs(hero.vy) < 2.0) hero.vy = 0;
      }

      hero.x += 110 * dt;
      camX += ((hero.x - (VW*0.35)) - camX) * (1 - Math.pow(1 - CAMERA_LAG, dt * 60));

      if (active && active.t >= FALL_SHOW_SEC){
        finalizeResult();
      }
    }
  }

  // ==============================
  // Renderï¼ˆDQã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼šå¤§ãã„ãƒ»ç™½æ é»’èƒŒæ™¯ï¼‰
  // ==============================
  function render(){
    const W = VW, H = VH;

    ctx.clearRect(0,0,W,H);

    // èƒŒæ™¯
    const bg = ctx.createLinearGradient(0,0,0,H);
    bg.addColorStop(0, '#06112a');
    bg.addColorStop(1, '#02040a');
    ctx.fillStyle = bg;
    ctx.fillRect(0,0,W,H);

    // world
    ctx.save();
    ctx.translate(-camX, 0);

    // ground
    ctx.beginPath();
    const startX = camX - 120;
    const endX = camX + W + 120;
    ctx.moveTo(startX, H);
    for (let x = startX; x <= endX; x += 12){
      ctx.lineTo(x, groundY(x));
    }
    ctx.lineTo(endX, H);
    ctx.closePath();
    ctx.fillStyle = 'rgba(255,255,255,0.045)';
    ctx.fill();

    ctx.beginPath();
    for (let x = startX; x <= endX; x += 10){
      ctx.lineTo(x, groundY(x));
    }
    ctx.strokeStyle = 'rgba(255,255,255,0.10)';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Active objects
    if (active && active.type === 'landmark' && mode === MODE.RUN){
      drawLandmark(active);
    }
    if (active && mode === MODE.RUN){
      if (active.type === 'battle') drawMonster(active);
      if (active.type === 'boss') drawBoss(active);
    }
    if (active && active.type === 'item' && mode === MODE.RUN){
      drawItem(active, hero.x + 520, groundY(hero.x + 520) - 120);
    }

    // hero
    const running = (mode === MODE.RUN);
    const ang = running ? hero.tilt : (hero.rag + 1.1);
    drawHero(hero.x, hero.y, ang, running);

    drawParticlesWorld();

    ctx.restore();

    // HUD windows
    drawHUD(W, H);

    if (mode === MODE.READY){
      drawCenterCard(W, H, 'ã‚¿ãƒƒãƒ—ã§ ã¼ã†ã‘ã‚“', 'ã—ã‚‡ããã‚‡ã†ã¯ ã‹ã£ã¦ã« ãã¾ã‚Šã¾ã™');
    } else if (mode === MODE.RESULT){
      drawResultCard(W, H);
    }
  }

  function uiScale(){
    // æ–‡å­—ã‚’å¤§ããã€‚ç«¯æœ«å¹…ã«åˆã‚ã›ã¦å€ç‡ä¸Šã’ã‚‹
    const s = clamp(VW / 900, 1.10, 1.75);
    return s;
  }

  function dqWindow(x, y, w, h, r=8){
    // outer white
    roundRect(x, y, w, h, r);
    ctx.fillStyle = '#ffffff';
    ctx.fill();

    // inner black
    roundRect(x+6, y+6, w-12, h-12, Math.max(3, r-3));
    ctx.fillStyle = '#000000';
    ctx.fill();

    // subtle inner border
    roundRect(x+9, y+9, w-18, h-18, Math.max(3, r-3));
    ctx.strokeStyle = 'rgba(255,255,255,0.22)';
    ctx.lineWidth = 2;
    ctx.stroke();
  }

  function drawHUD(W, H){
    const s = uiScale();

    // ç”»é¢ä¸Šä¸‹ã«å¤§çª“ã‚’ç½®ãï¼ˆDQã£ã½ã„ï¼‰
    const pad = Math.round(14 * s);
    const w = W - pad*2;
    const x = pad;

    // ä¸Šï¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆé«˜ã•ã¯æ§ãˆã‚ã ãŒæ–‡å­—ã¯å¤§ãã‚ï¼‰
    const topH = Math.round(148 * s);
    dqWindow(x, pad, w, topH, Math.round(10*s));

    ctx.fillStyle = '#ffffff';
    ctx.textAlign = 'left';

    const cls = heroClass ? heroClass.name : 'ï¼Ÿï¼Ÿï¼Ÿ';
    const wpn = equipped ? `${equipped.icon}${equipped.name}` : 'ã¶ãï¼šãªã—';

    ctx.font = `900 ${Math.round(24*s)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText('ã¼ã†ã‘ã‚“', x + Math.round(18*s), pad + Math.round(36*s));

    ctx.font = `900 ${Math.round(22*s)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText(`ã—ã‚‡ããã‚‡ã†ï¼š${cls}  Lv${level}`, x + Math.round(18*s), pad + Math.round(72*s));

    ctx.font = `800 ${Math.round(20*s)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText(`${wpn}`, x + Math.round(18*s), pad + Math.round(104*s));

    // å³ï¼šè·é›¢ã¨è¨ä¼ï¼ˆå¤§ããï¼‰
    ctx.textAlign = 'right';
    ctx.font = `950 ${Math.round(26*s)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText(`ãã‚‡ã‚Š ${fmt(dist)}`, x + w - Math.round(18*s), pad + Math.round(44*s));

    ctx.font = `900 ${Math.round(20*s)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText(`ã¨ã†ã°ã¤ ${kills}  ãƒ¬ã‚¢${rareCount}`, x + w - Math.round(18*s), pad + Math.round(78*s));
    ctx.fillText(`EXP ${xp}/${nextXp}`, x + w - Math.round(18*s), pad + Math.round(110*s));

    // HP/MPï¼ˆãƒãƒ¼ã‚‚å¤§ããï¼‰
    const barX = x + Math.round(18*s);
    const barY = pad + Math.round(118*s);
    drawBar(barX, barY, Math.round(260*s), Math.round(14*s), hp / Math.max(1,maxHp), 'HP', s);
    drawBar(barX, barY + Math.round(20*s), Math.round(260*s), Math.round(14*s), mp / Math.max(1,maxMp), 'MP', s);

    // ä¸‹ï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå¤§çª“ï¼šç”»é¢ã®ç´„42%ï¼‰
    const msgH = Math.round(H * 0.42);
    const my = H - msgH - pad;
    dqWindow(x, my, w, msgH, Math.round(10*s));

    // 1è¡Œç›®ï¼šä»Šèµ·ãã¦ã‚‹ã“ã¨ï¼ˆæœ€é‡è¦ï¼‰
    ctx.textAlign = 'left';
    ctx.fillStyle = '#ffffff';
    const mainLine = msg.text || (mode===MODE.RUN ? '...' : 'ã‚¿ãƒƒãƒ—ã—ã¦ ã¼ã†ã‘ã‚“');

    ctx.font = `950 ${Math.round(34*s)}px ui-sans-serif, system-ui, -apple-system`;
    wrapText(mainLine, x + Math.round(18*s), my + Math.round(48*s), w - Math.round(36*s), Math.round(40*s), 2);

    // ãƒ­ã‚°3è¡Œï¼ˆä½•ãŒèµ·ããŸã‹ï¼‰
    ctx.font = `800 ${Math.round(22*s)}px ui-sans-serif, system-ui, -apple-system`;
    const recent = logLines.slice(-3);
    const baseY = my + msgH - Math.round(28*s);
    for (let i=0;i<recent.length;i++){
      ctx.fillText(recent[i], x + Math.round(18*s), baseY - (2-i)*Math.round(26*s));
    }
  }

  function drawBar(x, y, w, h, ratio, label, s){
    ratio = clamp(ratio, 0, 1);
    // white border
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(x, y, w, h);
    // black inside
    ctx.fillStyle = '#000000';
    ctx.fillRect(x+2, y+2, w-4, h-4);

    // fill
    ctx.fillStyle = (label === 'HP') ? 'rgba(124,247,194,0.85)' : 'rgba(124,201,255,0.85)';
    ctx.fillRect(x+3, y+3, Math.max(0, (w-6)*ratio), h-6);

    ctx.fillStyle = '#ffffff';
    ctx.font = `900 ${Math.round(18*s)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.textAlign = 'left';
    ctx.fillText(label, x + w + Math.round(10*s), y + h - Math.round(1*s));
  }

  function drawCenterCard(W, H, title, sub){
    const s = uiScale();
    const cw = Math.min(Math.round(W * 0.92), W - Math.round(36*s));
    const ch = Math.round(320*s);
    const cx = (W - cw)/2;
    const cy = (H - ch)/2 - Math.round(10*s);

    // èƒŒæ™¯æš—è»¢
    ctx.save();
    ctx.globalAlpha = 0.35;
    ctx.fillStyle = '#000';
    ctx.fillRect(0,0,W,H);
    ctx.restore();

    dqWindow(cx, cy, cw, ch, Math.round(10*s));

    ctx.fillStyle = '#ffffff';
    ctx.textAlign = 'left';
    ctx.font = `950 ${Math.round(36*s)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText(title, cx + Math.round(22*s), cy + Math.round(76*s));

    ctx.font = `900 ${Math.round(22*s)}px ui-sans-serif, system-ui, -apple-system`;
    wrapText(sub, cx + Math.round(22*s), cy + Math.round(130*s), cw - Math.round(44*s), Math.round(30*s), 3);

    ctx.font = `900 ${Math.round(22*s)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚° Top3', cx + Math.round(22*s), cy + ch - Math.round(86*s));

    ctx.font = `800 ${Math.round(20*s)}px ui-sans-serif, system-ui, -apple-system`;
    const top3 = ranking.slice(0,3);
    for (let i=0;i<top3.length;i++){
      const r = top3[i];
      ctx.fillText(`${i+1}. ${r.dist.toFixed(1)}m  ${r.cls} Lv${r.lv}`, cx + Math.round(22*s), cy + ch - Math.round(54*s) + i*Math.round(26*s));
    }
  }

  // RESULTï¼šDQé¢¨ã€Œã¯ã„ï¼ã„ã„ãˆã€
  const yesNo = { yes:null, no:null }; // å½“ãŸã‚Šåˆ¤å®šã®çŸ©å½¢ã‚’æ¯å›æ›´æ–°

  function drawResultCard(W, H){
    const s = uiScale();
    const cw = Math.min(Math.round(W * 0.92), W - Math.round(36*s));
    const ch = Math.round(Math.min(H * 0.72, 560*s));
    const cx = (W - cw)/2;
    const cy = (H - ch)/2 - Math.round(6*s);

    // èƒŒæ™¯æš—è»¢
    ctx.save();
    ctx.globalAlpha = 0.42;
    ctx.fillStyle = '#000';
    ctx.fillRect(0,0,W,H);
    ctx.restore();

    dqWindow(cx, cy, cw, ch, Math.round(10*s));

    ctx.fillStyle = '#ffffff';
    ctx.textAlign = 'left';

    ctx.font = `950 ${Math.round(36*s)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText('ãƒªã‚¶ãƒ«ãƒˆ', cx + Math.round(22*s), cy + Math.round(70*s));

    // è·é›¢ã¯å³ä¸Šå¤§è¡¨ç¤º
    ctx.textAlign = 'right';
    ctx.font = `950 ${Math.round(40*s)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText(`${fmt(dist)}`, cx + cw - Math.round(22*s), cy + Math.round(70*s));

    ctx.textAlign = 'left';
    ctx.font = `900 ${Math.round(22*s)}px ui-sans-serif, system-ui, -apple-system`;

    const cls = heroClass ? heroClass.name : 'ï¼Ÿï¼Ÿï¼Ÿ';
    const wpn = equipped ? `${equipped.icon}${equipped.name}` : 'ãªã—';
    ctx.fillText(`ã—ã‚‡ããã‚‡ã†ï¼š${cls}  Lv${level}`, cx + Math.round(22*s), cy + Math.round(124*s));
    ctx.fillText(`ã—ã‚‡ã†ã”ã†ï¼š${title || 'â€”'}`, cx + Math.round(22*s), cy + Math.round(156*s));
    ctx.fillText(`ã¨ã†ã°ã¤ï¼š${kills}ï¼ˆãƒ¬ã‚¢${rareCount}ï¼‰`, cx + Math.round(22*s), cy + Math.round(188*s));
    ctx.fillText(`ã¶ãï¼š${wpn}`, cx + Math.round(22*s), cy + Math.round(220*s));

    // æ­»å› ã§ã‹ã
    ctx.font = `950 ${Math.round(30*s)}px ui-sans-serif, system-ui, -apple-system`;
    wrapText(`ã—ã«ã‹ãŸï¼š${lastCause || 'â€”'}`, cx + Math.round(22*s), cy + Math.round(274*s), cw - Math.round(44*s), Math.round(36*s), 2);

    // ã¯ã„ï¼ã„ã„ãˆï¼ˆDQé¢¨ï¼‰
    const qy = cy + ch - Math.round(170*s);
    ctx.font = `950 ${Math.round(28*s)}px ui-sans-serif, system-ui, -apple-system`;
    ctx.fillText('ã‚‚ã†ã„ã¡ã© ãŸã³ã«ã§ã¾ã™ã‹ï¼Ÿ', cx + Math.round(22*s), qy);

    // é¸æŠçª“
    const boxW = Math.round(320*s);
    const boxH = Math.round(140*s);
    const bx = cx + cw - boxW - Math.round(22*s);
    const by = cy + ch - boxH - Math.round(22*s);
    dqWindow(bx, by, boxW, boxH, Math.round(10*s));

    // ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆã‚¿ãƒƒãƒ—ã—ã‚„ã™ãå¤§ãã„è¡Œé–“ï¼‰
    const lineH = Math.round(52*s);
    ctx.textAlign = 'left';
    ctx.fillStyle = '#ffffff';
    ctx.font = `950 ${Math.round(34*s)}px ui-sans-serif, system-ui, -apple-system`;

    const yesX = bx + Math.round(26*s);
    const yesY = by + Math.round(54*s);
    const noX  = bx + Math.round(26*s);
    const noY  = by + Math.round(54*s) + lineH;

    ctx.fillText('ã¯ã„', yesX, yesY);
    ctx.fillText('ã„ã„ãˆ', noX, noY);

    // å½“ãŸã‚Šåˆ¤å®šæ›´æ–°ï¼ˆCSSãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™ï¼‰
    yesNo.yes = { x: bx, y: by, w: boxW, h: Math.round(boxH/2) };
    yesNo.no  = { x: bx, y: by + Math.round(boxH/2), w: boxW, h: Math.round(boxH/2) };

    // çŸ¢å°ã‚«ãƒ¼ã‚½ãƒ«ï¼ˆDQæ„Ÿï¼‰
    ctx.fillText('â–¶', bx + Math.round(8*s), yesY);
  }

  function hitTestYesNo(x,y){
    if (!yesNo.yes || !yesNo.no) return null;
    const inRect = (r)=> (x>=r.x && x<=r.x+r.w && y>=r.y && y<=r.y+r.h);
    if (inRect(yesNo.yes)) return 'yes';
    if (inRect(yesNo.no)) return 'no';
    return null;
  }

  // ==============================
  // World draw
  // ==============================
  function drawLandmark(ev){
    ctx.save();
    ctx.translate(ev.x, ev.y);
    ctx.globalAlpha = 0.98;
    ctx.font = '32px ui-sans-serif, system-ui, -apple-system';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(ev.data.icon, 0, 0);
    ctx.globalAlpha = 0.9;
    ctx.fillStyle = '#ffffff';
    ctx.font = '18px ui-sans-serif, system-ui, -apple-system';
    ctx.fillText(ev.data.name, 0, 34);
    ctx.restore();
  }

  function drawBoss(ev){
    ctx.save();
    ctx.translate(ev.mx, ev.my);

    ctx.globalAlpha = 0.22;
    ctx.beginPath();
    ctx.arc(0, 0, 72, 0, Math.PI*2);
    ctx.fillStyle = 'rgba(255,90,90,0.55)';
    ctx.fill();

    ctx.globalAlpha = 1;
    ctx.font = '54px ui-sans-serif, system-ui, -apple-system';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillStyle = '#ffffff';
    ctx.fillText(ev.boss.icon, 0, 0);

    ctx.globalAlpha = 0.92;
    ctx.font = '18px ui-sans-serif, system-ui, -apple-system';
    ctx.fillText(ev.boss.name, 0, 52);

    ctx.restore();
  }

  function drawMonster(ev){
    ctx.save();
    ctx.translate(ev.mx, ev.my);
    ctx.globalAlpha = 1;
    ctx.font = ev.rare ? '44px ui-sans-serif, system-ui, -apple-system' : '38px ui-sans-serif, system-ui, -apple-system';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillStyle = '#ffffff';
    ctx.fillText(ev.monster.icon, 0, 0);

    ctx.globalAlpha = ev.rare ? 0.28 : 0.18;
    ctx.beginPath();
    ctx.arc(0, 0, ev.rare ? 36 : 28, 0, Math.PI*2);
    ctx.fillStyle = ev.rare ? 'rgba(255,215,90,0.65)' : (heroClass ? heroClass.main : 'rgba(255,255,255,0.6)');
    ctx.fill();

    ctx.restore();
  }

  function drawItem(ev, x, y){
    ctx.save();
    ctx.translate(x, y);
    const it = ev.data;
    ctx.globalAlpha = 1;
    ctx.font = (it.rare ? 36 : 30) + 'px ui-sans-serif, system-ui, -apple-system';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillStyle = '#ffffff';
    ctx.fillText(it.icon, 0, 0);
    if (it.rare){
      ctx.globalAlpha = 0.22;
      ctx.beginPath();
      ctx.arc(0, 0, 36, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(255,215,90,0.75)';
      ctx.fill();
    }
    ctx.restore();
  }

  function drawParticlesWorld(){
    for (const p of particles){
      ctx.save();
      ctx.translate(p.x, p.y);
      const a = clamp(p.life / 0.6, 0, 1);
      ctx.globalAlpha = 0.85 * a;

      if (p.kind === 'slash'){
        ctx.strokeStyle = p.color;
        ctx.lineWidth = 5;
        ctx.beginPath();
        ctx.moveTo(-18, -12);
        ctx.lineTo(18, 12);
        ctx.stroke();
      } else if (p.kind === 'spark'){
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(0, 0, 4, 0, Math.PI*2);
        ctx.fill();
      } else {
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(0, 0, 6, 0, Math.PI*2);
        ctx.fill();
      }
      ctx.restore();
    }
  }

  // ==============================
  // Heroï¼ˆé’ã„å‹‡è€…ï¼‹ç›¾ï¼‹å‰£ï¼šæç¤ºç”»åƒå¯„ã›ï¼‰
  //  - ãƒ‰ãƒƒãƒˆçµµé¢¨ã« fillRect ã§æç”»
  // ==============================
  function drawHero(x, y, tilt, running){
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(tilt);

    // shadow
    ctx.save();
    ctx.globalAlpha = 0.25;
    ctx.fillStyle = 'rgba(0,0,0,0.75)';
    ctx.beginPath();
    ctx.ellipse(0, 84, 52, 14, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();

    const s = 4.0; // å¤§ãã‚äºŒé ­èº«
    const px = (dx, dy, w, h, c, a=1) => {
      ctx.save();
      ctx.globalAlpha = a;
      ctx.fillStyle = c;
      ctx.fillRect(Math.round(dx*s), Math.round(dy*s), Math.round(w*s), Math.round(h*s));
      ctx.restore();
    };

    // è‰²ï¼ˆé’å‹‡è€…ï¼‰
    const OUT = 'rgba(0,0,0,0.65)';
    const BLUE = '#3f86ff';
    const BLUE2 = '#2f66d8';
    const WHITE = '#ffffff';
    const SKIN = '#f2b7a7';
    const STEEL = '#dfe8ff';
    const swing = running ? Math.sin(hero.step)*1.7 : 0;
    const leg = running ? Math.sin(hero.step)*1.7 : 0;

    // å·¦ä¸ŠåŸºæº–ã¸
    ctx.translate(-14*s, -30*s);

    // ã‹ã‚‰ã å¤–æ 
    px(6, 2, 16, 30, OUT, 0.18);

    // ãƒ˜ãƒ«ãƒ¡ãƒƒãƒˆï¼ˆé’ï¼‹ç™½ãƒ©ã‚¤ãƒ³ï¼‰
    px(7, 2, 14, 10, BLUE, 1);
    px(8, 4, 12, 3, WHITE, 1);        // ã²ãŸã„ã®ç™½å¸¯
    px(8, 7, 12, 1, BLUE2, 1);

    // é¡”
    px(9, 8, 10, 6, SKIN, 1);

    // ç›®ï¼ˆé»’ï¼‰
    px(11, 10, 1, 1, '#000', 1);
    px(16, 10, 1, 1, '#000', 1);

    // èƒ´ä½“ï¼ˆé’é§ï¼‰
    px(8, 14, 12, 10, BLUE, 1);
    px(8, 18, 12, 2, WHITE, 0.95);    // èƒ¸ã®ç™½ãƒ©ã‚¤ãƒ³
    px(10, 16, 2, 2, WHITE, 0.9);
    px(16, 16, 2, 2, WHITE, 0.9);

    // è…•ï¼ˆå³ï¼šå‰£ã€å·¦ï¼šç›¾ï¼‰
    px(5, 15 + swing*0.4, 3, 10, SKIN, 0.95);
    px(20, 15 - swing*0.4, 3, 10, SKIN, 0.95);

    // æ‰‹è¢‹
    px(5, 23 + swing*0.4, 3, 2, BLUE2, 1);
    px(20, 23 - swing*0.4, 3, 2, BLUE2, 1);

    // è¶³
    px(10, 24, 5, 9, BLUE, 1);
    px(15, 24 + leg*0.2, 5, 9, BLUE, 1);
    // ãƒ–ãƒ¼ãƒ„
    px(10, 32, 5, 3, BLUE2, 1);
    px(15, 32 + leg*0.2, 5, 3, BLUE2, 1);

    // ç›¾ï¼ˆå·¦æ‰‹å´ï¼šå‰é¢ï¼‰
    // ç™½æ é’ç›¾ + ä¸­å¤®ãƒãƒ¼ã‚¯
    px(2, 17, 6, 10, WHITE, 1);
    px(3, 18, 4, 8, BLUE, 1);
    px(4, 21, 2, 2, WHITE, 1);

    // å‰£ï¼ˆå³æ‰‹å´ï¼šéŠ€ï¼‰
    ctx.save();
    ctx.globalAlpha = 0.95;
    ctx.strokeStyle = STEEL;
    ctx.lineWidth = 5;
    ctx.lineCap = 'square';
    ctx.beginPath();
    ctx.moveTo(24*s, (20 + swing*0.2)*s);
    ctx.lineTo(36*s, (6 - swing*0.2)*s);
    ctx.stroke();
    // æŸ„
    ctx.strokeStyle = '#7a5a2a';
    ctx.lineWidth = 6;
    ctx.beginPath();
    ctx.moveTo(22*s, (22 + swing*0.2)*s);
    ctx.lineTo(25*s, (19 + swing*0.2)*s);
    ctx.stroke();
    ctx.restore();

    // å† ï¼ˆãƒ™ã‚¹ãƒˆæ¡ä»¶ï¼‰
    if (hero.crown){
      px(12, -2, 8, 3, 'rgba(255,215,90,0.95)', 1);
      px(12, -4, 2, 2, 'rgba(255,215,90,0.95)', 1);
      px(18, -4, 2, 2, 'rgba(255,215,90,0.95)', 1);
    }

    ctx.restore();
  }

  // ==============================
  // Effects
  // ==============================
  function doAttackEffect(ev){
    const mx = ev.mx;
    const my = ev.my;
    particles.push({ x:mx-28, y:my-10, vx:-120, vy:-40, life:0.30, kind:'slash', color:'rgba(255,255,255,0.9)' });
    spawnPuff(mx, my, heroClass ? heroClass.main : 'rgba(255,255,255,0.9)');
    if (ev.rare){
      spawnBurst(mx, my - 10, 'rgba(255,215,90,0.95)');
    }
  }
  function doBossAttackEffect(ev){
    const mx = ev.mx;
    const my = ev.my;
    spawnBurst(mx, my - 12, 'rgba(255,90,90,0.95)');
    for (let i=0;i<10;i++){
      const a = rng()*Math.PI*2;
      const sp = 320 + rng()*360;
      particles.push({ x:mx, y:my, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp - 160, life:0.55 + rng()*0.28, kind:'spark', color:'rgba(255,90,90,0.85)' });
    }
  }
  function spawnPuff(x,y,color){
    for (let i=0;i<10;i++){
      const a = rng()*Math.PI*2;
      const sp = 160 + rng()*220;
      particles.push({ x, y, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp - 120, life:0.35 + rng()*0.25, kind:'puff', color });
    }
  }
  function spawnBurst(x,y,color){
    for (let i=0;i<18;i++){
      const a = rng()*Math.PI*2;
      const sp = 220 + rng()*360;
      particles.push({ x, y, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp - 180, life:0.55 + rng()*0.30, kind:'spark', color });
    }
  }

  // ==============================
  // Primitives
  // ==============================
  function roundRect(x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  function wrapText(text, x, y, maxWidth, lineHeight, maxLines){
    const chars = String(text).split('');
    let line = '';
    let lines = 0;
    for (let i=0;i<chars.length;i++){
      const test = line + chars[i];
      const w = ctx.measureText(test).width;
      if (w > maxWidth && line){
        ctx.fillText(line, x, y + lines*lineHeight);
        lines += 1;
        line = chars[i];
        if (lines >= maxLines) return;
      } else {
        line = test;
      }
    }
    ctx.fillText(line, x, y + lines*lineHeight);
  }

  // ==============================
  // init
  // ==============================
  showMsg('ã‚¿ãƒƒãƒ—ã—ã¦ ã¼ã†ã‘ã‚“', 1.0, 'ready');

})();
</script>
</body>
</html>
