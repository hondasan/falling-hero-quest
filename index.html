<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ÂãáËÄÖ„ÅåÂãùÊâã„Å´Ëª¢„Å∂ÂÜíÈô∫</title>
<style>
    :root {
        --bg-color: #000;
        --text-color: #fff;
        --font-main: "Courier New", Courier, monospace, sans-serif;
    }
    body {
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: var(--font-main);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        overflow: hidden;
        user-select: none;
        -webkit-user-select: none;
        touch-action: none;
    }
    
    /* „Ç¢„Çπ„Éö„ÇØ„ÉàÊØî16:9„ÇíÁ∂≠ÊåÅ„Åó„Å¶ÊúÄÂ§ßË°®Á§∫ */
    #gameContainer {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #gameCanvas {
        max-width: 100%;
        max-height: 100%;
        aspect-ratio: 16 / 9;
        object-fit: contain;
        image-rendering: pixelated;
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
    }

    .controls {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        flex-direction: column;
        gap: 5px;
        z-index: 100;
        opacity: 0.7;
    }
    .controls:hover { opacity: 1; }

    button {
        background: #000;
        color: white;
        border: 2px solid #fff;
        padding: 8px 12px;
        font-family: var(--font-main);
        font-size: 12px;
        border-radius: 4px;
        cursor: pointer;
        text-align: left;
        width: 110px;
        touch-action: manipulation;
    }
    button:active { background: #333; }
</style>
</head>
<body>

<div id="gameContainer">
    <canvas id="gameCanvas" width="1280" height="720"></canvas>
</div>

<div class="controls">
    <button id="btnSE">‚ô™ SE: OFF</button>
    <button id="btnVib">üì≥ Vib: OFF</button>
</div>

<script>
(() => {

const C = {
    Screen: { W: 1280, H: 720 },
    Game: {
        BASE_SPEED: 4,
        SPEED_RAMP: 0.001,
        MAX_SPEED: 25,
        FALL_CHECK_RATE: 30,
        BASE_FALL_PROB: 0.05,
        FALL_SHOW_SEC: 3.0, // ÊºîÂá∫ÊôÇÈñì„ÇíÂ∞ë„ÅóÂª∂Èï∑
        EVENT_INTERVAL_MIN: 150,
        EVENT_INTERVAL_MAX: 400,
        POISON_CHANCE: 0.003,
        CRITICAL_RATE: 0.15
    },
    Colors: {
        PALETTE: [null, '#2046C9', '#FFFFFF', '#FFCC99', '#8B4513', '#CCCCCC', '#E60012', '#102369', '#5B2503', '#888888', '#FF00FF', '#FFFF00']
    },
    // „Éâ„ÉÉ„ÉàÁµµÂÆöÁæ© (16x16)
    Sprites: {
        // ÂãáËÄÖ
        Hero: [
            [0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0],
            [0,0,0,0,1,1,2,2,2,1,1,0,0,0,0,0],
            [0,0,0,1,1,2,7,7,7,2,1,1,0,0,0,0],
            [0,0,0,1,2,7,2,2,2,7,2,1,0,0,0,0],
            [0,0,0,1,2,3,3,3,3,3,2,1,0,0,5,0], // 5=Ââ£
            [0,0,0,1,2,3,3,3,3,3,2,1,0,5,5,0],
            [0,0,0,1,1,2,3,3,3,2,1,1,5,5,9,0],
            [0,0,1,1,7,2,2,2,2,2,7,1,5,9,9,0],
            [0,1,1,7,1,1,1,6,1,1,1,7,1,4,0,0],
            [0,1,7,7,1,1,6,6,6,1,1,7,7,4,0,0],
            [0,1,1,7,1,1,1,6,1,1,1,7,1,0,0,0],
            [0,0,1,1,7,2,1,1,1,2,7,1,1,0,0,0],
            [0,0,0,1,1,1,7,0,7,1,1,1,0,0,0,0],
            [0,0,0,7,1,7,0,0,0,7,1,7,0,0,0,0],
            [0,0,7,7,1,1,0,0,0,1,1,7,7,0,0,0],
            [0,7,7,7,7,0,0,0,0,0,7,7,7,7,0,0]
        ],
        // Ê£∫Ê°∂
        Coffin: [
            [0,0,0,0,0,0,6,6,6,6,0,0,0,0,0,0],
            [0,0,0,0,0,6,11,6,6,11,6,0,0,0,0,0],
            [0,0,0,0,6,6,6,11,11,6,6,6,0,0,0,0],
            [0,0,0,6,6,6,6,6,6,6,6,6,6,0,0,0],
            [0,0,6,6,6,6,6,11,11,6,6,6,6,6,0,0],
            [0,0,6,6,6,6,6,11,11,6,6,6,6,6,0,0],
            [0,0,6,6,6,6,6,11,11,6,6,6,6,6,0,0],
            [0,0,6,6,6,6,6,6,6,6,6,6,6,6,0,0],
            [0,0,6,6,6,6,6,11,11,6,6,6,6,6,0,0],
            [0,0,6,6,6,6,6,11,11,6,6,6,6,6,0,0],
            [0,0,6,6,6,6,6,11,11,6,6,6,6,6,0,0],
            [0,0,6,6,6,6,6,11,11,6,6,6,6,6,0,0],
            [0,0,0,6,6,6,6,6,6,6,6,6,6,0,0,0],
            [0,0,0,0,6,6,6,6,6,6,6,6,0,0,0,0],
            [0,0,0,0,0,6,6,6,6,6,6,0,0,0,0,0],
            [0,0,0,0,0,0,6,6,6,6,0,0,0,0,0,0]
        ],
        // È≠Ç
        Soul: [
            [0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,1,2,2,1,0,0,0,0,0,0],
            [0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0],
            [0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0],
            [0,0,0,1,2,2,7,2,2,7,2,2,1,0,0,0],
            [0,0,0,1,2,2,7,2,2,7,2,2,1,0,0,0],
            [0,0,0,1,2,2,2,2,2,2,2,2,1,0,0,0],
            [0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0],
            [0,0,0,0,0,1,1,2,2,1,1,0,0,0,0,0],
            [0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
        ],
        // Ê±éÁî®„É¢„É≥„Çπ„Çø„ÉºÔºà„Çπ„É©„Ç§„É†È¢®Ôºâ
        Monster: [
            [0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],
            [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
            [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
            [0,0,0,1,1,2,1,1,1,1,2,1,1,0,0,0],
            [0,0,1,1,2,9,2,1,1,2,9,2,1,1,0,0],
            [0,1,1,1,2,9,2,1,1,2,9,2,1,1,1,0],
            [0,1,1,1,1,2,1,1,1,1,2,1,1,1,1,0],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
        ]
    }
};

/**
 * Audio System
 */
class SoundManager {
    constructor() {
        this.ctx = null;
        this.enabled = false;
        this.noiseBuffer = null;
    }
    init() {
        if (!this.ctx) {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (AudioContext) {
                this.ctx = new AudioContext();
                this.createNoiseBuffer();
            }
        }
        if (this.ctx && this.ctx.state === 'suspended') this.ctx.resume();
    }
    createNoiseBuffer() {
        if (!this.ctx) return;
        const bufferSize = this.ctx.sampleRate * 1.0;
        const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) {
            data[i] = Math.random() * 2 - 1;
        }
        this.noiseBuffer = buffer;
    }
    toggle() {
        this.enabled = !this.enabled;
        if (this.enabled) this.init();
        return this.enabled;
    }
    play(type) {
        if (!this.enabled || !this.ctx) return;
        const t = this.ctx.currentTime;

        const playTone = (freq, type, startTime, dur, vol=0.1) => {
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, startTime);
            gain.gain.setValueAtTime(vol, startTime);
            gain.gain.exponentialRampToValueAtTime(0.01, startTime + dur);
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start(startTime);
            osc.stop(startTime + dur);
        };

        switch (type) {
            case 'step':
                if (this.noiseBuffer) {
                    const src = this.ctx.createBufferSource();
                    src.buffer = this.noiseBuffer;
                    const gain = this.ctx.createGain();
                    const filter = this.ctx.createBiquadFilter();
                    filter.type = 'lowpass';
                    filter.frequency.value = 600;
                    src.connect(filter);
                    filter.connect(gain);
                    gain.connect(this.ctx.destination);
                    gain.gain.setValueAtTime(0.1, t);
                    gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
                    src.start(t);
                    src.stop(t + 0.1);
                }
                break;
            case 'cursor':
                playTone(1200, 'square', t, 0.08, 0.05);
                break;
            case 'decide':
                playTone(800, 'square', t, 0.1, 0.05);
                break;
            case 'start':
                const startMelody = [440, 440, 440, 587, 880];
                startMelody.forEach((f, i) => {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = 'square';
                    osc.frequency.value = f;
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    const st = t + i * 0.12;
                    gain.gain.setValueAtTime(0.05, st);
                    gain.gain.linearRampToValueAtTime(0, st + 0.1);
                    osc.start(st);
                    osc.stop(st + 0.12);
                });
                break;
            case 'hit':
                playTone(150, 'sawtooth', t, 0.1, 0.1);
                break;
            case 'critical':
                playTone(1500, 'square', t, 0.05, 0.1);
                playTone(1500, 'square', t+0.05, 0.05, 0.1);
                playTone(100, 'sawtooth', t+0.1, 0.3, 0.2);
                break;
            case 'levelup':
                const melody = [392, 392, 392, 523, 659, 784, 1047];
                let cursor = 0;
                const lens = [0.08, 0.08, 0.08, 0.3, 0.15, 0.15, 0.6];
                melody.forEach((f, i) => {
                    playTone(f, 'square', t + cursor, lens[i], 0.1);
                    playTone(f * 0.5, 'square', t + cursor, lens[i], 0.05);
                    cursor += lens[i];
                });
                break;
            case 'poison':
                playTone(100, 'sawtooth', t, 0.3, 0.1);
                break;
            case 'fall': // Âë™„ÅÑÈü≥
                const oscF = this.ctx.createOscillator();
                const gainF = this.ctx.createGain();
                oscF.type = 'square';
                oscF.frequency.setValueAtTime(150, t);
                oscF.frequency.linearRampToValueAtTime(100, t+0.1);
                oscF.frequency.linearRampToValueAtTime(150, t+0.2);
                oscF.frequency.linearRampToValueAtTime(100, t+0.3);
                gainF.gain.setValueAtTime(0.1, t);
                gainF.gain.linearRampToValueAtTime(0, t + 0.8);
                oscF.connect(gainF);
                gainF.connect(this.ctx.destination);
                oscF.start(t);
                oscF.stop(t + 0.8);
                break;
        }
    }
}

/**
 * Data
 */
const Data = {
    FallReasons: [
        "Ë∂≥„Åå „ÇÇ„Å§„Çå„ÅüÔºÅ", "„ÅÑ„Åó„Å´ „Å§„Åæ„Å•„ÅÑ„ÅüÔºÅ", "„Åè„Å§„Å≤„ÇÇ„Åå „Åª„Å©„Åë„ÅüÔºÅ", "„Åì„Åó„Çí „ÇÑ„Å£„ÅüÔºÅ", 
        "„Åò„ÇÅ„Çì„Åå „Åì„Åä„Å£„Å¶„ÅÑ„ÅüÔºÅ", "„Éê„Éä„Éä„ÅÆÁöÆ„Å†ÔºÅ", "„Åç„ÇÖ„ÅÜ„Å´ „Å≠„ÇÄ„Åè„Å™„Å£„ÅüÔºÅ", "„ÅÇ„Åó„ÅÆ„Åì„ÇÜ„Å≥„Çí „Å∂„Å§„Åë„ÅüÔºÅ",
        "„Åò„ÇÖ„ÅÜ„Çä„Çá„Åè„Å´ „Åæ„Åë„ÅüÔºÅ", "„Å™„Çì„Å®„Å™„Åè „Åì„Çç„Çì„Å†ÔºÅ", "„Åè„ÅÜ„Åµ„Åè„Åß „Åü„Åä„Çå„ÅüÔºÅ",
        "Ëá™ÂàÜ„ÅÆ„Éû„É≥„Éà„ÇíË∏è„Çì„Å†ÔºÅ", "„Çà„ÅùË¶ã„Çí„Åó„Å¶„ÅÑ„ÅüÔºÅ", "Ë∂≥„Åå„Å§„Å£„ÅüÔºÅ", "ÊÆµÂ∑Æ„Å´Ê∞ó„Å•„Åã„Å™„Åã„Å£„ÅüÔºÅ",
        "ÊÄ•„Å´Âº∑È¢®„ÅåÂêπ„ÅÑ„ÅüÔºÅ", "„Éè„Éà„Åå„Å∂„Å§„Åã„Å£„Å¶„Åç„ÅüÔºÅ", "Ë£ÖÂÇô„ÅåÈáç„Åô„Åé„ÅüÔºÅ", "ËÄÉ„Åà‰∫ã„Çí„Åó„Å¶„ÅÑ„ÅüÔºÅ",
        "Èù¥„ÅÆ„Çµ„Ç§„Ç∫„ÅåÂêà„Å£„Å¶„ÅÑ„Å™„ÅÑÔºÅ", "Âú∞Èù¢„ÅÆÊ®°Êßò„ÅåÊ∞ó„Å´„Å™„Å£„ÅüÔºÅ", "Ë¶ã„Åà„Å™„ÅÑ‰Ωï„Åã„Å´Ë∂≥„ÇíÊé¥„Åæ„Çå„ÅüÔºÅ",
        "„Åã„Å£„Åì„Çà„ÅèÊ≠©„Åì„ÅÜ„Å®„Åó„Å¶Â§±ÊïóÔºÅ", "„É¢„É≥„Çπ„Çø„Éº„Å´ „Åä„Å©„Çç„ÅÑ„ÅüÔºÅ", "ÂØù‰∏çË∂≥„Å†„Å£„ÅüÔºÅ",
        "‰∫∫Áîü„Å´Áñ≤„Çå„ÅüÔºÅ", "Âú∞ÁêÉ„ÅÆÂõûËª¢„Å´„Å§„ÅÑ„Å¶„ÅÑ„Åë„Å™„Åã„Å£„ÅüÔºÅ", "Èù¥„ÅÆ‰∏≠„Å´Áü≥„ÅåÂÖ•„Å£„ÅüÔºÅ", "MP„ÅåÂàá„Çå„ÅüÔºÅ"
    ],
    Monsters: [
        {name: "„Çπ„É©„Ç§„É†", exp: 5}, {name: "„Éâ„É©„Ç≠„Éº", exp: 8}, {name: "„Ç¥„Éº„Çπ„Éà", exp: 12}, 
        {name: "„Åå„ÅÑ„Åì„Å§", exp: 20}, {name: "„Éâ„É©„Ç¥„É≥", exp: 100}, {name: "„ÅØ„Åê„Çå„É°„Çø„É´", exp: 500},
        {name: "„Ç¥„Éñ„É™„É≥", exp: 15}, {name: "„Ç™„Éº„ÇØ", exp: 30}, {name: "„Ç≠„É°„É©", exp: 40}, 
        {name: "„Ç¥„Éº„É¨„É†", exp: 80}, {name: "„Åï„Åæ„Çà„ÅÜ„Çà„Çç„ÅÑ", exp: 50}, {name: "„Ç≠„É©„Éº„Éû„Ç∑„É≥", exp: 150},
        {name: "„Ç¢„Éº„ÇØ„Éá„Éº„É¢„É≥", exp: 200}, {name: "„Çä„ÇÖ„ÅÜ„Åä„ÅÜ(ÂÅΩ)", exp: 300}, {name: "„Ç´„É≥„ÉÄ„Çø", exp: 120}
    ],
    // Ê≠¶Âô®„ÇíÂé®‰∫åÁóÖ„Éª„Éç„ÇøÂ§ö„ÇÅ„Å´Â§ßÂπÖËøΩÂä†
    Weapons: [
        "„Å≤„ÅÆ„Åç„ÅÆ„Åº„ÅÜ", "„Åì„Çì„Åº„ÅÜ", "„Å©„ÅÜ„ÅÆ„Å§„Çã„Åé", "ÈâÑ„ÅÆÊßç", "„ÅØ„Åå„Å≠„ÅÆ„Å§„Çã„Åé",
        "„Éê„Éà„É´„Ç¢„ÉÉ„ÇØ„Çπ", "„Åæ„Å©„Çç„Åø„ÅÆÂâ£", "ÁÇé„ÅÆ„Å§„Çã„Åé", "„Ç¶„Ç©„Éº„Éè„É≥„Éû„Éº",
        "„Éâ„É©„Ç¥„É≥„Ç≠„É©„Éº", "„Çæ„É≥„Éì„Ç≠„É©„Éº", "„ÅØ„ÇÑ„Å∂„Åï„ÅÆ„Åë„Çì", "„Éê„Çπ„Çø„Éº„Éâ„ÇΩ„Éº„Éâ",
        "„Åç„Åõ„Åç„ÅÆ„Å§„Çã„Åé", "„É≠„Éà„ÅÆ„Å§„Çã„Åé", "Â§©Á©∫„ÅÆ„Å§„Çã„Åé", "„É°„Çø„É´„Ç≠„É≥„Ç∞„ÅÆÂâ£",
        "„Ç∞„É™„É≥„Ç¨„É†„ÅÆ„É†„ÉÅ", "Á†¥Â£ä„ÅÆÈâÑÁêÉ", "„Ç™„É™„Éè„É´„Ç≥„É≥„ÅÆÁà™", "„Ç¢„É´„ÉÜ„Éû„Ç¶„Çß„Éù„É≥",
        // „Éç„Çø„ÉªÂé®‰∫åÊû†
        "ÊºÜÈªí„ÅÆÈ≠îÂâ£", "ÁµÇÁÑâ„ÇíÂëº„Å∂Êùñ", "ÈÇ™Áúº„ÅÆ„Ç´„Çø„Éº„É´", "„É©„Ç∞„Éä„É≠„ÇØ", "Á•ûÊÆ∫„Åó„ÅÆÊßç",
        "ÊØç„Åï„Çì„ÅÆÂåÖ‰∏Å", "ÂÜ∑Âáç„Éû„Ç∞„É≠", "„Éî„Ç≥„Éî„Ç≥„Éè„É≥„Éû„Éº", "‰ºùË™¨„ÅÆ„Åü„Çè„Åó", "Â∞ÅÂç∞„Åï„Çå„ÅóÂè≥ËÖï",
        "Ë¶ã„Åà„Å™„ÅÑÂâ£", "„Ç®„ÇØ„Çπ„Ç´„É™„Éë„Éº", "Á´π„ÇÑ„Çä", "ÂãáËÄÖ„ÅÆË®ºÔºàÁâ©ÁêÜÔºâ", "„Éè„É™„Çª„É≥",
        "È≠îÂâ£„Ç∞„É©„É†", "„Ç≤„Ç§„Éú„É´„Ç∞", "„É¨„Éº„Éº„Ç∂„Éº„Éñ„É¨„Éº„Éâ"
    ],
    // „Ç¢„Ç§„ÉÜ„É†
    Items: [
        {name: "„ÇÑ„Åè„Åù„ÅÜ", effect: "heal", val: 15},
        {name: "‰∏ä„ÇÑ„Åè„Åù„ÅÜ", effect: "heal", val: 40},
        {name: "Áâπ„ÇÑ„Åè„Åù„ÅÜ", effect: "heal", val: 999},
        {name: "ÊØíÊ∂à„ÅóËçâ", effect: "cure_poison", val: 0},
        {name: "ÂÆà„Çä„ÅÆÁ®Æ", effect: "none", val: 0},
        {name: "Âäõ„ÅÆÁ®Æ", effect: "none", val: 0},
        {name: "‰∏çÊÄùË≠∞„Å™Êú®„ÅÆÂÆü", effect: "levelup", val: 0}
    ],
    // Áß∞Âè∑ÂÆöÁæ©ÔºàË∑ùÈõ¢mÔºâ - Âé®‰∫åÁóÖ„Éª„Éç„ÇøÂ¢óÈáè
    Titles: [
        {dist: 0, name: "„Åã„Åë„Å†„Åó"},
        {dist: 30, name: "„ÅÑ„Å£„Å±„Çì„Åò„Çì"},
        {dist: 100, name: "ÂÜíÈô∫ËÄÖ"},
        {dist: 200, name: "„Ç≥„É≠„Éì„Çπ„Éà"},
        {dist: 300, name: "„Çπ„Éö„É©„É≥„Ç´„Éº"},
        {dist: 400, name: "ÁÜüÁ∑¥ËÄÖ"},
        {dist: 500, name: "ÈÅî‰∫∫"},
        {dist: 600, name: "Èóá„ÅÆÁÇé„Å´Êä±„Åã„Çå„ÅóËÄÖ"},
        {dist: 700, name: "ÊôÇÁ©∫„ÅÆËø∑Â≠ê"},
        {dist: 800, name: "Ëã±ÈõÑ"},
        {dist: 900, name: "ÈÅ∏„Å∞„Çå„ÅóÂá°‰∫∫"},
        {dist: 1000, name: "‰ºùË™¨"},
        {dist: 1200, name: "Ê∑±Ê∑µ„ÅÆÂáùË¶ñËÄÖ"},
        {dist: 1500, name: "„Åü„Å†„ÅÆ„Åó„Åã„Å∞„Å≠"},
        {dist: 2000, name: "Á•û"}
    ],
    saveKey: 'hero_trips_v6',
    load() {
        try {
            const def = { best: 0, ranking: [], settings: { se: false, vib: true } };
            const json = localStorage.getItem(this.saveKey);
            if (!json) return def;
            const data = JSON.parse(json);
            if (!data.ranking) data.ranking = [];
            return data;
        } catch(e) { return { best: 0, ranking: [], settings: { se: false, vib: true } }; }
    },
    save(data) {
        try { localStorage.setItem(this.saveKey, JSON.stringify(data)); } catch(e){}
    }
};

/**
 * Game Class
 */
class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.ctx.imageSmoothingEnabled = false;

        this.sound = new SoundManager();
        this.data = Data.load();
        
        this.sound.enabled = this.data.settings.se;
        this.vibration = (navigator.vibrate && this.data.settings.vib);
        this.updateSettingBtns();

        this.state = 'TITLE';
        this.resultCursor = 0;
        this.flash = 0;
        
        // Êà¶ÈóòÊºîÂá∫Áî®
        this.battleAnim = { active: false, timer: 0, monster: null };

        this.resetGame();
        this.bindEvents();
        
        this.lastTime = 0;
        this.loop = this.loop.bind(this);
        requestAnimationFrame(this.loop);
    }

    bindEvents() {
        const handleInput = (e) => {
            e.preventDefault();
            const rect = this.canvas.getBoundingClientRect();
            
            // „Ç¢„Çπ„Éö„ÇØ„ÉàÊØîÁ∂≠ÊåÅ„Å´„Çà„ÇãÂÆüÈöõ„ÅÆÊèèÁîªÈ†òÂüü„ÇíË®àÁÆó
            const scaleX = this.canvas.width / rect.width;
            const scaleY = this.canvas.height / rect.height;
            
            let clientX = e.clientX;
            let clientY = e.clientY;
            if (e.type === 'touchstart' && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else if (e.type !== 'mousedown') return;

            // CanvasÂÜÖÂ∫ßÊ®ô„Å´Â§âÊèõ
            const x = (clientX - rect.left) * scaleX;
            const y = (clientY - rect.top) * scaleY;

            this.onTap(x, y);
        };

        this.canvas.addEventListener('touchstart', handleInput, {passive: false});
        this.canvas.addEventListener('mousedown', handleInput);

        document.getElementById('btnSE').addEventListener('click', (e) => {
            e.stopPropagation();
            const on = this.sound.toggle();
            this.data.settings.se = on;
            this.updateSettingBtns();
            Data.save(this.data);
        });
        document.getElementById('btnVib').addEventListener('click', (e) => {
            e.stopPropagation();
            if (!navigator.vibrate) return;
            this.vibration = !this.vibration;
            this.data.settings.vib = this.vibration;
            this.updateSettingBtns();
            Data.save(this.data);
        });
    }

    updateSettingBtns() {
        document.getElementById('btnSE').innerText = `‚ô™ SE: ${this.sound.enabled?'ON':'OFF'}`;
        document.getElementById('btnVib').innerText = `üì≥ Vib: ${this.vibration?'ON':'OFF'}`;
    }

    resetGame() {
        this.hero = {
            lv: 1, exp: 0, next: 20,
            hp: 20, maxHp: 20,
            dist: 0, speed: C.Game.BASE_SPEED,
            pos: {x: 300, y: 0},
            offsetY: 0,
            angle: 0,
            logs: ["„Åº„ÅÜ„Åë„Çì„Åå „ÅØ„Åò„Åæ„Å£„ÅüÔºÅ"],
            fallReason: null,
            weapon: "„Å≤„ÅÆ„Åç„ÅÆ„Åº„ÅÜ",
            title: "„Åã„Åë„Å†„Åó"
        };
        this.world = {
            bgOffset: 0,
            seed: Math.random() * 1000,
            particles: [],
            nextEventDist: C.Game.EVENT_INTERVAL_MIN + Math.random() * 200,
            zone: 'NORMAL'
        };
        this.timer = 0;
        this.battleAnim = { active: false, timer: 0 };
    }

    onTap(x, y) {
        this.sound.init();

        if (this.state === 'TITLE') {
            this.sound.play('decide');
            this.state = 'RUN';
            this.sound.play('start');
        } else if (this.state === 'RESULT') {
            const cx = C.Screen.W / 2;
            const wy = (C.Screen.H / 2) + 180; // ‰∏ãÈÉ®„Ç¶„Ç£„É≥„Éâ„Ç¶Âü∫Ê∫ñY

            // „ÅØ„ÅÑ/„ÅÑ„ÅÑ„Åà „Éú„Çø„É≥Âà§ÂÆöÁØÑÂõ≤ (Â∫É„ÇÅ„Å´)
            if (x > cx - 300 && x < cx + 300) {
                // „ÅØ„ÅÑ (Y: wy + 50 ‰ªòËøë)
                if (y > wy + 20 && y < wy + 80) {
                    this.resultCursor = 0;
                    this.sound.play('decide');
                    this.saveRecord(); // Âøµ„ÅÆ„Åü„ÇÅ‰øùÂ≠ò
                    this.resetGame();
                    this.state = 'RUN';
                    this.sound.play('start');
                }
                // „ÅÑ„ÅÑ„Åà (Y: wy + 100 ‰ªòËøë)
                else if (y > wy + 80 && y < wy + 140) {
                    this.resultCursor = 1;
                    this.sound.play('cursor');
                    this.saveRecord();
                    this.state = 'TITLE';
                }
            }
        }
    }

    update(dt) {
        if (this.flash > 0) this.flash -= dt * 5;

        // Êà¶Èóò„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰∏≠
        if (this.battleAnim.active) {
            this.battleAnim.timer -= dt;
            if (this.battleAnim.timer <= 0) {
                this.battleAnim.active = false;
            }
            return; // ÈÄ≤Ë°åÂÅúÊ≠¢
        }

        if (this.state === 'RUN') {
            if (this.hero.speed < C.Game.MAX_SPEED) {
                this.hero.speed += C.Game.SPEED_RAMP;
            }
            
            this.hero.dist += this.hero.speed;
            this.world.bgOffset += this.hero.speed;

            // Áß∞Âè∑Êõ¥Êñ∞
            const m = Math.floor(this.hero.dist / 10);
            for (let i = Data.Titles.length - 1; i >= 0; i--) {
                if (m >= Data.Titles[i].dist) {
                    this.hero.title = Data.Titles[i].name;
                    break;
                }
            }

            // Ë∂≥Èü≥ & ÊØí
            const stepInterval = this.world.zone === 'POISON' ? 60 : 100;
            if (Math.floor(this.hero.dist / stepInterval) > Math.floor((this.hero.dist - this.hero.speed) / stepInterval)) {
                this.sound.play('step');
                if (this.world.zone === 'POISON' && Math.random() < 0.2) {
                    this.hero.hp = Math.max(0, this.hero.hp - 1);
                    this.sound.play('poison');
                    this.flash = 0.5;
                    if (this.hero.hp <= 0) {
                        this.hero.fallReason = "ÊØí„ÅÆÊ≤ºÂú∞„Åß ÂäõÂ∞Ω„Åç„ÅüÔºÅ";
                        this.triggerFall();
                        return;
                    }
                }
            }

            // „Çæ„Éº„É≥Âàá„ÇäÊõø„Åà
            if (Math.random() < C.Game.POISON_CHANCE) {
                if (this.world.zone === 'NORMAL') {
                    this.world.zone = 'POISON';
                    this.hero.logs.unshift("ÊØí„ÅÆÊ≤ºÂú∞„Å´ Ë∂≥„ÇíË∏è„ÅøÂÖ•„Çå„ÅüÔºÅ");
                } else {
                    this.world.zone = 'NORMAL';
                    this.hero.logs.unshift("ÊØí„ÅÆÊ≤ºÂú∞„Çí Êäú„Åë„ÅüÔºÅ");
                }
            }

            // „Ç§„Éô„É≥„Éà
            if (this.hero.dist >= this.world.nextEventDist) {
                this.triggerEvent();
                this.world.nextEventDist = this.hero.dist + C.Game.EVENT_INTERVAL_MIN + Math.random() * (C.Game.EVENT_INTERVAL_MAX - C.Game.EVENT_INTERVAL_MIN);
            }

            // Ëª¢ÂÄíÂà§ÂÆö
            if (Math.random() < 0.1) {
                const risk = C.Game.BASE_FALL_PROB + (this.hero.speed / 1000); 
                if (Math.random() < risk) {
                    this.hero.fallReason = Data.FallReasons[Math.floor(Math.random() * Data.FallReasons.length)];
                    this.triggerFall();
                }
            }
        } else if (this.state === 'FALLING') {
            this.timer -= dt;
            if (this.timer <= 0) {
                this.state = 'RESULT';
                this.resultCursor = 0;
                this.saveRecord();
            }
        }
    }

    saveRecord() {
        const m = Math.floor(this.hero.dist / 10);
        // „Éô„Çπ„ÉàÊõ¥Êñ∞
        if (m > this.data.best) this.data.best = m;
        
        // „É©„É≥„Ç≠„É≥„Ç∞Êõ¥Êñ∞
        // ÈáçË§áÈò≤Ê≠¢ÔºöÂêå„ÅòË∑ùÈõ¢„Éª„Çø„Ç§„Éà„É´„ÅÆÊúÄÊñ∞„Å†„ÅëÊÆã„Åô„Åã„ÄÅÂçòÁ¥î„Å´ËøΩÂä†„Åô„Çã„Åã
        // „Åì„Åì„Åß„ÅØÂçòÁ¥îËøΩÂä†„Åó„Å¶„ÇΩ„Éº„Éà
        this.data.ranking.push({
            dist: m,
            title: this.hero.title,
            weapon: this.hero.weapon,
            date: new Date().toLocaleDateString()
        });
        
        // ÈôçÈ†Ü„ÇΩ„Éº„Éà
        this.data.ranking.sort((a, b) => b.dist - a.dist);
        // Top 5„ÅÆ„Åø‰øùÊåÅ
        this.data.ranking = this.data.ranking.slice(0, 5);
        
        Data.save(this.data);
    }

    triggerEvent() {
        const rand = Math.random();
        if (rand < 0.6) {
            this.battle();
        } else if (rand < 0.9) {
            this.findItem(); 
        } else {
            this.rest();
        }
    }

    battle() {
        const mon = Data.Monsters[Math.floor(Math.random() * Data.Monsters.length)];
        this.hero.logs.unshift(`${mon.name} „Åå„ÅÇ„Çâ„Çè„Çå„ÅüÔºÅ`);
        
        // Êà¶ÈóòÊºîÂá∫ON
        this.battleAnim.active = true;
        this.battleAnim.timer = 0.8; // 0.8ÁßíÂÅúÊ≠¢
        this.battleAnim.monster = mon;

        if (Math.random() < C.Game.CRITICAL_RATE) {
            setTimeout(() => {
                this.sound.play('critical');
                this.flash = 1.0;
                if (this.vibration) navigator.vibrate([50, 50, 50]);
                this.hero.logs.unshift(`‰ºöÂøÉ„ÅÆ‰∏ÄÊíÉÔºÅ ${mon.name} „Çí„Åü„Åä„Åó„ÅüÔºÅ`);
                this.gainExp(mon.exp * 2);
            }, 400);
        } else {
            setTimeout(() => {
                this.sound.play('hit');
                const dmg = Math.floor(Math.random() * 3);
                if (dmg > 0) {
                    this.hero.hp = Math.max(0, this.hero.hp - dmg);
                    this.hero.logs.unshift(`ÂãáËÄÖ„ÅØ ${dmg} „ÅÆ„ÉÄ„É°„Éº„Ç∏ÔºÅ`);
                } else {
                    this.hero.logs.unshift(`ÂãáËÄÖ„ÅØ „Å≤„Çâ„Çä„Å® „Åã„Çè„Åó„ÅüÔºÅ`);
                }
                this.hero.logs.unshift(`${mon.name} „Çí„Åü„Åä„Åó„ÅüÔºÅ`);
                this.gainExp(mon.exp);
            }, 400);
        }
    }

    findItem() {
        if (Math.random() < 0.5) {
            const weapon = Data.Weapons[Math.floor(Math.random() * Data.Weapons.length)];
            this.hero.weapon = weapon;
            this.hero.logs.unshift(`ÂÆùÁÆ±„Å†ÔºÅ ${weapon} „ÇíË£ÖÂÇô„Åó„ÅüÔºÅ`);
            this.sound.play('decide');
        } else {
            const item = Data.Items[Math.floor(Math.random() * Data.Items.length)];
            this.hero.logs.unshift(`ÂÆùÁÆ±„Å†ÔºÅ ${item.name} „ÇíË¶ã„Å§„Åë„ÅüÔºÅ`);
            if (item.effect === 'heal') {
                this.hero.hp = Math.min(this.hero.maxHp, this.hero.hp + item.val);
                this.hero.logs.unshift("HP„ÅåÂõûÂæ©„Åó„ÅüÔºÅ");
            } else if (item.effect === 'cure_poison') {
                if (this.world.zone === 'POISON') {
                    this.world.zone = 'NORMAL';
                    this.hero.logs.unshift("Âë®Âõ≤„ÅÆÊØí„ÅåÊ∂à„ÅàÂéª„Å£„ÅüÔºÅ");
                } else {
                    this.hero.logs.unshift("„Åó„Åã„Åó ‰Ωï„ÇÇËµ∑„Åç„Å™„Åã„Å£„Åü„ÄÇ");
                }
            } else if (item.effect === 'levelup') {
                this.gainExp(this.hero.next - this.hero.exp);
            } else {
                this.hero.logs.unshift("ÂãáËÄÖ„ÅØ Âäõ„Åå„Åø„Å™„Åé„Å£„ÅüÊ∞ó„Åå„Åó„ÅüÔºÅ");
            }
            this.sound.play('cursor');
        }
    }

    rest() {
        this.hero.hp = Math.min(this.hero.maxHp, this.hero.hp + 5);
        this.hero.logs.unshift("Ê≥â„ÇíË¶ã„Å§„Åë„Åü„ÄÇHP„ÅåÂ∞ë„ÅóÂõûÂæ©„Åó„ÅüÔºÅ");
        this.sound.play('cursor');
    }

    gainExp(val) {
        this.hero.exp += val;
        if (this.hero.exp >= this.hero.next) {
            this.hero.lv++;
            this.hero.next = Math.floor(this.hero.next * 1.5);
            this.hero.maxHp += 5;
            this.hero.hp = this.hero.maxHp;
            this.hero.logs.unshift(`„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ Lv${this.hero.lv} „Å´„Å™„Å£„ÅüÔºÅ`);
            this.sound.play('levelup');
            this.flash = 0.5;
        }
    }

    triggerFall() {
        this.state = 'FALLING';
        this.timer = C.Game.FALL_SHOW_SEC;
        this.sound.play('fall');
        if (this.vibration) navigator.vibrate(500);
        this.hero.logs.unshift(`ÁóõÊÅ®ÔºÅ ${this.hero.fallReason}`);
    }

    draw() {
        const ctx = this.ctx;
        const w = C.Screen.W;
        const h = C.Screen.H;

        // ËÉåÊôØ
        if (this.world.zone === 'POISON') {
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, '#220033');
            grad.addColorStop(1, '#440066');
            ctx.fillStyle = grad;
        } else {
            ctx.fillStyle = '#000000';
        }
        ctx.fillRect(0, 0, w, h);
        
        ctx.strokeStyle = '#FFFFFF';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(0, h * 0.7);
        ctx.lineTo(w, h * 0.7);
        ctx.stroke();

        ctx.fillStyle = this.world.zone === 'POISON' ? '#aa00cc' : '#FFFFFF';
        const groundY = h * 0.7;
        const offset = Math.floor(this.world.bgOffset) % 100;
        for (let i = -offset; i < w; i += 100) {
            ctx.fillRect(i, groundY + 10, 2, 2);
            ctx.fillRect(i + 50, groundY + 40, 4, 2);
            if (this.world.zone === 'POISON' && Math.random() < 0.1) {
                ctx.fillRect(i + Math.random()*100, groundY + Math.random()*50, 3, 3);
            }
        }

        this.drawHero(ctx, w, h);

        // Êà¶Èóò‰∏≠„ÅÆÊïµË°®Á§∫
        if (this.battleAnim.active) {
            this.drawPixelArt(ctx, w/2 - 64, h/2 - 100, 8, C.Sprites.Monster);
            // ÁÇπÊªÖ
            if (Math.floor(Date.now() / 50) % 2 === 0) {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.fillRect(w/2 - 64, h/2 - 100, 128, 128);
            }
        }

        // UI
        if (this.state === 'TITLE') {
            this.drawWindow(ctx, w/2 - 300, h/2 - 200, 600, 400);
            this.drawText(ctx, "ÂãáËÄÖ„ÅåÂãùÊâã„Å´Ëª¢„Å∂ÂÜíÈô∫", w/2, h/2 - 100, 40, "center", "#ffff00");
            this.drawText(ctx, "‚ñ∂ „Åº„ÅÜ„Åë„Çì„Çí „ÅØ„Åò„ÇÅ„Çã", w/2, h/2, 30, "center");
            this.drawText(ctx, "„Çø„ÉÉ„Éó„Åó„Å¶ „Çπ„Çø„Éº„Éà", w/2, h/2 + 150, 20, "center", "#888");
            
            // „É©„É≥„Ç≠„É≥„Ç∞Ë°®Á§∫
            const rkY = h/2 + 50;
            this.drawText(ctx, "- „É©„É≥„Ç≠„É≥„Ç∞ -", w/2, rkY, 20, "center", "#aaa");
            if (this.data.ranking.length > 0) {
                this.data.ranking.forEach((r, i) => {
                    this.drawText(ctx, `${i+1}. ${r.dist}m ${r.title}`, w/2, rkY + 30 + i * 25, 18, "center");
                });
            } else {
                this.drawText(ctx, "Ë®òÈå≤„Å™„Åó", w/2, rkY + 40, 18, "center", "#555");
            }

        } else if (this.state === 'RUN' || this.state === 'FALLING') {
            // ‰∏äÈÉ®„Çπ„ÉÜ„Éº„Çø„Çπ
            this.drawWindow(ctx, 20, 20, w - 40, 100);
            this.drawText(ctx, `Lv${this.hero.lv} „ÇÜ„ÅÜ„Åó„ÇÉ`, 50, 55);
            const hpColor = this.hero.hp < this.hero.maxHp * 0.3 ? "#ff5555" : "#ffffff";
            this.drawText(ctx, `HP ${this.hero.hp}/${this.hero.maxHp}`, 350, 55, 24, "left", hpColor);
            this.drawText(ctx, `Ë£ÖÂÇô: ${this.hero.weapon}`, 650, 55);
            this.drawText(ctx, `${Math.floor(this.hero.dist/10)}m`, w - 200, 75, 40);

            // „É≠„Ç∞
            this.drawWindow(ctx, 20, h - 150, w - 40, 130);
            this.hero.logs.slice(0, 2).forEach((log, i) => {
                this.drawText(ctx, log, 50, h - 100 + i * 40);
            });

        } else if (this.state === 'RESULT') {
            // „É™„Ç∂„É´„ÉàË©≥Á¥∞
            this.drawWindow(ctx, w/2 - 400, 50, 800, 400);
            this.drawText(ctx, "„ÇÜ„ÅÜ„Åó„ÇÉ„ÅØ „Åó„Çì„Åß„Åó„Åæ„Å£„ÅüÔºÅ", w/2, 100, 32, "center", "#ff5555");
            
            let y = 160;
            this.drawText(ctx, `Ë®òÈå≤: ${Math.floor(this.hero.dist/10)} m`, w/2, y, 40, "center", "#ffff00"); y+=50;
            this.drawText(ctx, `Áß∞Âè∑: ${this.hero.title}`, w/2, y, 28, "center"); y+=40;
            this.drawText(ctx, `„É¨„Éô„É´: ${this.hero.lv}`, w/2, y, 28, "center"); y+=40;
            this.drawText(ctx, `Ë£ÖÂÇô: ${this.hero.weapon}`, w/2, y, 28, "center"); y+=60;
            this.drawText(ctx, `Ê≠ªÂõ†: ${this.hero.fallReason}`, w/2, y, 24, "center", "#aaa");

            // „ÅØ„ÅÑ/„ÅÑ„ÅÑ„Åà
            const wy = (h/2) + 180;
            this.drawWindow(ctx, w/2 - 250, wy - 50, 500, 150);
            this.drawText(ctx, "„ÇÇ„ÅÜ„ÅÑ„Å°„Å© „ÉÅ„É£„É¨„É≥„Ç∏ „Åó„Åæ„Åô„ÅãÔºü", w/2, wy, 28, "center");
            
            const cursorX = w/2 - 80;
            this.drawText(ctx, "„ÅØ„ÅÑ", w/2, wy + 50, 30, "center");
            this.drawText(ctx, "„ÅÑ„ÅÑ„Åà", w/2, wy + 100, 30, "center");

            const cy = this.resultCursor === 0 ? wy + 50 : wy + 100;
            this.drawText(ctx, "‚ñ∂", cursorX, cy, 30, "right");
        }

        if (this.flash > 0) {
            ctx.fillStyle = `rgba(255, 255, 255, ${this.flash})`;
            ctx.fillRect(0, 0, w, h);
        }
    }

    drawWindow(ctx, x, y, w, h) {
        ctx.fillStyle = '#000000';
        ctx.fillRect(x, y, w, h);
        ctx.strokeStyle = '#FFFFFF';
        ctx.lineWidth = 4;
        ctx.strokeRect(x + 2, y + 2, w - 4, h - 4);
        ctx.strokeStyle = '#FFFFFF';
        ctx.lineWidth = 2;
        ctx.strokeRect(x + 8, y + 8, w - 16, h - 16);
        ctx.fillStyle = '#000';
        ctx.fillRect(x, y, 8, 8); ctx.fillRect(x+w-8, y, 8, 8);
        ctx.fillRect(x, y+h-8, 8, 8); ctx.fillRect(x+w-8, y+h-8, 8, 8);
        ctx.fillStyle = '#fff';
        ctx.fillRect(x+4, y+4, 4, 4); ctx.fillRect(x+w-8, y+4, 4, 4);
        ctx.fillRect(x+4, y+h-8, 4, 4); ctx.fillRect(x+w-8, y+h-8, 4, 4);
    }

    drawText(ctx, text, x, y, size=24, align="left", color="#ffffff") {
        ctx.font = `${size}px "Courier New", monospace`;
        ctx.textAlign = align;
        ctx.fillStyle = color;
        ctx.shadowColor = "#000";
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;
        ctx.fillText(text, x, y);
        ctx.shadowColor = "transparent";
    }

    drawHero(ctx, w, h) {
        const cx = 300;
        let cy = h * 0.7 - 50;
        
        if (this.state === 'FALLING') {
            // ÊºîÂá∫ÈÄ≤Ë°åÂ∫¶ (0.0 -> 1.0)
            const p = 1.0 - (this.timer / C.Game.FALL_SHOW_SEC);
            
            if (p < 0.3) {
                // 1. Ëª¢ÂÄíÔºÜ„Éê„Ç¶„É≥„Éâ
                cy += Math.sin(p * 10 * Math.PI) * -30 + (p * 100);
                ctx.save();
                ctx.translate(cx, cy);
                ctx.rotate(p * 20); 
                this.drawPixelArt(ctx, -32, -32, 4, C.Sprites.Hero);
                ctx.restore();
            } else {
                // 2. Ê£∫Ê°∂Âá∫Áèæ ÔºÜ È≠ÇÊòáÂ§©
                this.drawPixelArt(ctx, cx - 32, cy + 20, 4, C.Sprites.Coffin); // Ê£∫Ê°∂
                
                // È≠Ç („ÇÜ„Çâ„ÇÜ„ÇâÊòá„Çã)
                const soulY = cy - ((p - 0.3) * 200);
                const soulX = cx + Math.sin(Date.now() / 200) * 10;
                ctx.globalAlpha = 0.7;
                this.drawPixelArt(ctx, soulX - 32, soulY - 32, 4, C.Sprites.Soul);
                ctx.globalAlpha = 1.0;
            }
            return;
        }

        const bounce = Math.sin(this.hero.dist * 0.2) * 5;
        cy += bounce;
        this.drawPixelArt(ctx, cx - 32, cy - 32, 4, C.Sprites.Hero);
    }

    drawPixelArt(ctx, x, y, scale, sprite) {
        for (let r = 0; r < 16; r++) {
            for (let c = 0; c < 16; c++) {
                const colorIdx = sprite[r][c];
                if (colorIdx !== 0) {
                    ctx.fillStyle = C.Colors.PALETTE[colorIdx];
                    ctx.fillRect(x + c * scale, y + r * scale, scale, scale);
                }
            }
        }
    }

    loop(timestamp) {
        const dt = (timestamp - this.lastTime) / 1000;
        this.lastTime = timestamp;
        this.update(dt);
        this.draw();
        requestAnimationFrame(this.loop);
    }
}

if (document.readyState === 'complete') new Game();
else window.addEventListener('load', () => new Game());

})();
</script>
</body>
</html>
